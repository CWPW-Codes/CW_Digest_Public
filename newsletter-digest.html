<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CW Digest — Weekly Inbox</title>
<script>
  // Pre-init: set Order Paper initial state before first paint to avoid "flash" on refresh.
  (function() {
    var key = 'cw-digest-todo-panel-open';
    var open = false;
    try {
      open = (localStorage.getItem(key) || 'false') === 'true';
    } catch (_error) {
      open = false;
    }
    document.documentElement.classList.add(open ? 'todo-panel-init-open' : 'todo-panel-init-closed');
  })();
</script>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=Libre+Baskerville:ital@1&family=Yesteryear&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a1a;
    --paper: #f5f2ed;
    --rule: #d4cfc7;
    --accent: #c0392b;
    --accent-soft: #e8d5d0;
    --muted: #8a8278;
    --card: #fffcf7;
    --sidebar-bg: #eae6df;
    --sidebar-active: #1a1a1a;
    --tag-politico: #cd171e;
    --tag-substack: #ff6719;
    --tag-stephen: #2c4b8c;
    --tag-newsletter: #6b7280;
    --tag-alert: #e67e22;
    --shadow: 0 1px 3px rgba(0,0,0,0.06);
    --summary-ink: #3a3a3a;
    --mark-bg: #ffe59c;
  }

  [data-theme="dark"] {
    --ink: #ece8e2;
    --paper: #0e1117;
    --rule: #2a2e3a;
    --accent: #ff7b6b;
    --accent-soft: #2e2030;
    --muted: #a79f95;
    --card: #151821;
    --sidebar-bg: #111420;
    --sidebar-active: #f6f1ea;
    --shadow: 0 4px 12px rgba(0,0,0,0.35);
    --summary-ink: #d5d0c8;
    --mark-bg: #6c4f1b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

	  body {
	    font-family: 'DM Sans', sans-serif;
	    background: var(--paper);
	    color: var(--ink);
	    display: flex;
	    min-height: 100vh;
	    -webkit-font-smoothing: antialiased;
	    position: relative;
	  }

  body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    opacity: 0.08;
    background-image:
      radial-gradient(circle at 12% 20%, rgba(0, 0, 0, 0.12) 0.6px, transparent 0.8px),
      radial-gradient(circle at 78% 42%, rgba(0, 0, 0, 0.08) 0.8px, transparent 1px),
      radial-gradient(circle at 56% 78%, rgba(0, 0, 0, 0.08) 0.7px, transparent 0.9px);
    background-size: 140px 140px, 180px 180px, 220px 220px;
  }

  [data-theme="dark"] body::before {
    opacity: 0.16;
  }

  .progress-wrap {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: transparent;
    z-index: 90;
  }

  .progress-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #f39c89);
    transition: width 0.12s linear;
  }

	  .face-widget {
	    position: fixed;
	    top: 14px;
	    right: 14px;
	    width: 74px;
	    height: 74px;
	    border-radius: 999px;
	    z-index: 70;
	    box-sizing: border-box;
	    padding: 3px;
	    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
	    border: 0;
	    background: conic-gradient(
	      from 180deg,
	      color-mix(in srgb, var(--accent) 92%, #ffb86a),
	      color-mix(in srgb, var(--accent) 70%, #f39c89),
	      color-mix(in srgb, var(--accent) 92%, #ffb86a)
	    );
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    overflow: hidden;
	    transform-origin: center;
	    cursor: pointer;
	    isolation: isolate;
	  }

	  .face-widget::after {
	    content: '';
	    position: absolute;
	    inset: 3px;
	    border-radius: inherit;
	    pointer-events: none;
	    opacity: 0.55;
	    background: radial-gradient(circle at 28% 24%, rgba(255,255,255,0.45), transparent 60%);
	    mix-blend-mode: overlay;
	    z-index: 2;
	  }

	  .face-widget.face-spinning {
	    animation: spinFace 12s linear infinite;
	  }

  .face-widget.face-spinning:hover {
    animation-play-state: paused;
  }

	  .face-widget.face-overdrive {
	    animation: spinFace 2.2s linear infinite;
	    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.24), 0 0 18px rgba(192, 57, 43, 0.22);
	  }

	  .face-widget img {
	    width: 100%;
	    height: 100%;
	    object-fit: cover;
	    display: block;
	    border-radius: inherit;
	    filter: saturate(1.12) contrast(1.05);
	    transition: transform 140ms ease, filter 140ms ease;
	    z-index: 1;
	  }

	  .face-widget:hover img {
	    transform: scale(1.03);
	    filter: saturate(1.2) contrast(1.06);
	  }

	  .face-widget .face-fallback {
	    width: 100%;
	    height: 100%;
	    display: none;
	    align-items: center;
	    justify-content: center;
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 17px;
	    font-weight: 600;
	    letter-spacing: 0.08em;
	    color: var(--accent);
	    border-radius: inherit;
	    background: linear-gradient(145deg, var(--card), var(--sidebar-bg));
	    z-index: 1;
	  }

  .face-widget.fallback .face-fallback {
    display: flex;
  }

  .face-widget.fallback img {
    display: none;
  }

  @keyframes spinFace {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes neonFlickerGentle {
    0%, 14%, 24%, 32%, 46%, 58%, 72%, 86%, 100% {
      opacity: 1;
      text-shadow:
        0 0 2px rgba(255, 110, 168, 0.65),
        0 0 7px rgba(255, 110, 168, 0.45),
        0 0 14px rgba(255, 110, 168, 0.28),
        0 0 22px rgba(255, 184, 120, 0.18);
    }
    18% {
      opacity: 0.88;
      text-shadow:
        0 0 2px rgba(255, 110, 168, 0.52),
        0 0 5px rgba(255, 110, 168, 0.32),
        0 0 10px rgba(255, 184, 120, 0.14);
    }
    49% {
      opacity: 0.92;
      text-shadow:
        0 0 2px rgba(255, 110, 168, 0.56),
        0 0 6px rgba(255, 110, 168, 0.37),
        0 0 11px rgba(255, 184, 120, 0.15);
    }
    74% {
      opacity: 0.9;
      text-shadow:
        0 0 2px rgba(255, 110, 168, 0.54),
        0 0 5px rgba(255, 110, 168, 0.35),
        0 0 10px rgba(255, 184, 120, 0.15);
    }
  }

  /* SIDEBAR — day tabs */
  .sidebar {
    width: 220px;
    min-height: 100vh;
    background: var(--sidebar-bg);
    border-right: 1px solid var(--rule);
    padding: 32px 0;
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    z-index: 10;
  }

  .sidebar-header {
    padding: 0 24px 12px;
    border-bottom: 1px solid var(--rule);
    margin-bottom: 0;
  }

  .sidebar-header .brand-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    flex-wrap: wrap;
  }

  .sidebar-header h1 {
    font-family: 'Instrument Serif', serif;
    font-size: 22px;
    font-weight: 400;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }

  .sidebar-header h1 span {
    color: var(--accent);
    font-style: italic;
  }

  .sidebar-header .after-dark-sign {
    display: inline-flex;
    align-items: center;
    padding: 3px 9px 2px;
    border-radius: 999px;
    border: 1px solid transparent;
    pointer-events: none;
    user-select: none;
    white-space: nowrap;
    font-family: 'Yesteryear', 'Instrument Serif', serif;
    font-style: normal;
    font-size: 16px;
    font-weight: 400;
    line-height: 1;
    letter-spacing: 0.01em;
    text-transform: none;
    opacity: 0;
    transform: translateY(1px) rotate(-2deg) scale(0.98);
    color: transparent;
    background: transparent;
    text-shadow: none;
    transition: opacity 240ms ease, transform 240ms ease;
  }

  [data-theme="dark"] .sidebar-header .after-dark-sign {
    opacity: 1;
    transform: translateY(0) rotate(-2deg) scale(1);
    color: #ff6ea8;
    border-color: color-mix(in srgb, #ff6ea8 28%, var(--rule));
    background: linear-gradient(
      180deg,
      color-mix(in srgb, #2a1428 82%, transparent),
      color-mix(in srgb, #160b14 84%, transparent)
    );
    text-shadow:
      0 0 2px rgba(255, 110, 168, 0.65),
      0 0 7px rgba(255, 110, 168, 0.45),
      0 0 14px rgba(255, 110, 168, 0.28),
      0 0 22px rgba(255, 184, 120, 0.18);
    box-shadow:
      inset 0 0 8px rgba(255, 110, 168, 0.12),
      0 0 12px rgba(255, 110, 168, 0.12);
    animation: neonFlickerGentle 8.6s ease-in-out infinite;
  }

  .sidebar-header .week-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-top: 6px;
  }

  .sidebar-header .weather-line {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    margin-top: 2px;
  }

  .sidebar-header .moe-wink {
    display: none;
    margin-top: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    color: var(--muted);
    pointer-events: none;
  }

  body.pollster-mode .sidebar-header .moe-wink {
    display: block;
    opacity: 0.78;
  }

  /* — Quick links (folder pills + dropdown) — */
  .quick-links {
    padding: 8px 24px;
    border-bottom: 1px solid var(--rule);
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    position: relative;
  }

	  .quick-folder {
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 9px;
	    letter-spacing: 0.06em;
	    text-transform: uppercase;
	    color: var(--muted);
	    border: 1px solid var(--rule);
	    border-radius: 10px;
	    padding: 3px 8px;
	    cursor: pointer;
	    transition: color 0.15s, border-color 0.15s, background 0.15s, box-shadow 0.15s, transform 0.15s;
	    background: transparent;
	    position: relative;
	  }

	  .quick-folder:hover,
	  .quick-folder.open {
	    color: var(--accent);
	    border-color: var(--accent);
	    background: color-mix(in srgb, var(--accent-soft) 35%, transparent);
	    box-shadow: 0 10px 22px rgba(0,0,0,0.10);
	    transform: translateY(-1px);
	  }

  .quick-dropdown {
    position: absolute;
    left: 0;
    top: calc(100% + 4px);
    background: var(--card);
    border: 1px solid var(--rule);
    border-radius: 6px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    min-width: 180px;
    max-width: 220px;
    z-index: 50;
    padding: 6px 0;
    opacity: 0;
    transform: translateY(-4px);
    transition: opacity 0.15s, transform 0.15s;
    pointer-events: none;
  }

  .quick-dropdown.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .quick-dropdown a {
    display: block;
    padding: 5px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: var(--ink);
    text-decoration: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background 0.1s;
  }

  .quick-dropdown a:hover {
    background: var(--accent-soft);
    color: var(--accent);
  }

  /* — Order Paper: right-side to-do panel — */
			  .todo-panel {
			    position: fixed;
			    top: 0;
			    right: 0;
			    bottom: 0;
			    width: 280px;
			    background: var(--sidebar-bg);
			    border-left: 1px solid var(--rule);
			    /* Softer body text on the slightly darker sidebar background */
			    --order-ink: color-mix(in srgb, var(--summary-ink) 80%, var(--muted));
			    --order-ink-strong: color-mix(in srgb, var(--summary-ink) 92%, var(--muted));
			    z-index: 10;
			    display: flex;
			    flex-direction: column;
			    overflow: hidden;
			    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			    box-shadow: -10px 0 28px rgba(0,0,0,0.08);
			  }

	  [data-theme="dark"] .todo-panel {
	    box-shadow: -12px 0 34px rgba(0,0,0,0.35);
	  }

	  .todo-panel.collapsed {
	    transform: translateX(280px);
	  }

  .todo-panel-header {
    padding: 100px 16px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid var(--rule);
    flex-shrink: 0;
    position: relative;
  }

						  .todo-panel-title {
						    font-family: 'JetBrains Mono', monospace;
						    font-size: 11px;
						    text-transform: uppercase;
						    letter-spacing: 0.08em; /* Match the weather line */
						    color: var(--muted);
						    flex: 1;
						    font-weight: 400;
					    font-style: normal;
					  }

	  .todo-panel-count {
	    background: var(--ink);
	    color: var(--paper);
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 9px;
	    font-weight: 600;
	    padding: 2px 7px;
	    border-radius: 9px;
	    min-width: 18px;
	    text-align: center;
	    letter-spacing: 0.02em;
	  }

	  /* — Commons Theme (optional green & gold header) — */
	  /* Note: keep the panel's left divider consistent across themes (no themed stripe). */

	  .todo-panel.commons-theme .todo-panel-header {
	    border-bottom: 2px solid #c9a84c;
	    background:
      radial-gradient(circle at 20% 50%, rgba(0,0,0,0.06) 1px, transparent 1px),
      radial-gradient(circle at 60% 20%, rgba(0,0,0,0.04) 1px, transparent 1px),
      radial-gradient(circle at 80% 70%, rgba(0,0,0,0.05) 1px, transparent 1px),
      linear-gradient(180deg, #005a35 0%, #006b3f 40%, #007a47 100%);
    background-size: 8px 8px, 12px 12px, 10px 10px, 100% 100%;
  }

  .todo-panel.commons-theme .todo-panel-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, #c9a84c 20%, #ddb85e 50%, #c9a84c 80%, transparent);
  }

  [data-theme="dark"] .todo-panel.commons-theme .todo-panel-header {
    background:
      radial-gradient(circle at 20% 50%, rgba(0,0,0,0.08) 1px, transparent 1px),
      radial-gradient(circle at 60% 20%, rgba(0,0,0,0.06) 1px, transparent 1px),
      radial-gradient(circle at 80% 70%, rgba(0,0,0,0.07) 1px, transparent 1px),
      linear-gradient(180deg, #003d24 0%, #004d2e 40%, #005a35 100%);
    background-size: 8px 8px, 12px 12px, 10px 10px, 100% 100%;
    border-bottom-color: #b8963e;
  }

  .todo-panel.commons-theme .todo-panel-title {
    color: #f0e6c8;
    font-family: 'Instrument Serif', serif;
    font-size: 16px;
    font-style: italic;
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0.01em;
  }

  [data-theme="dark"] .todo-panel.commons-theme .todo-panel-title {
    color: #e8dbb8;
  }

	  .todo-panel.commons-theme .todo-panel-count {
	    background: #c9a84c;
	    color: #fff;
	  }

	  [data-theme="dark"] .todo-panel.commons-theme .todo-panel-count {
	    background: #b8963e;
	    color: #fff;
	  }

	  /* ── Labour theme ── */
	  .todo-panel.labour-theme .todo-panel-header {
	    border-bottom: 2px solid rgba(255,255,255,0.25);
	    background:
      radial-gradient(circle at 15% 40%, rgba(0,0,0,0.04) 1px, transparent 1px),
      radial-gradient(circle at 55% 75%, rgba(0,0,0,0.03) 1px, transparent 1px),
      radial-gradient(circle at 85% 30%, rgba(0,0,0,0.04) 1px, transparent 1px),
      linear-gradient(180deg, #c0032f 0%, #E4003B 40%, #ef1145 100%);
    background-size: 7px 7px, 11px 11px, 9px 9px, 100% 100%;
  }

  .todo-panel.labour-theme .todo-panel-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6) 20%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0.6) 80%, transparent);
  }

  [data-theme="dark"] .todo-panel.labour-theme .todo-panel-header {
    background:
      radial-gradient(circle at 15% 40%, rgba(0,0,0,0.06) 1px, transparent 1px),
      radial-gradient(circle at 55% 75%, rgba(0,0,0,0.05) 1px, transparent 1px),
      radial-gradient(circle at 85% 30%, rgba(0,0,0,0.06) 1px, transparent 1px),
      linear-gradient(180deg, #8b0220 0%, #a50230 40%, #c0032f 100%);
    background-size: 7px 7px, 11px 11px, 9px 9px, 100% 100%;
    border-bottom-color: rgba(255,255,255,0.15);
  }

  .todo-panel.labour-theme .todo-panel-title {
    color: #fff;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-style: normal;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    text-shadow: 0 1px 2px rgba(0,0,0,0.15);
  }

  [data-theme="dark"] .todo-panel.labour-theme .todo-panel-title {
    color: #fdd;
  }

  .todo-panel.labour-theme .todo-panel-count {
    background: #fff;
    color: #E4003B;
  }

  [data-theme="dark"] .todo-panel.labour-theme .todo-panel-count {
    background: rgba(255,255,255,0.9);
    color: #a50230;
  }


		  .todo-panel-collapse {
		    background: transparent;
		    border: 1px solid transparent;
		    box-sizing: border-box;
		    width: 26px;
		    height: 26px;
		    border-radius: 6px;
		    font-size: 12px;
		    color: var(--muted);
		    cursor: pointer;
		    padding: 0;
		    line-height: 1;
		    transition: color 0.15s, background 0.15s, border-color 0.15s;
		    display: inline-flex;
		    align-items: center;
		    justify-content: center;
		    opacity: 0.6;
		  }

		  .todo-panel-collapse:hover {
		    color: var(--ink);
		    background: color-mix(in srgb, var(--card) 70%, transparent);
		    border-color: var(--rule);
		    opacity: 1;
		  }

		  .todo-panel-collapse:focus-visible {
		    outline: none;
		    box-shadow: 0 0 0 2px color-mix(in srgb, #006b3f 20%, transparent);
		  }

		  .todo-panel-theme-btn {
		    background: transparent;
		    border: 1px solid transparent;
		    box-sizing: border-box;
		    width: 26px;
		    height: 26px;
		    border-radius: 6px;
		    font-size: 12px;
		    color: var(--muted);
		    cursor: pointer;
		    padding: 0;
		    line-height: 1;
		    transition: color 0.15s, background 0.15s, border-color 0.15s, transform 0.15s;
		    display: inline-flex;
		    align-items: center;
		    justify-content: center;
		    opacity: 0.5;
		  }

		  .todo-panel-theme-btn:hover {
		    color: #c9a84c;
		    opacity: 1;
		    transform: scale(1.1);
		  }

		  .todo-panel.commons-theme .todo-panel-theme-btn {
		    color: #c9a84c;
		    opacity: 0.9;
		  }

		  .todo-panel.commons-theme .todo-panel-theme-btn:hover {
		    opacity: 1;
		    color: #ddb85e;
		  }

		  /* Commons theme collapse button */
		  .todo-panel.commons-theme .todo-panel-collapse {
		    color: rgba(240,230,200,0.6);
		    opacity: 1;
		  }

		  .todo-panel.commons-theme .todo-panel-collapse:hover {
		    color: #f0e6c8;
		    background: rgba(255,255,255,0.1);
		    border-color: rgba(201,168,76,0.3);
		  }

		  [data-theme="dark"] .todo-panel.commons-theme .todo-panel-collapse {
		    color: rgba(232,219,184,0.5);
		  }

		  [data-theme="dark"] .todo-panel.commons-theme .todo-panel-collapse:hover {
		    color: #e8dbb8;
		    background: rgba(255,255,255,0.08);
		    border-color: rgba(184,150,62,0.3);
		  }

		  .todo-panel.commons-theme .todo-panel-collapse:focus-visible {
		    box-shadow: 0 0 0 2px rgba(201,168,76,0.3);
		  }

		  /* Labour theme button */
		  .todo-panel.labour-theme .todo-panel-theme-btn {
		    color: rgba(255,255,255,0.8);
		    opacity: 0.9;
		  }

		  .todo-panel.labour-theme .todo-panel-theme-btn:hover {
		    opacity: 1;
		    color: #fff;
		  }

		  /* Labour theme collapse button */
		  .todo-panel.labour-theme .todo-panel-collapse {
		    color: rgba(255,255,255,0.55);
		    opacity: 1;
		  }

		  .todo-panel.labour-theme .todo-panel-collapse:hover {
		    color: #fff;
		    background: rgba(255,255,255,0.12);
		    border-color: rgba(255,255,255,0.25);
		  }

		  [data-theme="dark"] .todo-panel.labour-theme .todo-panel-collapse {
		    color: rgba(255,200,200,0.5);
		  }

		  [data-theme="dark"] .todo-panel.labour-theme .todo-panel-collapse:hover {
		    color: #fdd;
		    background: rgba(255,255,255,0.08);
		    border-color: rgba(255,255,255,0.2);
		  }

		  .todo-panel.labour-theme .todo-panel-collapse:focus-visible {
		    box-shadow: 0 0 0 2px rgba(255,255,255,0.25);
		  }

	  .todo-panel-input-wrap {
	    padding: 6px 12px;
	    flex-shrink: 0;
	    border-bottom: 1px solid var(--rule);
	    background: color-mix(in srgb, var(--card) 55%, transparent);
	  }

				  .todo-panel-input {
				    width: 100%;
				    box-sizing: border-box;
				    border: 1px solid var(--rule);
				    border-radius: 6px;
				    padding: 8px 12px;
				    font-size: 13px;
				    font-family: 'DM Sans', sans-serif;
				    font-weight: 400;
				    background: var(--card);
				    color: var(--order-ink-strong);
				    outline: none;
				    transition: border-color 0.15s, box-shadow 0.15s, border-left-width 0.15s, border-radius 0.15s;
				  }

  .todo-panel-input:focus {
    border-color: #006b3f;
    box-shadow: 0 0 0 2px rgba(0,107,63,0.1);
  }

  [data-theme="dark"] .todo-panel-input:focus {
    border-color: #2ecc71;
    box-shadow: 0 0 0 2px rgba(46,204,113,0.1);
  }

  .todo-panel.commons-theme .todo-panel-input {
    border-left: 3px solid color-mix(in srgb, #006b3f 35%, transparent);
    border-radius: 2px 6px 6px 2px;
  }

  .todo-panel.commons-theme .todo-panel-input:focus {
    border-left-color: #006b3f;
  }

  [data-theme="dark"] .todo-panel.commons-theme .todo-panel-input:focus {
    border-left-color: #2ecc71;
  }

  /* Labour theme input */
  .todo-panel.labour-theme .todo-panel-input {
    border-left: 3px solid color-mix(in srgb, #E4003B 30%, transparent);
    border-radius: 2px 6px 6px 2px;
  }

  .todo-panel.labour-theme .todo-panel-input:focus {
    border-left-color: #E4003B;
  }

  [data-theme="dark"] .todo-panel.labour-theme .todo-panel-input:focus {
    border-left-color: #ef5350;
  }

  .todo-panel-input::placeholder {
    color: var(--muted);
    font-style: italic;
  }

	  .todo-panel-list {
	    flex: 1;
	    overflow-y: auto;
	    padding: 6px 0 10px;
	    scrollbar-width: thin;
	    scrollbar-color: color-mix(in srgb, var(--muted) 30%, transparent) transparent;
	  }

	  .todo-panel-list::-webkit-scrollbar {
	    width: 5px;
	  }

	  .todo-panel-list::-webkit-scrollbar-track {
	    background: transparent;
	  }

	  .todo-panel-list::-webkit-scrollbar-thumb {
	    background: color-mix(in srgb, var(--muted) 25%, transparent);
	    border-radius: 3px;
	  }

	  .todo-panel-list::-webkit-scrollbar-thumb:hover {
	    background: color-mix(in srgb, var(--muted) 45%, transparent);
	  }

					  .todo-row {
				    --todo-depth: 0;
				    --todo-accent: var(--rule);
				    display: flex;
				    align-items: flex-start;
				    gap: 6px;
				    padding: 8px 14px;
				    padding-left: calc(14px + (var(--todo-depth, 0) * 16px));
					    font-size: 12px;
					    font-family: 'DM Sans', sans-serif;
					    font-weight: 400;
					    color: var(--order-ink);
					    position: relative;
					    transition: background 0.15s ease, transform 0.1s ease;
					    line-height: 1.65;
					    border-bottom: none;
					  }

	  .todo-row[data-pri="high"] { --todo-accent: #c0392b; }
	  .todo-row[data-pri="med"] { --todo-accent: #e67e22; }
	  .todo-row[data-pri="low"] { --todo-accent: #27ae60; }
	  [data-theme="dark"] .todo-row[data-pri="high"] { --todo-accent: #ff6b6b; }
	  [data-theme="dark"] .todo-row[data-pri="med"] { --todo-accent: #f0a948; }
	  [data-theme="dark"] .todo-row[data-pri="low"] { --todo-accent: #2ecc71; }

	  .todo-row::before {
	    content: '';
	    position: absolute;
	    left: calc(8px + (var(--todo-depth, 0) * 16px));
	    top: 6px;
	    bottom: 6px;
	    width: 3px;
	    border-radius: 999px;
	    background: var(--todo-accent);
	    opacity: 0.7;
	    pointer-events: none;
	    transition: opacity 0.2s;
	  }

	  .todo-row.done::before {
	    opacity: 0.15;
	  }

	  .todo-row:hover::before {
	    opacity: 1;
	  }

	  .todo-row:hover {
	    background: color-mix(in srgb, var(--card) 60%, transparent);
	    border-radius: 4px;
	  }

  [data-theme="dark"] .todo-row:hover {
    background: rgba(255,255,255,0.04);
  }

			  .todo-row.subtask { font-size: 11px; }
			  .todo-row:focus-within { background: var(--accent-soft); }

		  .todo-row.done .todo-text {
		    opacity: 0.4;
		    text-decoration: line-through;
		    text-decoration-color: var(--muted);
		    transition: opacity 0.2s;
		  }

  .todo-row.dragging {
    opacity: 0.3;
    transform: scale(0.98);
  }

	  .todo-row.drag-over::after {
	    content: '';
	    position: absolute;
	    bottom: -1px;
	    left: calc(14px + (var(--todo-depth, 0) * 16px));
	    right: 14px;
	    height: 2px;
	    background: #006b3f;
	    border-radius: 1px;
	    box-shadow: 0 0 6px rgba(0,107,63,0.3);
	  }

	  [data-theme="dark"] .todo-row.drag-over::after {
	    background: #2ecc71;
	    box-shadow: 0 0 6px rgba(46,204,113,0.3);
	  }

		  .todo-drag {
		    width: 16px;
		    height: 18px;
		    display: inline-flex;
		    align-items: center;
		    justify-content: center;
		    border-radius: 4px;
		    font-family: 'JetBrains Mono', monospace;
		    font-size: 10px;
		    color: var(--muted);
		    cursor: grab;
		    opacity: 0;
		    flex-shrink: 0;
		    user-select: none;
		    line-height: 1;
		    margin-top: calc((1.65em - 18px) / 2);
		    transition: background 0.15s, opacity 0.2s;
		  }

  .todo-drag:active {
    cursor: grabbing;
  }

	  .todo-row:hover .todo-drag {
	    opacity: 0.5;
	  }

	  .todo-row:hover .todo-drag:hover {
	    opacity: 0.9;
	    background: color-mix(in srgb, var(--card) 70%, transparent);
	  }

	  .todo-check {
	    width: 14px;
	    height: 14px;
	    border: 1.5px solid var(--rule);
	    border-radius: 3px;
	    cursor: pointer;
	    appearance: none;
	    -webkit-appearance: none;
	    flex-shrink: 0;
	    position: relative;
	    background: transparent;
	    margin-top: calc((1.65em - 14px) / 2);
	    transition: background 0.15s, border-color 0.15s, box-shadow 0.15s, transform 0.1s;
	  }

  .todo-check:hover {
    border-color: #006b3f;
    transform: scale(1.1);
  }

  [data-theme="dark"] .todo-check:hover {
    border-color: #2ecc71;
  }

	  .todo-check:checked {
	    background: #006b3f;
	    border-color: #006b3f;
	    box-shadow: 0 1px 4px rgba(0,107,63,0.3);
	  }

  .todo-check:checked::after {
    content: '';
    position: absolute;
    left: 3.5px;
    top: 0.5px;
    width: 4px;
    height: 7px;
    border: solid #fff;
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg);
  }

  [data-theme="dark"] .todo-check:checked {
    background: #2ecc71;
    border-color: #2ecc71;
    box-shadow: 0 1px 4px rgba(46,204,113,0.25);
  }

  [data-theme="dark"] .todo-check:checked::after {
    border-color: #111;
  }

		  .todo-priority {
		    width: 8px;
		    height: 8px;
		    border-radius: 50%;
		    flex-shrink: 0;
		    cursor: pointer;
		    transition: transform 0.1s;
		    border: none;
		    padding: 0;
		    margin-top: calc((1.65em - 8px) / 2);
		    box-shadow: 0 0 0 2px color-mix(in srgb, var(--card) 70%, transparent), 0 10px 18px rgba(0,0,0,0.12);
		  }

  .todo-priority:hover {
    transform: scale(1.3);
  }

  .todo-priority[data-pri="none"] {
    background: var(--rule);
    opacity: 0;
    transition: opacity 0.15s, transform 0.1s;
  }

  .todo-row:hover .todo-priority[data-pri="none"] {
    opacity: 0.3;
  }

  .todo-priority[data-pri="high"] {
    background: #c0392b;
  }

  .todo-priority[data-pri="med"] {
    background: #e67e22;
  }

  .todo-priority[data-pri="low"] {
    background: #27ae60;
  }

  [data-theme="dark"] .todo-priority[data-pri="high"] { background: #ff6b6b; }
  [data-theme="dark"] .todo-priority[data-pri="med"] { background: #f0a948; }
  [data-theme="dark"] .todo-priority[data-pri="low"] { background: #2ecc71; }

		  .todo-text {
		    flex: 1;
		    min-width: 0;
		    white-space: pre-line;
		    overflow-wrap: break-word;
		    word-break: normal;
		  }

	  .todo-collapse,
	  .todo-collapse-spacer {
	    width: 16px;
	    flex-shrink: 0;
	    display: inline-flex;
	    align-items: center;
	    justify-content: center;
	    margin-top: calc((1.65em - 16px) / 2);
	  }

  .todo-collapse-spacer {
    visibility: hidden;
    pointer-events: none;
  }

	  .todo-actions {
	    display: flex;
	    align-items: center;
	    gap: 2px;
	    opacity: 0;
	    flex-shrink: 0;
	    transition: opacity 0.1s;
	    margin-top: 0px;
	  }

	  .todo-row:hover .todo-actions,
	  .todo-row:focus-within .todo-actions {
	    opacity: 1;
	  }

	  .todo-act-btn {
	    background: none;
	    border: none;
	    font-size: 11px;
	    color: var(--muted);
	    cursor: pointer;
	    padding: 2px 6px;
	    line-height: 1;
	    border-radius: 6px;
	    transition: background 0.12s, color 0.12s;
	  }

	  .todo-act-btn:hover {
	    color: #006b3f;
	    background: color-mix(in srgb, #006b3f 8%, transparent);
	  }

	  [data-theme="dark"] .todo-act-btn:hover {
	    color: #2ecc71;
	    background: color-mix(in srgb, #2ecc71 10%, transparent);
	  }

	  .todo-act-btn.todo-del:hover {
	    color: #c0392b;
	    background: color-mix(in srgb, #c0392b 8%, transparent);
	  }

	  [data-theme="dark"] .todo-act-btn.todo-del:hover {
	    color: #ff6b6b;
	    background: color-mix(in srgb, #ff6b6b 10%, transparent);
	  }

	  .todo-collapse {
	    opacity: 0.4;
	    font-size: 9px;
	    transition: opacity 0.15s, transform 0.15s;
	    cursor: pointer;
	  }

	  .todo-collapse:hover {
	    opacity: 0.8;
	  }

	  .todo-sub-input-row {
	    background: transparent;
	    padding-top: 4px;
	    padding-bottom: 4px;
	  }

	  .todo-sub-input-row::before {
	    display: none;
	  }

				  .todo-sub-input {
				    width: 100%;
				    flex: 1;
				    min-width: 0;
				    box-sizing: border-box;
				    border: 1px solid var(--rule);
				    border-radius: 4px;
				    padding: 5px 8px;
				    font-size: 12px;
				    font-family: 'DM Sans', sans-serif;
				    font-weight: 400;
				    background: var(--card);
				    color: var(--order-ink-strong);
				    outline: none;
				    transition: border-color 0.15s;
				  }

  .todo-sub-input:focus {
    border-color: #006b3f;
  }

  [data-theme="dark"] .todo-sub-input:focus {
    border-color: #2ecc71;
  }

  .todo-bin {
    border-top: 1px solid var(--rule);
    margin-top: auto;
    background: color-mix(in srgb, var(--card) 30%, transparent);
  }

  .todo-bin-header {
    padding: 10px 14px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    cursor: pointer;
    list-style: none;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: color 0.15s;
  }

  .todo-bin-header:hover {
    color: var(--ink);
  }

  .todo-bin-header::-webkit-details-marker { display: none; }

  .todo-bin-header::before {
    content: '\25B8';
    font-size: 8px;
    transition: transform 0.2s ease;
  }

  .todo-bin[open] > .todo-bin-header::before {
    transform: rotate(90deg);
  }

  .todo-bin-count {
    background: var(--rule);
    color: var(--muted);
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 8px;
  }

  .todo-bin-list {
    opacity: 0.45;
    transition: opacity 0.15s;
  }

  .todo-bin-list:hover {
    opacity: 0.6;
  }

  .todo-clear-done {
    display: block;
    width: calc(100% - 28px);
    margin: 6px 14px 10px;
    padding: 7px;
    background: none;
    border: 1px dashed var(--rule);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
  }

  .todo-clear-done:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 5%, transparent);
  }

  .todo-empty {
    padding: 32px 20px;
    text-align: center;
    color: var(--muted);
    font-size: 11px;
    line-height: 1.5;
    opacity: 0.7;
  }

  .todo-empty-icon {
    font-size: 24px;
    display: block;
    margin-bottom: 8px;
    opacity: 0.4;
  }

  /* — Notes toggle button (per row) — */
  .todo-notes-toggle {
    width: 18px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: none;
    border-radius: 4px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    flex-shrink: 0;
    opacity: 0;
    padding: 0;
    transition: opacity 0.15s, color 0.15s, background 0.15s;
  }

  .todo-row:hover .todo-notes-toggle { opacity: 0.5; }

  .todo-row:hover .todo-notes-toggle:hover {
    opacity: 1;
    color: var(--ink);
    background: color-mix(in srgb, var(--ink) 8%, transparent);
  }

  .todo-notes-toggle.has-notes {
    opacity: 0.7;
    color: var(--accent);
  }

  .todo-row:hover .todo-notes-toggle.has-notes { opacity: 1; }

  /* — Notes popup overlay — */
  .todo-notes-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.25);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: todoNotesFadeIn 0.15s ease;
  }

  [data-theme="dark"] .todo-notes-overlay {
    background: rgba(0,0,0,0.5);
  }

  @keyframes todoNotesFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .todo-notes-popup {
    background: var(--card);
    border: 1px solid var(--rule);
    border-radius: 10px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08);
    width: 480px;
    max-width: calc(100vw - 32px);
    max-height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: todoNotesPopIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  [data-theme="dark"] .todo-notes-popup {
    box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.2);
  }

  @keyframes todoNotesPopIn {
    from { opacity: 0; transform: scale(0.95) translateY(8px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .todo-notes-popup-header {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 14px 16px 10px;
    border-bottom: 1px solid var(--rule);
  }

  .todo-notes-popup-title {
    flex: 1;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--ink);
    line-height: 1.4;
    word-break: break-word;
  }

  .todo-notes-popup-close {
    background: none;
    border: none;
    font-size: 16px;
    color: var(--muted);
    cursor: pointer;
    padding: 0;
    line-height: 1;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: color 0.12s, background 0.12s;
  }

  .todo-notes-popup-close:hover {
    color: var(--ink);
    background: color-mix(in srgb, var(--ink) 8%, transparent);
  }

  .todo-notes-popup-body {
    padding: 12px 16px 16px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .todo-notes-textarea {
    width: 100%;
    box-sizing: border-box;
    border: 1px solid var(--rule);
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    background: var(--paper);
    color: var(--ink);
    outline: none;
    resize: vertical;
    min-height: 180px;
    max-height: 400px;
    overflow-y: auto;
    line-height: 1.6;
    transition: border-color 0.15s, box-shadow 0.15s;
    scrollbar-width: thin;
    scrollbar-color: color-mix(in srgb, var(--muted) 30%, transparent) transparent;
  }

  .todo-notes-textarea:focus {
    border-color: var(--ink);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--ink) 10%, transparent);
  }

  .todo-notes-textarea::placeholder {
    color: var(--muted);
    font-style: italic;
  }

  .todo-notes-toolbar {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 6px 16px;
    border-bottom: 1px solid var(--rule);
    background: color-mix(in srgb, var(--paper) 60%, var(--card));
  }

  .todo-notes-fmt {
    background: none;
    border: 1px solid transparent;
    border-radius: 4px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    padding: 3px 7px;
    line-height: 1;
    transition: color 0.12s, background 0.12s, border-color 0.12s;
  }

  .todo-notes-fmt:hover {
    color: var(--ink);
    background: color-mix(in srgb, var(--ink) 6%, transparent);
    border-color: var(--rule);
  }

  .todo-notes-toolbar-spacer {
    flex: 1;
  }

  .todo-notes-copy-btn {
    background: none;
    border: 1px solid var(--rule);
    border-radius: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    padding: 3px 8px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    transition: color 0.12s, background 0.12s;
  }

  .todo-notes-copy-btn:hover {
    color: var(--ink);
    background: color-mix(in srgb, var(--ink) 6%, transparent);
  }

  .todo-notes-check-wrap {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    cursor: pointer;
  }

  .todo-notes-done-check {
    width: 15px;
    height: 15px;
    cursor: pointer;
    accent-color: var(--ink);
  }

  .todo-notes-popup-title.done {
    text-decoration: line-through;
    opacity: 0.5;
  }

  .todo-notes-pri-btn {
    background: none;
    border: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
    transition: background 0.12s;
  }

  .todo-notes-pri-btn:hover {
    background: color-mix(in srgb, var(--ink) 8%, transparent);
  }

  .todo-notes-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 8px;
  }

  .todo-notes-wc {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    opacity: 0.6;
  }

  .todo-notes-hint {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    opacity: 0.6;
  }

  /* — Export button in header — */
  .todo-export-btn {
    background: transparent;
    border: 1px solid transparent;
    box-sizing: border-box;
    height: 26px;
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--muted);
    cursor: pointer;
    padding: 0 7px;
    line-height: 1;
    transition: color 0.15s, background 0.15s, border-color 0.15s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    opacity: 0.5;
  }

  .todo-export-btn:hover {
    opacity: 1;
    color: var(--ink);
    background: color-mix(in srgb, var(--card) 70%, transparent);
    border-color: var(--rule);
  }

  .todo-panel.commons-theme .todo-export-btn {
    color: rgba(240,230,200,0.6);
    opacity: 1;
  }
  .todo-panel.commons-theme .todo-export-btn:hover {
    color: #f0e6c8;
    background: rgba(255,255,255,0.1);
    border-color: rgba(201,168,76,0.3);
  }
  .todo-panel.labour-theme .todo-export-btn {
    color: rgba(255,255,255,0.55);
    opacity: 1;
  }
  .todo-panel.labour-theme .todo-export-btn:hover {
    color: #fff;
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.25);
  }

  /* — Inline edit input — */
  .todo-edit-input {
    flex: 1;
    min-width: 0;
    border: 1px solid var(--rule);
    border-radius: 3px;
    padding: 1px 4px;
    font-size: inherit;
    font-family: 'DM Sans', sans-serif;
    background: var(--card);
    color: var(--ink);
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .todo-edit-input:focus {
    border-color: var(--ink);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--ink) 10%, transparent);
  }

  /* — Undo delete toast — */
  .todo-undo-toast {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    background: var(--ink);
    color: var(--paper);
    border-radius: 6px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    animation: todoUndoIn 0.2s ease;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .todo-undo-btn {
    background: none;
    border: 1px solid color-mix(in srgb, var(--paper) 30%, transparent);
    color: var(--paper);
    border-radius: 4px;
    padding: 3px 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: background 0.15s;
    flex-shrink: 0;
    margin-left: 12px;
  }
  .todo-undo-btn:hover {
    background: color-mix(in srgb, var(--paper) 15%, transparent);
  }
  @keyframes todoUndoIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* — Search / filter — */
  .todo-search-btn {
    width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: none;
    border-radius: 4px;
    font-size: 13px;
    color: var(--muted);
    cursor: pointer;
    transition: color 0.15s, background 0.15s;
    opacity: 0.5;
  }
  .todo-search-btn:hover {
    opacity: 1;
    color: var(--ink);
    background: color-mix(in srgb, var(--ink) 8%, transparent);
  }
  .todo-search-btn.active {
    opacity: 1;
    color: var(--ink);
  }
  .todo-panel.commons-theme .todo-search-btn {
    color: rgba(240,230,200,0.6);
    opacity: 1;
  }
  .todo-panel.commons-theme .todo-search-btn:hover,
  .todo-panel.commons-theme .todo-search-btn.active {
    color: #f0e6c8;
    background: rgba(255,255,255,0.1);
  }
  .todo-panel.labour-theme .todo-search-btn {
    color: rgba(255,255,255,0.55);
    opacity: 1;
  }
  .todo-panel.labour-theme .todo-search-btn:hover,
  .todo-panel.labour-theme .todo-search-btn.active {
    color: #fff;
    background: rgba(255,255,255,0.12);
  }
  .todo-filter-row {
    padding: 0 10px 6px;
    animation: todoNotesFadeIn 0.15s ease;
  }
  .todo-filter-input {
    width: 100%;
    box-sizing: border-box;
    border: 1px solid var(--rule);
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 11px;
    font-family: 'DM Sans', sans-serif;
    background: var(--card);
    color: var(--ink);
    outline: none;
    transition: border-color 0.15s;
  }
  .todo-filter-input:focus {
    border-color: var(--ink);
  }
  .todo-filter-input::placeholder {
    color: var(--muted);
    font-style: italic;
  }
  .todo-text mark {
    background: color-mix(in srgb, var(--accent) 25%, transparent);
    color: inherit;
    border-radius: 2px;
    padding: 0 1px;
  }

  .todo-toggle-tab {
    display: none;
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    writing-mode: vertical-rl;
    background: var(--sidebar-bg);
    border: 1px solid var(--rule);
    border-right: none;
    border-radius: 6px 0 0 6px;
    padding: 14px 7px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    cursor: pointer;
    z-index: 11;
    transition: color 0.2s, background 0.2s, box-shadow 0.2s;
    box-shadow: -2px 0 8px rgba(0,0,0,0.06);
  }

  .todo-toggle-tab:hover {
    color: #006b3f;
    background: color-mix(in srgb, #006b3f 6%, var(--sidebar-bg));
    box-shadow: -3px 0 12px rgba(0,0,0,0.1);
  }

  [data-theme="dark"] .todo-toggle-tab:hover {
    color: #2ecc71;
    background: color-mix(in srgb, #2ecc71 8%, var(--sidebar-bg));
  }

  /* Commons theme toggle tab */
  .todo-panel.commons-theme ~ .todo-toggle-tab {
    background: #006b3f;
    border-color: #c9a84c;
    color: #f0e6c8;
    box-shadow: -2px 0 8px rgba(0,0,0,0.12);
  }

  .todo-panel.commons-theme ~ .todo-toggle-tab:hover {
    background: #007a47;
    color: #fff;
    box-shadow: -3px 0 12px rgba(0,0,0,0.18);
  }

  [data-theme="dark"] .todo-panel.commons-theme ~ .todo-toggle-tab {
    background: #004d2e;
    border-color: #b8963e;
    color: #e8dbb8;
  }

  [data-theme="dark"] .todo-panel.commons-theme ~ .todo-toggle-tab:hover {
    background: #005a35;
    color: #fff;
  }

  /* Labour theme toggle tab */
  .todo-panel.labour-theme ~ .todo-toggle-tab {
    background: #E4003B;
    border-color: rgba(255,255,255,0.35);
    color: #fff;
    box-shadow: -2px 0 8px rgba(0,0,0,0.12);
  }

  .todo-panel.labour-theme ~ .todo-toggle-tab:hover {
    background: #ef1145;
    color: #fff;
    box-shadow: -3px 0 12px rgba(0,0,0,0.18);
  }

  [data-theme="dark"] .todo-panel.labour-theme ~ .todo-toggle-tab {
    background: #a50230;
    border-color: rgba(255,200,200,0.25);
    color: #fdd;
  }

  [data-theme="dark"] .todo-panel.labour-theme ~ .todo-toggle-tab:hover {
    background: #c0032f;
    color: #fff;
  }

  .todo-panel.collapsed + .todo-toggle-tab {
    display: block;
  }

  .day-tabs {
    list-style: none;
    flex: 1;
  }

  .day-tab {
    display: flex;
    align-items: center;
    padding: 12px 24px;
    cursor: pointer;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    position: relative;
  }

  .day-tab:hover {
    background: rgba(0,0,0,0.03);
  }

  .day-tab.active {
    background: var(--card);
    border-left-color: var(--accent);
    font-weight: 600;
  }

  .day-tab .day-name {
    font-size: 14px;
    flex: 1;
  }

  .day-tab .day-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .day-tab .count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    color: white;
    font-size: 10px;
    font-weight: 600;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    padding: 0 5px;
    margin-left: 8px;
  }

  .day-tab.empty .day-name {
    color: var(--muted);
  }

  .day-tab.empty .count-badge {
    background: var(--rule);
    color: var(--muted);
  }

  .sidebar-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--rule);
    font-size: 11px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .sidebar-footer code {
    display: block;
    margin-top: 4px;
    font-size: 10px;
    word-break: break-all;
    color: var(--accent);
  }

  /* MAIN CONTENT */
  .main {
    margin-left: 220px;
    flex: 1;
    padding: 40px 48px;
    max-width: 980px;
    position: relative;
    z-index: 1;
  }

  @media (min-width: 1200px) {
    .main { margin-right: 280px; }

    /* If Order Paper is collapsed on load (from localStorage), start fully collapsed with no flash. */
    html.todo-panel-init-closed .main { margin-right: 0; }
    html.todo-panel-init-closed .todo-panel { transform: translateX(280px); }
    html.todo-panel-init-closed .todo-toggle-tab { display: block; }
  }

  @media (max-width: 1199px) and (min-width: 769px) {
    .todo-panel { transform: translateX(280px); }
    .todo-panel.open { transform: translateX(0); }
    .todo-toggle-tab { display: block; }

    /* If Order Paper was open previously, start open with no flash. */
    html.todo-panel-init-open .todo-panel { transform: translateX(0); }
  }

  .utility-shell {
    position: sticky;
    top: 10px;
    z-index: 35;
    margin-bottom: 20px;
    backdrop-filter: blur(6px);
  }

  .utility-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    padding: 12px;
    border: 1px solid var(--rule);
    border-radius: 10px;
    background: color-mix(in srgb, var(--card) 88%, transparent);
    box-shadow: var(--shadow);
  }

  .utility-shell.search-collapsed {
    margin-bottom: 0;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }

	  .utility-shell.search-collapsed .search-wrap,
	  .utility-shell.search-collapsed #clearSearch,
	  .utility-shell.search-collapsed #refreshDigest,
	  .utility-shell.search-collapsed #refreshMeta,
	  .utility-shell.search-collapsed #themeToggle,
	  .utility-shell.search-collapsed #sortToggle,
	  .utility-shell.search-collapsed #viewToggle,
	  .utility-shell.search-collapsed #archiveSelect,
	  .utility-shell.search-collapsed .filters-meta,
	  .utility-shell.search-collapsed #muteManager,
	  .utility-shell.search-collapsed .topic-heat {
	    display: none;
	  }

  .utility-shell.search-collapsed .utility-bar {
    display: block;
    width: 0;
    height: 0;
    padding: 0;
    border: 0;
    box-shadow: none;
    background: transparent;
    overflow: visible;
  }

  .utility-btn-icon {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
  }

  #searchToggle {
    position: fixed;
    top: 37px;
    right: 96px;
    z-index: 76;
  }

  .utility-shell.search-collapsed .utility-btn-icon {
    width: 28px;
    height: 28px;
  }

  .search-wrap {
    flex: 1 1 320px;
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-wrap input {
    flex: 1;
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    border: 1px solid var(--rule);
    border-radius: 9px;
    background: var(--paper);
    color: var(--ink);
    padding: 10px 36px 10px 10px;
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .search-wrap input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
  }

  .slash-hint {
    position: absolute;
    right: 10px;
    top: 9px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    border: 1px solid var(--rule);
    border-radius: 5px;
    padding: 1px 5px;
    pointer-events: none;
    background: var(--card);
  }

  .utility-btn {
    border: 1px solid var(--rule);
    background: var(--card);
    color: var(--ink);
    border-radius: 999px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .utility-btn:hover {
    border-color: var(--accent);
    background: var(--accent-soft);
  }

	  .utility-btn:disabled {
	    opacity: 0.55;
	    cursor: wait;
	  }

	  .refresh-meta {
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 10px;
	    letter-spacing: 0.02em;
	    color: var(--muted);
	    padding: 0 2px;
	    white-space: nowrap;
	  }

	  .view-toggle {
	    display: inline-flex;
	    align-items: center;
	    border: 1px solid var(--rule);
	    border-radius: 999px;
	    overflow: hidden;
	    background: var(--card);
	  }

	  .view-toggle .view-btn {
	    border: 0;
	    background: transparent;
	    color: var(--ink);
	    padding: 8px 10px;
	    font-size: 11px;
	    font-weight: 700;
	    letter-spacing: 0.02em;
	    cursor: pointer;
	    line-height: 1;
	  }

	  .view-toggle .view-btn + .view-btn {
	    border-left: 1px solid var(--rule);
	  }

	  .view-toggle .view-btn:hover {
	    background: var(--accent-soft);
	  }

	  .view-toggle .view-btn.active {
	    background: var(--accent-soft);
	    color: var(--ink);
	  }

	  .view-toggle .view-btn:focus-visible {
	    outline: none;
	    box-shadow: inset 0 0 0 2px color-mix(in srgb, var(--accent) 35%, transparent);
	  }

	  .mute-manager {
	    width: 100%;
	    margin-top: 6px;
	    border: 1px dashed var(--rule);
	    border-radius: 12px;
	    padding: 10px 12px;
	    background: color-mix(in srgb, var(--card) 92%, transparent);
	  }

	  .mute-manager summary {
	    cursor: pointer;
	    list-style: none;
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 11px;
	    color: var(--muted);
	    letter-spacing: 0.02em;
	  }

	  .mute-manager summary::-webkit-details-marker {
	    display: none;
	  }

	  .mute-manager .mute-count {
	    font-weight: 700;
	    color: var(--ink);
	    margin-left: 6px;
	  }

	  .mute-block {
	    margin-top: 10px;
	    display: flex;
	    gap: 10px;
	    align-items: flex-start;
	    flex-wrap: wrap;
	  }

	  .mute-title {
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 10px;
	    color: var(--muted);
	    letter-spacing: 0.06em;
	    text-transform: uppercase;
	    padding-top: 4px;
	    min-width: 72px;
	  }

	  .mute-chips {
	    display: flex;
	    flex-wrap: wrap;
	    gap: 6px;
	    flex: 1;
	  }

	  .mute-chip {
	    border: 1px solid var(--rule);
	    border-radius: 999px;
	    padding: 4px 8px;
	    font-size: 11px;
	    background: var(--paper);
	    color: var(--ink);
	    cursor: pointer;
	    transition: border-color 0.15s ease, background 0.15s ease;
	    max-width: 100%;
	    overflow: hidden;
	    text-overflow: ellipsis;
	    white-space: nowrap;
	  }

	  .mute-chip:hover {
	    border-color: var(--accent);
	    background: var(--accent-soft);
	  }

	  .mute-clear {
	    margin-top: 10px;
	    border: 1px solid var(--rule);
	    background: transparent;
	    color: var(--accent);
	    border-radius: 999px;
	    padding: 6px 10px;
	    font-size: 11px;
	    font-weight: 700;
	    letter-spacing: 0.02em;
	    cursor: pointer;
	  }

	  .mute-clear:hover {
	    border-color: var(--accent);
	    background: var(--accent-soft);
	  }

	  #searchToggle.is-stale::after {
	    content: '';
	    position: absolute;
	    top: 3px;
	    right: 3px;
	    width: 8px;
	    height: 8px;
	    border-radius: 999px;
	    background: color-mix(in srgb, var(--accent) 85%, white);
	    box-shadow: 0 0 0 2px color-mix(in srgb, var(--card) 85%, transparent);
	  }

	  .egg-toast {
	    position: fixed;
	    left: 50%;
	    bottom: 18px;
	    transform: translate(-50%, 10px);
    z-index: 96;
    pointer-events: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.03em;
    color: var(--ink);
    background: color-mix(in srgb, var(--card) 92%, transparent);
    border: 1px solid var(--rule);
    border-radius: 999px;
    padding: 8px 12px;
    box-shadow: var(--shadow);
    opacity: 0;
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  .egg-toast.show {
    opacity: 1;
    transform: translate(-50%, 0);
  }

  .utility-select {
    border: 1px solid var(--rule);
    background: var(--card);
    color: var(--ink);
    border-radius: 999px;
    padding: 8px 28px 8px 12px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.02em;
    appearance: none;
    cursor: pointer;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%);
    background-position:
      calc(100% - 14px) calc(50% - 2px),
      calc(100% - 9px) calc(50% - 2px);
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
  }

  .utility-select:hover,
  .utility-select:focus {
    border-color: var(--accent);
    outline: none;
  }

  .filters-meta {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .filters-meta .pill {
    border: 1px solid var(--rule);
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    color: var(--ink);
    background: var(--paper);
  }

  .filters-meta .clear-filters {
    margin-left: auto;
    text-decoration: none;
    color: var(--accent);
    font-weight: 600;
    cursor: pointer;
    border-bottom: 1px dashed currentColor;
  }

  .topic-heat {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
    margin-bottom: 18px;
  }

	  .topic-chip {
	    border: 1px solid var(--rule);
	    border-radius: 999px;
	    padding: 5px 10px;
	    font-size: 11px;
	    line-height: 1;
	    cursor: pointer;
	    background: var(--card);
	    color: var(--ink);
	    box-shadow: 0 1px 0 rgba(255,255,255,0.55) inset, 0 6px 16px rgba(0,0,0,0.08);
	    transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
	  }

	  .topic-chip:hover {
	    border-color: var(--accent);
	    transform: translateY(-1px);
	    box-shadow: 0 1px 0 rgba(255,255,255,0.65) inset, 0 10px 22px rgba(0,0,0,0.12);
	  }

	  .topic-chip.active {
	    border-color: var(--accent);
	    background: var(--accent-soft);
	    color: var(--ink);
	    font-weight: 600;
	    box-shadow: 0 1px 0 rgba(255,255,255,0.65) inset, 0 12px 26px rgba(0,0,0,0.14);
	  }

	  [data-theme="dark"] .topic-chip {
	    box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset, 0 12px 26px rgba(0,0,0,0.42);
	  }

  .results-banner {
    margin-bottom: 22px;
    border: 1px dashed var(--rule);
    background: color-mix(in srgb, var(--card) 94%, transparent);
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 12px;
    color: var(--muted);
  }

  .results-banner strong {
    color: var(--ink);
    font-weight: 600;
  }

  .results-empty {
    border: 1px dashed var(--rule);
    border-radius: 12px;
    padding: 26px 18px;
    text-align: center;
    color: var(--muted);
    background: var(--card);
  }

  .day-content {
    display: none;
  }

  .day-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .day-header {
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--ink);
  }

  .day-header h2 {
    font-family: 'Instrument Serif', serif;
    font-size: 36px;
    font-weight: 400;
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .day-header .date-full {
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  /* NEWSLETTER CARD */
	  .newsletter-card {
	    background: var(--card);
	    border: 1px solid var(--rule);
	    border-radius: 6px;
	    padding: 24px 28px;
	    margin-bottom: 20px;
	    position: relative;
	    box-shadow: var(--shadow);
	    transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
	  }

	  .newsletter-card:hover {
	    border-color: var(--accent);
	  }

	  .newsletter-card.is-focused {
	    outline: none;
	    border-color: color-mix(in srgb, var(--accent) 55%, var(--rule));
	    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent), var(--shadow);
	  }

	  .newsletter-card.is-read {
	    opacity: 0.5;
	    transition: opacity 0.2s ease;
	  }

	  .newsletter-card.is-read:hover,
	  .newsletter-card.is-read.is-focused {
	    opacity: 0.85;
	  }

	  .newsletter-card.is-read .card-link-title {
	    color: color-mix(in srgb, var(--ink) 62%, var(--muted));
	  }

	  .newsletter-card.is-read .summary {
	    color: color-mix(in srgb, var(--summary-ink) 74%, var(--muted));
	  }

	  .read-check {
	    font-size: 11px;
	    color: var(--muted);
	    margin-left: 6px;
	  }

	  .newsletter-card.is-saved {
	    border-color: color-mix(in srgb, var(--accent) 40%, var(--rule));
	    box-shadow: 0 0 0 1px color-mix(in srgb, var(--accent) 18%, transparent), var(--shadow);
	  }

	  .card-action {
	    border: 1px solid var(--rule);
	    background: var(--card);
	    color: var(--muted);
	    border-radius: 999px;
	    width: 28px;
	    height: 28px;
	    display: inline-flex;
	    align-items: center;
	    justify-content: center;
	    cursor: pointer;
	    font-size: 14px;
	    line-height: 1;
	    padding: 0;
	    transition: opacity 0.15s ease, transform 0.15s ease, background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
	    opacity: 0;
	    transform: translateY(-1px);
	  }

	  .newsletter-card:hover .card-action,
	  .newsletter-card:focus-within .card-action {
	    opacity: 0.95;
	    transform: translateY(0);
	  }

	  .card-action:hover {
	    border-color: var(--accent);
	    background: var(--accent-soft);
	    color: var(--ink);
	  }

	  .card-action:focus-visible {
	    outline: none;
	    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 18%, transparent);
	  }

	  .card-action.card-save.is-on {
	    color: color-mix(in srgb, var(--accent) 80%, var(--ink));
	  }

	  @media (hover: none) {
	    .card-action {
	      opacity: 0.82;
	      transform: none;
	    }
	  }

	  .card-menu-pop {
	    position: fixed;
	    z-index: 120;
	    min-width: 190px;
	    max-width: min(280px, calc(100vw - 24px));
	    background: var(--card);
	    border: 1px solid var(--rule);
	    border-radius: 12px;
	    padding: 6px;
	    box-shadow: var(--shadow);
	  }

	  .card-menu-pop[hidden] {
	    display: none;
	  }

	  .card-menu-pop .menu-item {
	    width: 100%;
	    text-align: left;
	    border: 0;
	    background: transparent;
	    color: var(--ink);
	    padding: 10px 10px;
	    font-family: 'DM Sans', sans-serif;
	    font-size: 12px;
	    font-weight: 700;
	    cursor: pointer;
	    border-radius: 10px;
	  }

	  .card-menu-pop .menu-item:hover {
	    background: var(--accent-soft);
	  }

	  .card-menu-pop .menu-item:focus-visible {
	    outline: none;
	    box-shadow: inset 0 0 0 2px color-mix(in srgb, var(--accent) 30%, transparent);
	  }

	  .card-menu-pop .menu-sep {
	    height: 1px;
	    background: var(--rule);
	    margin: 6px 8px;
	  }

	  .shortcuts-overlay {
	    position: fixed;
	    inset: 0;
	    z-index: 140;
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    padding: 20px;
	    background: rgba(0, 0, 0, 0.28);
	    backdrop-filter: blur(6px);
	    -webkit-backdrop-filter: blur(6px);
	  }

	  .shortcuts-overlay[hidden] {
	    display: none;
	  }

	  .shortcuts-panel {
	    width: min(520px, 100%);
	    background: var(--card);
	    border: 1px solid var(--rule);
	    border-radius: 16px;
	    box-shadow: var(--shadow);
	    padding: 14px 14px 12px;
	  }

	  .shortcuts-head {
	    display: flex;
	    align-items: center;
	    justify-content: space-between;
	    gap: 12px;
	    margin-bottom: 10px;
	  }

	  .shortcuts-title {
	    font-family: 'JetBrains Mono', monospace;
	    letter-spacing: 0.06em;
	    text-transform: uppercase;
	    font-size: 11px;
	    color: var(--muted);
	  }

	  .shortcuts-close {
	    border: 1px solid var(--rule);
	    background: transparent;
	    border-radius: 999px;
	    width: 30px;
	    height: 30px;
	    cursor: pointer;
	    font-size: 18px;
	    line-height: 1;
	    color: var(--muted);
	  }

	  .shortcuts-close:hover {
	    border-color: var(--accent);
	    background: var(--accent-soft);
	    color: var(--ink);
	  }

	  .shortcuts-grid {
	    display: grid;
	    grid-template-columns: 1fr;
	    gap: 8px;
	  }

	  .shortcut-row {
	    display: flex;
	    align-items: center;
	    gap: 10px;
	    padding: 8px 10px;
	    border: 1px solid var(--rule);
	    border-radius: 12px;
	    background: var(--paper);
	    color: var(--ink);
	    font-size: 12px;
	  }

	  .shortcut-row .desc {
	    color: var(--muted);
	    font-weight: 600;
	  }

	  .kbd {
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 11px;
	    border: 1px solid var(--rule);
	    border-bottom-width: 2px;
	    border-radius: 8px;
	    padding: 3px 6px;
	    background: var(--card);
	    color: var(--ink);
	    white-space: nowrap;
	  }

	  /* — Command palette (Cmd/Ctrl+K) — */
	  .cmd-palette {
	    position: fixed;
	    inset: 0;
	    z-index: 160;
	    display: flex;
	    align-items: flex-start;
	    justify-content: center;
	    padding: 80px 20px 20px;
	    background: rgba(0,0,0,0.4);
	    backdrop-filter: blur(6px);
	    -webkit-backdrop-filter: blur(6px);
	  }

	  .cmd-palette[hidden] { display: none; }

	  .cmd-palette-panel {
	    background: var(--card);
	    border: 1px solid var(--rule);
	    border-radius: 10px;
	    box-shadow: 0 16px 48px rgba(0,0,0,0.2);
	    width: 90vw;
	    max-width: 520px;
	    overflow: hidden;
	  }

	  .cmd-palette-input {
	    width: 100%;
	    box-sizing: border-box;
	    border: none;
	    border-bottom: 1px solid var(--rule);
	    padding: 14px 18px;
	    font-size: 15px;
	    font-family: 'DM Sans', sans-serif;
	    background: transparent;
	    color: var(--ink);
	    outline: none;
	  }

	  .cmd-palette-input::placeholder {
	    color: var(--muted);
	  }

	  .cmd-palette-results {
	    max-height: 400px;
	    overflow-y: auto;
	    padding: 6px 0;
	  }

	  .cmd-result {
	    display: flex;
	    align-items: center;
	    gap: 10px;
	    padding: 8px 18px;
	    cursor: pointer;
	    transition: background 0.08s;
	  }

	  .cmd-result.active {
	    background: var(--accent-soft);
	  }

	  .cmd-result:hover {
	    background: var(--accent-soft);
	  }

	  .cmd-result-type {
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 8px;
	    text-transform: uppercase;
	    letter-spacing: 0.08em;
	    padding: 2px 6px;
	    border-radius: 4px;
	    flex-shrink: 0;
	    min-width: 42px;
	    text-align: center;
	  }

	  /* Type colours */
	  .cmd-result-type[data-type="action"] { background: var(--accent-soft); color: var(--accent); }
	  .cmd-result-type[data-type="link"] { background: #e8f4f8; color: #2980b9; }
	  [data-theme="dark"] .cmd-result-type[data-type="link"] { background: #1a2a3a; color: #5dade2; }
	  .cmd-result-type[data-type="article"] { background: #f0e8f5; color: #8e44ad; }
	  [data-theme="dark"] .cmd-result-type[data-type="article"] { background: #2a1a3a; color: #bb6bd9; }
	  .cmd-result-type[data-type="todo"] { background: #e8f5e9; color: #006b3f; }
	  [data-theme="dark"] .cmd-result-type[data-type="todo"] { background: #1a2e1a; color: #2ecc71; }

	  .cmd-result-label {
	    font-size: 13px;
	    color: var(--ink);
	    flex: 1;
	    min-width: 0;
	    overflow: hidden;
	    text-overflow: ellipsis;
	    white-space: nowrap;
	  }

	  .cmd-result-detail {
	    font-size: 10px;
	    color: var(--muted);
	    flex-shrink: 0;
	    max-width: 120px;
	    overflow: hidden;
	    text-overflow: ellipsis;
	    white-space: nowrap;
	  }

	  .cmd-palette-empty {
	    padding: 24px 18px;
	    text-align: center;
	    font-size: 12px;
	    color: var(--muted);
	  }

	  .cmd-palette-hint {
	    padding: 6px 18px 10px;
	    border-top: 1px solid var(--rule);
	    font-family: 'JetBrains Mono', monospace;
	    font-size: 9px;
	    color: var(--muted);
	    display: flex;
	    gap: 12px;
	  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

		  .source-tag {
		    font-size: 10px;
		    font-weight: 600;
		    text-transform: uppercase;
		    letter-spacing: 0.08em;
		    padding: 3px 8px;
		    border-radius: 3px;
		    color: white;
		  }

		  .source-tag.politico { background: var(--tag-politico); }
		  .source-tag.substack { background: var(--tag-substack); }
		  .source-tag.stephen_bush { background: var(--tag-stephen); }
		  .source-tag.newsletter { background: var(--tag-newsletter); }
		  .source-tag.alert { background: var(--tag-alert); }

  body.pollster-mode .progress-bar {
    background: linear-gradient(90deg, #c62828 0%, #f39c89 46%, #6f86df 54%, #2647b8 100%);
  }

  body.pollster-mode .source-tag {
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.35), 0 0 0 2px rgba(0, 0, 0, 0.08);
  }

  .card-meta .time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .card-meta .from {
    font-size: 12px;
    color: var(--muted);
    margin-left: auto;
  }

  .card-meta .open-link {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--accent);
    text-decoration: none;
    border: 1px solid var(--rule);
    border-radius: 999px;
    padding: 4px 10px;
    transition: all 0.2s ease;
  }

  .card-meta .open-link:hover {
    border-color: var(--accent);
    background: var(--accent-soft);
  }

  .pollster-line {
    margin: -2px 0 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.04em;
    color: var(--muted);
  }

  body.pollster-mode .pollster-line {
    color: color-mix(in srgb, var(--accent) 70%, var(--ink));
  }

  .newsletter-card h3 {
    font-family: 'Instrument Serif', serif;
    font-size: 22px;
    font-weight: 400;
    line-height: 1.25;
    margin-bottom: 10px;
    letter-spacing: -0.01em;
  }

  .newsletter-card .card-link-title {
    color: var(--ink);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: color 0.2s ease, border-color 0.2s ease;
  }

  .newsletter-card .card-link-title:hover {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .newsletter-card .summary {
    font-size: 14px;
    line-height: 1.65;
    color: var(--summary-ink);
  }

  .newsletter-card .summary p {
    margin-bottom: 10px;
  }

  .newsletter-card .summary p:last-child {
    margin-bottom: 0;
  }

  .newsletter-card .summary ul {
    margin: 6px 0 0 18px;
    padding: 0;
  }

  .newsletter-card .summary li {
    margin: 0 0 6px 0;
    line-height: 1.6;
  }

  .newsletter-card .summary strong {
    font-weight: 600;
    color: var(--ink);
  }

  mark {
    background: var(--mark-bg);
    color: inherit;
    padding: 0 2px;
    border-radius: 3px;
  }

  .topics {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 14px;
  }

  .topic {
    font-size: 11px;
    padding: 3px 10px;
    background: var(--paper);
    border: 1px solid var(--rule);
    border-radius: 20px;
    color: var(--muted);
    font-weight: 500;
  }

  /* EMPTY STATE */
  .empty-day {
    text-align: center;
    padding: 80px 20px;
    color: var(--muted);
  }

  .empty-day .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.4;
  }

  .empty-day p {
    font-size: 14px;
    font-style: italic;
  }

  /* RESPONSIVE */
  @media (max-width: 980px) {
    .main {
      max-width: none;
      padding-right: 24px;
    }
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      min-height: auto;
      position: relative;
      flex-direction: row;
      flex-wrap: wrap;
      padding: 16px;
      z-index: 20;
    }

    .sidebar-header {
      width: 100%;
      margin-bottom: 10px;
      padding: 0 6px 12px;
    }

    .sidebar-header h1 {
      font-size: 20px;
    }

    .sidebar-header .brand-row {
      gap: 6px;
      align-items: center;
    }

    .sidebar-header .after-dark-sign {
      font-size: 12px;
      letter-spacing: 0.005em;
      padding: 2px 7px 1px;
    }

    .sidebar-footer,
    .quick-links,
    .weather-line {
      display: none;
    }

    .todo-panel {
      width: 100%;
      max-width: 100vw;
      border-left: none;
      border-top: 1px solid var(--rule);
      transform: translateX(100%);
      z-index: 90;
    }

    .todo-panel.collapsed {
      transform: translateX(100%);
    }

    .todo-panel.open {
      transform: translateX(0);
    }

    /* If Order Paper was open previously, start open with no flash. */
    html.todo-panel-init-open .todo-panel {
      transform: translateX(0);
    }

    .todo-panel-header {
      padding-top: 16px !important;
    }

    .todo-toggle-tab {
      display: block;
      writing-mode: horizontal-tb;
      position: fixed;
      right: 14px;
      bottom: 14px;
      top: auto;
      transform: none;
      border-radius: 20px;
      padding: 8px 14px;
      font-size: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 80;
    }

    .day-tabs {
      display: flex;
      gap: 4px;
      overflow-x: auto;
      width: 100%;
      padding-bottom: 4px;
    }

    .day-tab {
      padding: 8px 12px;
      border-left: none;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .day-tab.active {
      border-bottom-color: var(--accent);
      border-left-color: transparent;
    }

    .main {
      margin-left: 0;
      padding: 18px 14px 24px;
      width: 100%;
    }

    .utility-shell {
      top: 6px;
      margin-bottom: 14px;
    }

    #searchToggle {
      top: 24px;
      right: 74px;
    }

    .utility-bar {
      gap: 8px;
      padding: 10px;
    }

    .search-wrap {
      flex: 1 1 100%;
    }

    .utility-btn {
      padding: 7px 10px;
      font-size: 11px;
    }

    .utility-select {
      padding: 7px 24px 7px 10px;
      font-size: 11px;
    }

    .filters-meta .clear-filters {
      margin-left: 0;
    }

    .day-header {
      margin-bottom: 18px;
      padding-bottom: 12px;
    }

    .day-header h2 {
      font-size: 27px;
    }

    .newsletter-card {
      padding: 18px 14px;
      margin-bottom: 14px;
    }

    .newsletter-card h3 {
      font-size: 20px;
    }

    .card-meta {
      flex-wrap: wrap;
      gap: 7px;
    }

    .card-meta .from {
      width: 100%;
      margin-left: 0;
      order: 5;
    }

    .topic-heat {
      margin-bottom: 12px;
      gap: 6px;
    }

    .topic-chip {
      padding: 5px 9px;
      font-size: 10px;
    }

    .face-widget {
      top: 10px;
      right: 10px;
      width: 58px;
      height: 58px;
      border-width: 2px;
    }

    .order-panel {
      left: 12px;
      bottom: 12px;
      width: 220px;
    }

    .blackrod-overlay {
      padding: 20px 12px;
    }

    .blackrod-panel {
      padding: 24px 18px 20px;
    }

    .blackrod-title {
      font-size: 24px;
    }

    .blackrod-summary {
      font-size: 15px;
      line-height: 1.65;
    }
  }

  @media (max-width: 480px) {
    .sidebar {
      padding: 12px 10px;
    }

    .day-tab .day-date {
      display: none;
    }

    .utility-shell {
      top: 4px;
    }

    #searchToggle {
      top: 18px;
      right: 70px;
    }

    .search-wrap input {
      font-size: 13px;
      padding: 9px 34px 9px 10px;
    }

    .filters-meta {
      font-size: 11px;
    }

    .sidebar-header .after-dark-sign {
      font-size: 11px;
      letter-spacing: 0;
      padding: 2px 6px 1px;
    }

    .newsletter-card .summary {
      font-size: 13px;
      line-height: 1.58;
    }
  }

  @media (max-width: 380px) {
    #searchToggle {
      top: 14px;
      right: 56px;
    }

    .face-widget {
      width: 42px;
      height: 42px;
      right: 8px;
      top: 8px;
    }
    .face-widget .face-fallback {
      font-size: 12px;
    }
  }

  /* — Hansard: daily quote in sidebar footer — */
  .sidebar-quote {
    padding: 16px 24px;
    border-top: 1px solid var(--rule);
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .sidebar-quote:hover {
    color: var(--accent);
  }

  .sidebar-quote.flash {
    color: var(--accent);
  }

  .sidebar-quote blockquote {
    font-family: 'Libre Baskerville', serif;
    font-style: italic;
    font-size: 11px;
    line-height: 1.5;
    color: inherit;
    margin: 0;
  }

  .sidebar-quote .quote-attr {
    font-family: 'JetBrains Mono', monospace;
    font-style: normal;
    font-size: 11px;
    letter-spacing: 0.04em;
    color: var(--muted);
    margin-top: 4px;
    display: block;
  }

  /* — Division Bell: time greeting — */
  .time-greeting {
    font-family: 'Instrument Serif', serif;
    font-style: italic;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .progress-bar.division-bell {
    background: linear-gradient(90deg, #d4a017, #f0d060) !important;
    transition: width 0.6s ease !important;
  }

  /* — Red Box: priority flagging — */
  .newsletter-card.is-red-boxed {
    border-left: 3px solid #8b0000;
    background: color-mix(in srgb, var(--card) 96%, #8b0000);
  }

  [data-theme="dark"] .newsletter-card.is-red-boxed {
    border-left-color: #ff4444;
    background: color-mix(in srgb, var(--card) 96%, #ff4444);
  }

  .red-box-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.06em;
    color: #8b0000;
    margin-left: 8px;
  }

  [data-theme="dark"] .red-box-label {
    color: #ff4444;
  }

  /* — Whip's Office: topic bar panel — */
  .whip-panel {
    position: fixed;
    bottom: 48px;
    right: 18px;
    z-index: 95;
    width: 230px;
    max-height: 360px;
    overflow-y: auto;
    background: var(--card);
    border: 1px solid var(--rule);
    border-radius: 10px;
    padding: 14px 16px;
    box-shadow: var(--shadow);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;
  }

  .whip-panel.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .whip-panel[hidden] {
    display: none;
  }

  .whip-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .whip-bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  .whip-bar-label {
    font-size: 11px;
    color: var(--ink);
    min-width: 75px;
    flex-shrink: 0;
  }

  .whip-bar-fill {
    height: 6px;
    border-radius: 3px;
    background: var(--accent);
    flex-shrink: 0;
    transition: width 0.3s ease;
  }

  .whip-bar-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    min-width: 16px;
    text-align: right;
  }

  /* — Order Paper: source rankings panel — */
  .order-panel {
    position: fixed;
    bottom: 48px;
    left: 18px;
    z-index: 95;
    width: 260px;
    max-height: 400px;
    overflow-y: auto;
    background: var(--card);
    border: 1px solid var(--rule);
    border-radius: 10px;
    padding: 14px 16px;
    box-shadow: var(--shadow);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;
  }

  .order-panel.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .order-panel[hidden] {
    display: none;
  }

  .order-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .order-bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  .order-bar-label {
    font-size: 11px;
    color: var(--ink);
    min-width: 100px;
    flex-shrink: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .order-bar-track {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: var(--rule);
    overflow: hidden;
  }

  .order-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent);
    transition: width 0.3s ease;
  }

  .order-bar-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    min-width: 16px;
    text-align: right;
  }

  /* — Black Rod: focus reading overlay — */
  .blackrod-overlay {
    position: fixed;
    inset: 0;
    z-index: 150;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 40px 20px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.42);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    animation: fadeIn 0.15s ease;
  }

  .blackrod-overlay[hidden] {
    display: none;
  }

  .blackrod-panel {
    width: min(680px, 100%);
    background: var(--card);
    border: 1px solid var(--rule);
    border-top: 3px solid var(--accent);
    border-radius: 12px;
    padding: 36px 40px 32px;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.18);
    margin: auto 0;
  }

  .blackrod-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .blackrod-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .blackrod-close {
    background: none;
    border: 1px solid var(--rule);
    border-radius: 999px;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    color: var(--muted);
    flex-shrink: 0;
  }

  .blackrod-close:hover {
    border-color: var(--accent);
    background: var(--accent-soft);
    color: var(--ink);
  }

  .blackrod-sender {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 4px;
  }

  .blackrod-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .blackrod-title {
    font-family: 'Instrument Serif', serif;
    font-size: 30px;
    font-weight: 400;
    line-height: 1.25;
    letter-spacing: -0.02em;
    color: var(--ink);
    margin: 20px 0 16px;
  }

  .blackrod-status {
    display: flex;
    gap: 10px;
    margin-bottom: 18px;
  }

  .blackrod-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid var(--rule);
    color: var(--muted);
  }

  .blackrod-badge.is-on {
    color: var(--accent);
    border-color: color-mix(in srgb, var(--accent) 40%, var(--rule));
  }

  .blackrod-summary {
    font-size: 17px;
    line-height: 1.75;
    color: var(--ink);
  }

  .blackrod-summary p {
    margin-bottom: 14px;
  }

  .blackrod-summary p:last-child {
    margin-bottom: 0;
  }

  .blackrod-summary ul {
    margin: 8px 0 0 20px;
    padding: 0;
  }

  .blackrod-summary li {
    margin: 0 0 8px 0;
    line-height: 1.7;
  }

  .blackrod-summary strong {
    font-weight: 600;
    color: var(--ink);
  }

  .blackrod-topics {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 18px;
    padding-top: 16px;
    border-top: 1px solid var(--rule);
  }

  .blackrod-link {
    display: inline-block;
    margin-top: 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--accent);
    text-decoration: none;
    border: 1px solid var(--rule);
    border-radius: 999px;
    padding: 8px 16px;
    transition: all 0.2s ease;
  }

  .blackrod-link:hover {
    border-color: var(--accent);
    background: var(--accent-soft);
  }

  /* — Dispatch Box: stats overlay — */
  .dispatch-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    animation: fadeIn 0.15s ease;
  }

  .dispatch-overlay[hidden] {
    display: none;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .dispatch-panel {
    background: var(--card);
    border: 1px solid var(--rule);
    border-radius: 12px;
    padding: 28px 32px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    width: 320px;
    max-width: 90vw;
  }

  .dispatch-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .dispatch-title {
    font-family: 'Instrument Serif', serif;
    font-size: 22px;
    font-weight: 400;
    color: var(--ink);
  }

  .dispatch-close {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--muted);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
  }

  .dispatch-close:hover {
    color: var(--ink);
    background: var(--accent-soft);
  }

  .dispatch-grid {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px 16px;
  }

  .dispatch-label {
    font-size: 12px;
    color: var(--muted);
  }

  .dispatch-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    font-weight: 600;
    color: var(--ink);
    text-align: right;
  }

  .dispatch-value .pct {
    font-weight: 400;
    font-size: 11px;
    color: var(--muted);
    margin-left: 2px;
  }

  /* — Lobby Correspondent: konami mode — */
  body.lobby-mode .source-tag {
    background: #4a6741 !important;
  }

  /* — Resign: cabinet reshuffle animation — */
  .newsletter-card.resigning {
    transform: translateX(var(--dx, 0)) translateY(var(--dy, 0)) rotate(var(--dr, 0deg));
    opacity: 0 !important;
    transition: transform 0.6s cubic-bezier(0.55, 0, 1, 0.45), opacity 0.6s cubic-bezier(0.55, 0, 1, 0.45);
  }

  .newsletter-card.returning {
    transform: translateX(0) translateY(0) rotate(0deg);
    opacity: 1 !important;
    transition: transform 0.8s cubic-bezier(0, 0.55, 0.45, 1), opacity 0.8s cubic-bezier(0, 0.55, 0.45, 1);
  }

  /* — Prorogation: idle screensaver — */
  .prorogue-overlay {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.88);
    opacity: 0;
    transition: opacity 1.5s ease;
    cursor: default;
  }

  .prorogue-overlay[hidden] {
    display: none;
  }

  .prorogue-overlay.show {
    opacity: 1;
  }

  .prorogue-overlay.hiding {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .prorogue-title {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    font-weight: 400;
    letter-spacing: -0.02em;
    color: #d5cfc5;
    margin-bottom: 12px;
    text-align: center;
  }

  .prorogue-sub {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #7a756d;
  }

  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }

    .face-widget,
    .face-widget.face-spinning,
    .face-widget.face-overdrive {
      animation: none !important;
      transform: none !important;
    }

    .sidebar-header .after-dark-sign {
      animation: none !important;
    }

    .egg-toast {
      transition: none !important;
    }

    .progress-bar.division-bell {
      transition: none !important;
    }

    .whip-panel {
      transition: none !important;
    }

    .order-panel {
      transition: none !important;
    }

    .dispatch-overlay {
      animation: none !important;
    }

    .blackrod-overlay {
      animation: none !important;
    }

    .newsletter-card.resigning,
    .newsletter-card.returning {
      transition: none !important;
      transform: none !important;
      opacity: 1 !important;
    }

    .prorogue-overlay,
    .prorogue-overlay.show,
    .prorogue-overlay.hiding {
      transition: none !important;
    }
  }

  /* — Printed Hansard: print stylesheet — */
  @media print {
    :root {
      --ink: #000 !important;
      --paper: #fff !important;
      --card: #fff !important;
      --rule: #ccc !important;
      --muted: #666 !important;
      --accent: #000 !important;
      --accent-soft: transparent !important;
      --shadow: none !important;
    }

    html[data-theme] {
      background: #fff !important;
      color: #000 !important;
    }

    .sidebar,
    .progress-wrap,
    .face-widget,
    .egg-toast,
    .whip-panel,
    .order-panel,
	  .dispatch-overlay,
	  .shortcuts-overlay,
	  .cmd-palette,
	  .blackrod-overlay,
	  .todo-panel,
	  .todo-toggle-tab,
	  .utility-shell,
	  .card-action,
    .card-menu-btn,
    .open-link,
    .mute-manager,
    .pollster-line,
    .topics,
    .read-check {
      display: none !important;
    }

    body {
      margin: 0;
      padding: 0;
    }

    .main {
      margin: 0 !important;
      padding: 20px 40px !important;
      max-width: 100% !important;
    }

    .newsletter-card {
      border: none !important;
      border-bottom: 1px solid #ccc !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      background: none !important;
      padding: 16px 0 !important;
      margin-bottom: 0 !important;
      opacity: 1 !important;
      break-inside: avoid;
    }

    .newsletter-card.is-read {
      opacity: 1 !important;
    }

    .newsletter-card .card-meta {
      margin-bottom: 4px;
    }

    .source-tag {
      background: none !important;
      color: #000 !important;
      border: 1px solid #999 !important;
      font-size: 9px !important;
      padding: 1px 5px !important;
    }

    .red-box-label {
      display: none !important;
    }

    .newsletter-card h3,
    .card-link-title {
      font-family: 'Instrument Serif', Georgia, serif !important;
      font-size: 16pt !important;
      color: #000 !important;
      text-decoration: none !important;
    }

    .summary {
      font-family: 'DM Sans', Helvetica, Arial, sans-serif !important;
      font-size: 11pt !important;
      line-height: 1.5 !important;
      color: #222 !important;
    }

    .summary strong {
      color: #000 !important;
    }

    .time, .from {
      font-size: 9pt !important;
      color: #666 !important;
    }

    .day-heading {
      font-family: 'Instrument Serif', Georgia, serif !important;
      font-size: 20pt !important;
      color: #000 !important;
      border-bottom: 2px solid #000;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }

    .time-greeting {
      display: none !important;
    }

    @page {
      margin: 2cm;
    }
  }
</style>
</head>
<body>

<div class="progress-wrap" aria-hidden="true">
  <div class="progress-bar" id="progressBar"></div>
</div>

<nav class="sidebar">
	  <div class="sidebar-header">
	    <div class="brand-row">
	      <h1>CW <span>Digest</span></h1>
	      <span class="after-dark-sign" aria-hidden="true">After Dark</span>
	    </div>
	    <div class="week-label">W/C 7 Feb 2026</div>
	    <div class="weather-line" id="weatherLine">&mdash;</div>
	    <div class="moe-wink" title="For entertainment purposes only">MOE ±3.1%</div>
	  </div>
	  <div class="quick-links" id="quickLinks"></div>
	  <ul class="day-tabs" id="dayTabs"></ul>
	  <div class="sidebar-quote" id="dailyQuote" title="Click to copy"></div>
	</nav>

<div class="face-widget fallback" id="faceWidget" aria-label="CW avatar">
  <img id="faceImage" alt="Calum avatar">
  <div class="face-fallback">CW</div>
</div>

<button class="utility-btn utility-btn-icon" id="searchToggle" type="button" aria-label="Show search and filters" title="Show search and filters">▸</button>

<main class="main" id="mainContent">
  <section class="utility-shell">
    <div class="utility-bar">
      <div class="search-wrap">
        <input id="searchInput" type="search" placeholder="Search titles, summaries, senders, topics..." autocomplete="off" spellcheck="false" />
        <span class="slash-hint">/</span>
	      </div>
	      <button class="utility-btn" id="clearSearch" type="button">Clear</button>
	      <button class="utility-btn" id="refreshDigest" type="button">Refresh</button>
	      <span class="refresh-meta" id="refreshMeta" hidden></span>
	      <button class="utility-btn" id="themeToggle" type="button">Theme: Auto</button>
	      <button class="utility-btn" id="sortToggle" type="button">Sort: Newest</button>
	      <div class="view-toggle" id="viewToggle" role="group" aria-label="View mode">
	        <button class="view-btn" type="button" data-view="all">All</button>
	        <button class="view-btn" type="button" data-view="unread">Unread</button>
	        <button class="view-btn" type="button" data-view="saved">Saved</button>
	      </div>
	      <select class="utility-select" id="archiveSelect" aria-label="Archive week">
	        <option value="current">Archive: Current Week</option>
	      </select>
	      <div class="filters-meta" id="activeFilters">
	        <span class="pill">No filters</span>
	        <a class="clear-filters" id="clearFilters">Clear filters</a>
	      </div>
	      <details class="mute-manager" id="muteManager" hidden>
	        <summary>Muted <span class="mute-count" id="muteCount">0</span></summary>
	        <div class="mute-block">
	          <div class="mute-title">Senders</div>
	          <div class="mute-chips" id="mutedSenders"></div>
	        </div>
	        <div class="mute-block">
	          <div class="mute-title">Sources</div>
	          <div class="mute-chips" id="mutedSources"></div>
	        </div>
	        <button class="mute-clear" id="clearMutes" type="button">Clear all mutes</button>
	      </details>
	    </div>
	    <div class="topic-heat" id="topicHeat"></div>
	  </section>
	  <section class="results-banner" id="resultsBanner" hidden></section>
	  <section id="contentMount"></section>
	</main>

	<aside class="todo-panel" id="todoPanel">
	  <div class="todo-panel-header">
	    <span class="todo-panel-title">Order Paper</span>
	    <span class="todo-panel-count" id="todoPanelCount"></span>
	    <button class="todo-export-btn" id="todoExportBtn" title="Copy as Markdown (Shift+click to download .md)">MD</button>
	    <button class="todo-search-btn" id="todoSearchBtn" title="Filter items (/)">&#8981;</button>
	    <button class="todo-panel-theme-btn" id="todoPanelThemeBtn" title="Cycle theme">&#9819;</button>
	    <button class="todo-panel-collapse" id="todoPanelCollapse" title="Collapse">&laquo;</button>
	  </div>
	  <div class="todo-panel-input-wrap">
	    <input class="todo-panel-input" id="todoPanelInput" type="text" placeholder="Add to the Order Paper..." maxlength="200">
	  </div>
	  <div class="todo-panel-list" id="todoPanelList"></div>
	</aside>
	<button class="todo-toggle-tab" id="todoToggleTab" title="Order Paper">Order Paper</button>

	<div class="egg-toast" id="eggToast" aria-live="polite" hidden></div>

	<div class="whip-panel" id="whipPanel" hidden></div>
	<div class="order-panel" id="orderPanel" hidden></div>

	<div class="dispatch-overlay" id="dispatchOverlay" hidden>
	  <div class="dispatch-panel" role="dialog" aria-modal="true" aria-label="Weekly statistics">
	    <div class="dispatch-head">
	      <div class="dispatch-title">Dispatch Box</div>
	      <button class="dispatch-close" type="button" id="dispatchClose" aria-label="Close">×</button>
	    </div>
	    <div class="dispatch-grid" id="dispatchGrid"></div>
	  </div>
	</div>

	<div class="card-menu-pop" id="cardMenu" role="menu" aria-label="Card actions" hidden>
	  <button class="menu-item" type="button" data-menu-action="toggle-save">Save</button>
	  <button class="menu-item" type="button" data-menu-action="toggle-read">Mark read</button>
	  <div class="menu-sep" role="separator"></div>
	  <button class="menu-item" type="button" data-menu-action="mute-sender">Mute sender</button>
	  <button class="menu-item" type="button" data-menu-action="mute-source">Mute source</button>
	</div>

	<div class="shortcuts-overlay" id="shortcutsOverlay" hidden>
	  <div class="shortcuts-panel" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts">
	    <div class="shortcuts-head">
	      <div class="shortcuts-title">Shortcuts</div>
	      <button class="shortcuts-close" type="button" id="shortcutsClose" aria-label="Close">×</button>
	    </div>
	    <div class="shortcuts-grid">
	      <div class="shortcut-row"><span class="kbd">/</span><span class="desc">Focus search</span></div>
	      <div class="shortcut-row"><span class="kbd">Cmd</span>+<span class="kbd">K</span><span class="desc">Command palette</span></div>
	      <div class="shortcut-row"><span class="kbd">j</span>/<span class="kbd">k</span><span class="desc">Move between cards</span></div>
	      <div class="shortcut-row"><span class="kbd">Enter</span><span class="desc">Open focused card</span></div>
	      <div class="shortcut-row"><span class="kbd">s</span><span class="desc">Save/unsave</span></div>
	      <div class="shortcut-row"><span class="kbd">r</span><span class="desc">Read/unread</span></div>
	      <div class="shortcut-row"><span class="kbd">a</span><span class="desc">Mark all visible read</span></div>
	      <div class="shortcut-row"><span class="kbd">f</span><span class="desc">Focus reading mode</span></div>
	      <div class="shortcut-row"><span class="kbd">e</span><span class="desc">Random unread (EDM)</span></div>
	      <div class="shortcut-row"><span class="kbd">t</span><span class="desc">Topic breakdown</span></div>
	      <div class="shortcut-row"><span class="kbd">o</span><span class="desc">Source rankings</span></div>
	      <div class="shortcut-row"><span class="kbd">p</span><span class="desc">Toggle Order Paper</span></div>
	      <div class="shortcut-row"><span class="kbd">?</span><span class="desc">Toggle this help</span></div>
	      <div class="shortcut-row"><span class="kbd">Esc</span><span class="desc">Close menus/help</span></div>
	    </div>
	  </div>
	</div>

	<div class="cmd-palette" id="cmdPalette" hidden>
	  <div class="cmd-palette-panel" role="dialog" aria-modal="true" aria-label="Command palette">
	    <input class="cmd-palette-input" id="cmdPaletteInput" type="text" placeholder="Search actions, links, articles, todos..." autocomplete="off">
	    <div class="cmd-palette-results" id="cmdPaletteResults"></div>
	    <div class="cmd-palette-hint">
	      <span>↑↓ navigate</span>
	      <span>↵ select</span>
	      <span>esc close</span>
	    </div>
	  </div>
	</div>

	<div class="blackrod-overlay" id="blackrodOverlay" hidden>
	  <div class="blackrod-panel" role="dialog" aria-modal="true" aria-label="Focus reading view">
	    <div class="blackrod-head">
	      <div class="blackrod-meta" id="blackrodMeta"></div>
	      <button class="blackrod-close" type="button" id="blackrodClose" aria-label="Close">&times;</button>
	    </div>
	    <div class="blackrod-sender" id="blackrodSender"></div>
	    <div class="blackrod-time" id="blackrodTime"></div>
	    <h2 class="blackrod-title" id="blackrodTitle"></h2>
	    <div class="blackrod-status" id="blackrodStatus"></div>
	    <div class="blackrod-summary" id="blackrodSummary"></div>
	    <div class="blackrod-topics" id="blackrodTopics"></div>
	    <a class="blackrod-link" id="blackrodLink" target="_blank" rel="noopener noreferrer">Open article</a>
	  </div>
	</div>

	<div class="prorogue-overlay" id="prorogueOverlay" hidden>
	  <div class="prorogue-title">The House stands prorogued</div>
	  <div class="prorogue-sub">Move to resume session</div>
	</div>

	<script>
const DATA = {
  "days": [
    {
      "key": "sat",
      "name": "Saturday",
      "date": "7 Feb",
      "dateFull": "Saturday 7 February 2026",
      "items": [
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Odds and Ends of History' via Everyone",
          "time": "21:36",
          "title": "Theories of power, cattle grids and a blep (Odds and Ends #85)",
          "summary": "\u003Cp\u003E\u003Cstrong\u003ENew Green Book reform aims for equitable investment across the UK.\u003C/strong\u003E The updated Green Book will consider a broader range of impacts in investment decisions, moving away from solely relying on benefit-cost ratios. This change is expected to benefit regions outside London and the South-East, addressing long-standing disparities in project funding.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EGreater Cambridge Development Corporation proposed to enhance infrastructure delivery.\u003C/strong\u003E A consultation has been launched to establish a Development Corporation aimed at improving infrastructure alongside new housing in Greater Cambridge. This initiative seeks to align national resources with local expertise to accelerate development and address regional challenges.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EJames O\u0026#x27;Malley speaks at London Assembly on New Towns.\u003C/strong\u003E O\u0026#x27;Malley presented insights on Ebbsfleet to the Planning and Regeneration Committee, advocating for prioritising speed in development processes over prolonged consultations. His participation underscores the importance of effective planning in urban development discussions.\u003C/p\u003E",
          "topics": [
            "Reform",
            "Housing"
          ],
          "article_url": "https://open.substack.com/pub/jamesomalley/p/theories-of-power?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c3a092ec58c71b",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c3a092ec58c71b",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Dominic Cummings substack' via Everyone",
          "time": "12:51",
          "title": "Regime Change 2026-29: results from a market research project",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EMarket research reveals voter discontent with current political options.\u003C/strong\u003E A recent study highlights significant dissatisfaction among voters, with many expressing frustration over GP access, immigration, and the perceived failures of both major parties. This discontent could lead to increased support for alternative figures like Nigel Farage.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EConcerns over immigration and community changes dominate voter priorities.\u003C/strong\u003E Respondents report feeling overwhelmed by immigration levels and cultural shifts in their communities, with some citing a loss of local identity and increased tensions. This sentiment may influence future electoral outcomes, particularly in swing constituencies.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EPolitical insiders face challenges in adapting to shifting public sentiment.\u003C/strong\u003E The research indicates a disconnect between the priorities of voters and the responses of political elites, suggesting that traditional parties may struggle to remain relevant. The potential for a new political movement could emerge if leaders effectively address these concerns.\u003C/p\u003E",
          "topics": [
            "Immigration"
          ],
          "article_url": "https://open.substack.com/pub/dominiccummings/p/regime-change-2026-29-results-from?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c3828e6a9c9aa0",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c3828e6a9c9aa0",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Noahpinion' via Everyone",
          "time": "11:21",
          "title": "Why America's extremes will both fail",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EAmerican politics increasingly dominated by extremists.\u003C/strong\u003E The U.S. political landscape is characterised by a moderate majority overshadowed by a highly engaged fringe of extremists, driven by closed-primary systems and amplified by social media. This shift has led to a more polarised and ideologically extreme online public sphere.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EYounger Congressional staffers contribute to extremism.\u003C/strong\u003E The average age of Congressional staffers is in their late 20s, significantly younger than the typical Congressperson in their late 50s. This age gap results in staffers being more immersed in online extremist content, allowing them to influence policy and messaging without direct accountability to voters.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ESocial media use declines among moderates, exacerbating polarization.\u003C/strong\u003E Recent studies indicate that overall social media usage is declining, particularly among younger and older Americans, while platforms like TikTok and Reddit are gaining traction. This trend leads to a shrinking, more ideologically extreme online discourse as moderates disengage from politically charged environments.\u003C/p\u003E",
          "topics": [
            "General"
          ],
          "article_url": "https://open.substack.com/pub/noahpinion/p/why-americas-extremes-will-both-fail?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c37d90bb84fff0",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c37d90bb84fff0",
          "open_url_type": "gmail"
        }
      ]
    },
    {
      "key": "sun",
      "name": "Sunday",
      "date": "8 Feb",
      "dateFull": "Sunday 8 February 2026",
      "items": [
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Matthew Yglesias' via Everyone",
          "time": "18:01",
          "title": "Sunday Thread + Mailbag",
          "summary": "\u003Cp\u003E\u003Cstrong\u003ENo significant political developments reported this week.\u003C/strong\u003E The Sunday thread invites questions from the public, indicating ongoing engagement with constituents.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EMailbag feature continues to encourage dialogue.\u003C/strong\u003E This initiative allows readers to submit inquiries, fostering transparency and interaction between the platform and its audience.\u003C/p\u003E",
          "topics": [
            "General"
          ],
          "article_url": "https://open.substack.com/pub/matthewyglesias/p/sunday-thread-mailbag-1d9?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c3e6f25f92b167",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c3e6f25f92b167",
          "open_url_type": "gmail"
        },
        {
          "source": "politico",
          "sourceLabel": "POLITICO",
          "from": "POLITICO Europe",
          "time": "14:56",
          "title": "Top Starmer aide Morgan McSweeney resigns over Peter Mandelson scandal",
          "summary": "\u003Cp\u003E\u003Cstrong\u003ETop Starmer aide Morgan McSweeney resigns amid Mandelson scandal.\u003C/strong\u003E Morgan McSweeney has stepped down following revelations about Peter Mandelson\u0026#x27;s ties to convicted sex offender Jeffrey Epstein.\u003C/p\u003E\u003Cp\u003EThis resignation adds to the pressure on Prime Minister Starmer as he navigates the fallout from the scandal.\u003C/p\u003E",
          "topics": [
            "Labour"
          ],
          "article_url": "https://www.politico.eu/article/top-starmer-aide-morgan-mcsweeney-resigns-over-peter-mandelson-scandal/?utm_source=email\u0026amp;utm_medium=alert\u0026amp;utm_campaign=Top%20Starmer%20aide%20Morgan%20McSweeney%20resigns%20over%20Peter%20Mandelson%20scandal",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c3dc0af857524e",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c3dc0af857524e",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Comment is Freed' via Everyone",
          "time": "09:03",
          "title": "After Starmer",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EStarmer\u0026#x27;s leadership faces imminent threat amid Mandelson scandal.\u003C/strong\u003E Keir Starmer\u0026#x27;s position is increasingly precarious following revelations about his appointment of Peter Mandelson, with senior Labour MPs considering a delegation to request his resignation. The lack of a clear successor and internal party divisions complicate any leadership transition.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EPotential leadership contenders emerge as Starmer\u0026#x27;s future hangs in balance.\u003C/strong\u003E Wes Streeting and Angela Rayner are the leading candidates, though both have reasons to delay a challenge, while Ed Miliband\u0026#x27;s previous leadership failure remains a concern. Speculation grows around lesser-known figures like Al Carns, highlighting the party\u0026#x27;s struggle to identify a viable alternative.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ERayner favoured to succeed if leadership contest occurs.\u003C/strong\u003E Angela Rayner\u0026#x27;s odds have improved, bolstered by Labour\u0026#x27;s rule changes that favour union member participation in elections. Her ongoing HMRC investigation may influence her timing, but if resolved, she could capitalise on her support within the party.\u003C/p\u003E",
          "topics": [
            "Labour"
          ],
          "article_url": "https://open.substack.com/pub/samf/p/after-starmer?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c3c81f3bd05f3c",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c3c81f3bd05f3c",
          "open_url_type": "gmail"
        }
      ]
    },
    {
      "key": "mon",
      "name": "Monday",
      "date": "9 Feb",
      "dateFull": "Monday 9 February 2026",
      "items": [
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Halina Bennet from Slow Boring' via Everyone",
          "time": "23:00",
          "title": "Big swings and calls for moderation",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EProgressive candidate leads in New Jersey\u0026#x27;s NJ-11 special primary.\u003C/strong\u003E Analilia Mejia holds a narrow 486-vote lead over former Representative Tom Malinowski, with 91% of votes counted. AIPAC\u0026#x27;s super PAC spent over $2 million against Malinowski, highlighting a shift towards more progressive candidates within the Democratic Party.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EDemocrat wins Louisiana special election by significant margin.\u003C/strong\u003E Chasity Verret Martinez secured 62% of the vote in Louisiana House District 60, a district previously won by Trump by 13 points in 2024. This 37-point margin shift underscores a growing Democratic momentum in special elections, with Democrats flipping eight GOP-held districts during Trump\u0026#x27;s second term.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EHouston Chronicle endorses moderate candidate in Texas Senate primary.\u003C/strong\u003E The editorial board endorsed State Representative James Talarico over U.S. Representative Jasmine Crockett, citing Talarico\u0026#x27;s moderate approach as more viable for winning in a Republican-leaning state. This endorsement reflects a broader call for Democrats to adopt pragmatic strategies to appeal to a wider electorate.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ESurvey shows young men favour moderate Democratic candidates.\u003C/strong\u003E A Third Way survey indicates that young men, a key swing demographic, prefer candidates who address economic security and family values. Democrats currently lead the generic congressional ballot among young men, 54% to 36%, suggesting potential for increased support if they align their agenda with these concerns.\u003C/p\u003E",
          "topics": [
            "Elections",
            "Foreign Policy"
          ],
          "article_url": "https://open.substack.com/pub/matthewyglesias/p/big-swings-and-calls-for-moderation?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c44a608cdac5b2",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c44a608cdac5b2",
          "open_url_type": "gmail"
        },
        {
          "source": "politico",
          "sourceLabel": "POLITICO",
          "from": "POLITICO London Playbook",
          "time": "17:24",
          "title": "London Playbook PM: Just a flesh wound",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EStarmer faces pressure from Scottish Labour leader to resign.\u003C/strong\u003E Anas Sarwar has publicly called for Keir Starmer to step down, citing distractions from government achievements due to ongoing scandals. This marks a significant shift in Sarwar\u0026#x27;s stance, as he previously defended Starmer against internal criticism.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EDowning Street communications chief resigns amid turmoil.\u003C/strong\u003E Tim Allan is the latest press aide to leave No.10, following the resignation of chief of staff Morgan McSweeney. His departure comes as Starmer attempts to project confidence despite internal challenges, raising questions about the stability of his leadership team.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ELabour MPs rally around Starmer despite dissent.\u003C/strong\u003E Senior Labour figures have expressed support for the Prime Minister, indicating that leadership challengers are not expected to emerge at this time. However, the backlash against Sarwar\u0026#x27;s comments suggests underlying tensions within the party that could affect future unity.\u003C/p\u003E",
          "topics": [
            "Labour"
          ],
          "article_url": "",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c436ed80c960c6",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c436ed80c960c6",
          "open_url_type": "gmail"
        },
        {
          "source": "politico",
          "sourceLabel": "POLITICO",
          "from": "POLITICO Europe",
          "time": "13:51",
          "title": "Scottish Labour leader to call for Starmer to quit",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EScottish Labour leader calls for Starmer to resign.\u003C/strong\u003E Anas Sarwar, once a close ally of Keir Starmer, is set to publicly urge the Labour leader to step down.\u003C/p\u003E\u003Cp\u003EThis marks a significant shift in Sarwar\u0026#x27;s stance and could indicate growing dissent within the party.\u003C/p\u003E",
          "topics": [
            "Labour"
          ],
          "article_url": "https://www.politico.eu/article/scottish-labour-leader-anas-sarwar-to-call-for-keir-starmer-to-quit/?utm_source=email\u0026amp;utm_medium=alert\u0026amp;utm_campaign=Scottish%20Labour%20leader%20to%20call%20for%20Starmer%20to%20quit",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c42ac4bbf17243",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c42ac4bbf17243",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Matthew Yglesias' via Everyone",
          "time": "11:02",
          "title": "DoorDash and the dilemma of affluence",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EFood delivery apps reflect changing consumer behaviour amid rising affluence.\u003C/strong\u003E The rise of services like DoorDash has made diverse cuisines more accessible, but spending patterns reveal a complex relationship with income. Despite anecdotes of individuals overspending on meal delivery, overall food spending has declined relative to incomes over the past 40 years.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ESpending on food delivery does not indicate a broader affordability crisis.\u003C/strong\u003E Data from the Bureau of Labor Statistics shows that both at-home and away-from-home food spending has decreased as a share of income, suggesting that Americans are becoming wealthier rather than less prudent. Critics argue that high delivery costs are a symptom of economic strain, but evidence indicates that rising affluence is driving changes in consumption patterns.\u003C/p\u003E",
          "topics": [
            "Housing"
          ],
          "article_url": "https://open.substack.com/pub/matthewyglesias/p/doordash-and-the-dilemma-of-affluence?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4214625c81efe",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4214625c81efe",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Noahpinion' via Everyone",
          "time": "09:40",
          "title": "The Takaichi Era begins for real",
          "summary": "\u003Cp\u003E\u003Cstrong\u003ETakaichi Sanae secures historic electoral victory for LDP.\u003C/strong\u003E The Liberal Democratic Party won 68% of seats in the lower house, achieving a two-thirds majority, the largest in its 71-year history. This positions Takaichi to pass legislation with ease, signalling a strong mandate for her leadership.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ELDP\u0026#x27;s dominance attributed to responsiveness to voter concerns.\u003C/strong\u003E The party has maintained power by adapting to public sentiment, shifting policies to address issues like corruption and economic growth. This adaptability has solidified its support, contrasting with perceptions of a one-party state.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EJapan\u0026#x27;s security concerns shape electoral outcomes.\u003C/strong\u003E With increasing global instability and doubts about U.S. military support under Trump, voters have turned to Takaichi for assurances of national security. Her leadership is seen as a response to these anxieties, reinforcing the LDP\u0026#x27;s electoral success.\u003C/p\u003E",
          "topics": [
            "Economy",
            "Foreign Policy"
          ],
          "article_url": "https://open.substack.com/pub/noahpinion/p/the-takaichi-era-begins-for-real?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c41c8e1cecd4ce",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c41c8e1cecd4ce",
          "open_url_type": "gmail"
        },
        {
          "source": "stephen_bush",
          "sourceLabel": "STEPHEN BUSH",
          "from": "'Stephen Bush' via Everyone",
          "time": "09:36",
          "title": "Inside Politics: McSweeney exits",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EMcSweeney resigns as Starmer\u0026#x27;s chief of staff.\u003C/strong\u003E The departure signals potential turmoil within Labour\u0026#x27;s leadership as internal criticisms of policy focus intensify.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EConcerns grow over Labour\u0026#x27;s policy direction.\u003C/strong\u003E Critics allege that Starmer prioritises voter appeal over substantive governance, raising questions about the party\u0026#x27;s long-term strategy.\u003C/p\u003E",
          "topics": [
            "Labour"
          ],
          "article_url": "https://email.newsletters.ft.com/c/eJyMkUFu3DoMQE9j7TSQKImSFloE-Bgg698egBKpxIjHntpyB7190SBFusyaj8QDX6MhL9v-q6zyOBYZQ3bFpVefOygpNkaDkGNGJTeal2cuwXrijqCxx6B9INQVCXQS37qvNtUA6rXEKj1yqIkrRQg5embHDj32yik3NRcwgAZMNtmhxUsKribDNrgKlihP3nxKHZc-Lm27qaW8jnE_Jvc0wXWC6-Px-BhNcP2Hn9z1w3hy_33FeQI85OUm63hfge5Nz5J0Sxw0dd-0NGYdE7Gp2WXAqpb5GH9egtVUci1YqSkYZ4zUwN6p-77x2UY57rS_qb3QQuvkzUJ1O_exvch4lf3Stsv5pnb5ccr7uSbsINeuW2tOe7SgaxPSzQgTWcTc0l9c-H9Z-dt8-2wVvRrlPGee3NOXYo2d1oPamLf1mYutJiXsXkeBpj1ZqxPbpCMGcZiyhxDUecj-_Zy5EAVOgka30FB7ANFZrOjIPfnuJDsQ9bPA7wAAAP__zMO5kQ",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c41c2ab4f93f3c",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c41c2ab4f93f3c",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Tim Leunig’s Policy Substack' via Everyone",
          "time": "08:15",
          "title": "Bring down this wall, Mr Secretary...",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EGovernment urged to reform leasehold permissions for flat alterations.\u003C/strong\u003E A proposal suggests scrapping the requirement for leaseholders to seek freeholder permission for non-structural changes, which currently complicates renovations and lease extensions. This change could enhance property values and improve living conditions for many flat owners.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ECase highlights issues with current leasehold system.\u003C/strong\u003E A leaseholder in Hammersmith and Fulham was forced to restore a previously altered door to apply for a lease extension, incurring unnecessary costs and delays. Such cases exemplify the burdensome nature of leasehold agreements, prompting calls for reform from stakeholders.\u003C/p\u003E",
          "topics": [
            "Reform"
          ],
          "article_url": "https://open.substack.com/pub/timleunig/p/bring-down-this-wall-mr-secretary?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4178553a08746",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4178553a08746",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Odds and Ends of History' via Everyone",
          "time": "07:02",
          "title": "Does AI make you stupid?",
          "summary": "\u003Cp\u003E\u003Cstrong\u003ENew study questions AI\u0026#x27;s productivity benefits.\u003C/strong\u003E Recent research suggests that AI may not deliver the anticipated productivity gains, prompting renewed debate among experts Martin and James on the YIMBY Pod.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EGovernment value assessment changes could impact infrastructure projects.\u003C/strong\u003E A minor adjustment in how the government evaluates value for money could significantly affect future infrastructure developments, including railway projects.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ETony Blair Institute releases paper on AI and public service reform.\u003C/strong\u003E Alexander Iosad and Eleni Arzoglou from the Tony Blair Institute discuss their new findings on how AI can reshape public services, highlighting the need for strategic reforms in the sector.\u003C/p\u003E",
          "topics": [
            "Reform",
            "AI"
          ],
          "article_url": "https://open.substack.com/pub/jamesomalley/p/does-ai-make-you-stupid?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4135f144b84dd",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4135f144b84dd",
          "open_url_type": "gmail"
        }
      ]
    },
    {
      "key": "tue",
      "name": "Tuesday",
      "date": "10 Feb",
      "dateFull": "Tuesday 10 February 2026",
      "items": [
        {
          "source": "politico",
          "sourceLabel": "POLITICO",
          "from": "POLITICO London Playbook",
          "time": "17:23",
          "title": "London Playbook PM: Drama school Starmer",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EStarmer adopts emotive rhetoric following near leadership crisis.\u003C/strong\u003E Keir Starmer delivered passionate remarks in Hertfordshire, asserting his commitment to fighting for the public rather than internal party disputes. This comes after a turbulent period where he faced significant challenges to his leadership.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EAntonia Romeo set to replace Chris Wormald as cabinet secretary.\u003C/strong\u003E The Ministry of Justice head is expected to take over the role, with sources indicating she is the preferred candidate without the need for a full recruitment process. This change is crucial as Starmer seeks to enhance Whitehall operations ahead of local elections.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ELabour MPs express mixed support for Starmer\u0026#x27;s leadership.\u003C/strong\u003E While figures like Andy Burnham and Eluned Morgan publicly back Starmer, dissent is evident with calls for his resignation from some backbenchers. The internal divisions highlight the pressures facing Starmer as he aims to unify the party and strengthen its electoral prospects.\u003C/p\u003E",
          "topics": [
            "Labour"
          ],
          "article_url": "",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4894357d8c470",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4894357d8c470",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Matthew Yglesias' via Everyone",
          "time": "11:02",
          "title": "Don’t let Elon Musk monopolize space compute",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EMusk plans merger of xAI and SpaceX, raising antitrust concerns.\u003C/strong\u003E The proposed merger aims to leverage SpaceX\u0026#x27;s dominance in the space launch industry to gain a competitive edge in AI, potentially stifling market competition. Critics argue this could lead to monopolistic control over both sectors.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ESpaceX seeks FCC approval for orbital data centers.\u003C/strong\u003E The company is pursuing a plan to establish a constellation of satellites functioning as data centers in space, which proponents believe could revolutionise energy efficiency and data processing. However, the feasibility and implications of such a venture remain contentious.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003ERegulatory calls for common-carrier requirements on SpaceX.\u003C/strong\u003E Experts suggest that Congress should impose regulations to ensure SpaceX offers non-discriminatory pricing for its launch services, preventing preferential treatment for Musk\u0026#x27;s other ventures. This approach mirrors historical regulations in telecommunications and railroads, aimed at fostering competition.\u003C/p\u003E",
          "topics": [
            "AI"
          ],
          "article_url": "https://open.substack.com/pub/matthewyglesias/p/dont-let-elon-musk-monopolize-space?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c473eea8b72107",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c473eea8b72107",
          "open_url_type": "gmail"
        },
        {
          "source": "stephen_bush",
          "sourceLabel": "STEPHEN BUSH",
          "from": "'Stephen Bush' via Everyone",
          "time": "09:35",
          "title": "Inside Politics: Anas horribilis",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EStarmer\u0026#x27;s leadership faces significant challenges ahead.\u003C/strong\u003E Labour leader Keir Starmer is under pressure as internal divisions and public dissatisfaction threaten party unity. Recent polling shows Labour\u0026#x27;s lead over the Conservatives has narrowed to just 4%.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EStarmer outlines recovery plan amid political turmoil.\u003C/strong\u003E In a bid to regain momentum, Starmer has unveiled a series of policy proposals aimed at addressing cost-of-living issues, including a £1.5bn investment in energy efficiency for homes. This move seeks to resonate with voters feeling the pinch from rising bills.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EBackbench dissent complicates Starmer\u0026#x27;s agenda.\u003C/strong\u003E A faction of Labour MPs has expressed concerns over Starmer\u0026#x27;s approach to economic policy, fearing it lacks ambition. This dissent could hinder the party\u0026#x27;s ability to present a united front ahead of the next general election.\u003C/p\u003E",
          "topics": [
            "Elections",
            "Labour"
          ],
          "article_url": "https://email.newsletters.ft.com/c/eJyMkcFq3DAQhp_GuslIM5IsHXQIlIWc2z7ASDPaNfHaW1vu0rcvhJT0mPN88_PBV6nLddv_5FWexyK9y644t-JSAyXZTpOZbLAuKbnTvLxybtgYSjDaEwTt2JIugKhlisH7ghVaVLcMzaLE4Fp0bJMNxk-tUjVI4C0iqjmDgWDAGpPQox-jNylacqlUMKHEwZlPqWNsfazbXS351vvjGPBlgMsAl-fz-XEa4PIfP-Dlw3jAb19xHiAccr3L2t9foDnTkkRdI3tNzVUtlVlPkdiUhAlCUct89FfOPhRTCKu3UqI3aIwUzw7VY9_4rD0fD9rf1J5poXVwZqGynXvfrtJvso91G883tcuvU97naMImNpDmBKBdAKOJJWrynDDZKRnx_3Dh77Lyj_n-2Qqd6vk8Zx7w5Uux-k7rQbXP2_rKOTaqsQhpYrbaYWNNZEhDtMGW5jFZVOch-89z5kzkOUowuvoatAMQncSKnrhF11ASgqjfGf4GAAD__0_0uEg",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c46e85109a0de3",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c46e85109a0de3",
          "open_url_type": "gmail"
        },
        {
          "source": "newsletter",
          "sourceLabel": "NEWSLETTER",
          "from": "LUCIDTALK POLLS AND MARKET RESEARCH",
          "time": "09:35",
          "title": "✅ LucidTalk (LT) - E-NEWSLETTER February 2026: LT's Winter26 Belfast Telegraph NI 'Tracker' Poll - All key results, + Polls news, \u0026 more.. ✅",
          "summary": "\u003Cp\u003E\u003Cstrong\u003ELucidTalk Winter 2026 poll reveals shifting political landscape in Northern Ireland.\u003C/strong\u003E The latest Belfast Telegraph-LucidTalk tracker poll shows significant changes in party support, with the UUP under new leader Jon Burrows gaining traction among unionist voters.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EJon Burrows\u0026#x27; leadership impacts UUP support.\u003C/strong\u003E Burrows\u0026#x27; ascension as UUP leader is a focal point of the poll, indicating a potential revitalisation of the party\u0026#x27;s appeal within the unionist community, which could reshape future electoral dynamics.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EKey issues identified by voters for government prioritisation.\u003C/strong\u003E The poll highlights public concerns, with respondents indicating that economic stability and healthcare should be top priorities for both the Northern Ireland and UK governments, reflecting ongoing challenges in these areas.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EPublic sentiment on the impact of the NI government over the past two years.\u003C/strong\u003E Results show a mixed perception of the NI government\u0026#x27;s effectiveness, with many respondents expressing dissatisfaction, signalling potential electoral repercussions for current officeholders.\u003C/p\u003E",
          "topics": [
            "Elections"
          ],
          "article_url": "https://www.belfasttelegraph.co.uk/topics/lucidtalk-poll-41247880/",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c46e7edb20aca3",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c46e7edb20aca3",
          "open_url_type": "gmail"
        }
      ]
    },
    {
      "key": "wed",
      "name": "Wednesday",
      "date": "11 Feb",
      "dateFull": "Wednesday 11 February 2026",
      "items": [
        {
          "source": "stephen_bush",
          "sourceLabel": "STEPHEN BUSH",
          "from": "'Stephen Bush' via Everyone",
          "time": "09:35",
          "title": "Inside Politics: Troubled waters over Doyle",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EMatthew Doyle\u0026#x27;s appointment to the Lords faces backlash.\u003C/strong\u003E Critics argue that appointing Doyle, a controversial figure, undermines the credibility of the House of Lords.\u003C/p\u003E\u003Cp\u003EThis decision could exacerbate tensions within the party and alienate key voter demographics.\u003C/p\u003E",
          "topics": [
            "General"
          ],
          "article_url": "https://email.newsletters.ft.com/c/eJyMkc9q3DAQh5_GummZGf0_6BAoCzm3fQBJM0pMvPbWlrv07QshJT3mPN_8-OBrZcjLtv_JqzyORcaQXXHu1aZOSjKGABHIESm5lXl55uyRxbXedeAk2lIIOgVBHaKtplshZ4J6zaGG5JK3HpkwAYhBiJFaQptKiazmTEAeCBGScYAXdBTEGy6-S0yeJwufUselj0vbbmrJr2Pcj8k8TXSd6Pp4PD5OE13_4ydz_TCezLevOE_kD3m5yTreX6hb6EmibpGdLt02LY1Zh1gYajKJfFXLfIxnzs5XqMU0h1KjAwMg1bE16r5vfLaRj3vZ39Sey1LWycJS6nbuY3uR8Sr7pW2X803t8uuU97mErpOg0wYrahsd64jJ6U4hQXNkUeQfLvxdVv4x3z5bAaiRz3PmyTx9KdbYy3qUNuZtfeZsqQQonjVINdpiQh1d6TrWTk04SOKozkP2n-fMuRTHUTzo5prXlkh0EhQduEfbjSRDon5n-hsAAP__iee3UA",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4c0e44d5dc89b",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4c0e44d5dc89b",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Noahpinion' via Everyone",
          "time": "09:25",
          "title": "Roundup #77: The Fix-Everything Button",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EBART sees 54% drop in crime after fare gates installed.\u003C/strong\u003E The Bay Area Rapid Transit system reports a significant reduction in crime following the installation of fare gates, which has also decreased maintenance demands on staff. This suggests that controlling fare evasion can enhance public safety and improve the experience for regular commuters.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EAI\u0026#x27;s impact on job market shows mixed signals for young graduates.\u003C/strong\u003E Recent analysis indicates that while college-educated unemployment is unexpectedly high at 4.4%, employment rates for recent graduates remain stable, suggesting they continue to seek work despite challenges. This discrepancy highlights the complexities of interpreting job market data amid rising automation.\u003C/p\u003E",
          "topics": [
            "AI"
          ],
          "article_url": "https://open.substack.com/pub/noahpinion/p/roundup-77-the-fix-everything-button?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4c082567fdb03",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4c082567fdb03",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "'Comment is Freed' via Everyone",
          "time": "09:21",
          "title": "Is Ukraine's position improving? What's Russia's breaking point? Is House of Dynamite accurate?",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EUkrainian forces show signs of resilience amid Russian setbacks.\u003C/strong\u003E Reports indicate a slowdown in Russian military activity, with Ukrainian sources claiming Russia struggles to replace losses, particularly in key areas like Kupiansk and Pokrovsk. Commander-in-chief Syrskyi notes that Ukrainian forces are on the offensive in about 25% of engagements along a 1,200-kilometre front line.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EPutin\u0026#x27;s war strategy faces scrutiny as losses mount.\u003C/strong\u003E Analysts question Putin\u0026#x27;s rationale for continuing the conflict despite significant troop losses, estimated at 1,000 to 1,100 daily. The Kremlin\u0026#x27;s narrative of inevitable victory is increasingly challenged, raising concerns about its internal understanding of the war\u0026#x27;s progress.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EPotential shifts in the conflict dynamics could alter negotiations.\u003C/strong\u003E A successful Ukrainian counter-offensive could change the perception of the war, potentially pressuring Russia to reconsider its stance on ceasefire negotiations. However, any major offensive is likely to be approached cautiously, given past challenges and the current transparency of the battlefield.\u003C/p\u003E",
          "topics": [
            "Foreign Policy"
          ],
          "article_url": "https://open.substack.com/pub/samf/p/is-ukraines-position-improving-whats?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4c0243fb4851a",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4c0243fb4851a",
          "open_url_type": "gmail"
        },
        {
          "source": "politico",
          "sourceLabel": "POLITICO",
          "from": "POLITICO Europe",
          "time": "08:20",
          "title": "The POLITICO Poll: Majority of UK voters think Keir Starmer should resign",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EMajority of UK voters believe Keir Starmer should resign.\u003C/strong\u003E A POLITICO poll reveals that 51% of voters think Starmer should step down, with nearly 25% of Labour supporters preferring a different leader.\u003C/p\u003E\u003Cp\u003EThis sentiment could undermine Starmer\u0026#x27;s leadership ahead of the next general election.\u003C/p\u003E",
          "topics": [
            "Elections",
            "Labour"
          ],
          "article_url": "https://www.politico.eu/article/keir-starmer-resign-jeffrey-epstein-peter-mandelson-politico-poll-majority-uk-voters/?utm_source=email\u0026amp;utm_medium=alert\u0026amp;utm_campaign=The%20POLITICO%20Poll%3A%20Majority%20of%20UK%20voters%20think%20Keir%20Starmer%20should%20resign",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4bc95a8a9015a",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4bc95a8a9015a",
          "open_url_type": "gmail"
        },
        {
          "source": "substack",
          "sourceLabel": "SUBSTACK",
          "from": "Rob Ford from The Swingometer",
          "time": "07:30",
          "title": "Waka waka waka",
          "summary": "\u003Cp\u003E\u003Cstrong\u003EDebate on MP defections intensifies with petition for by-elections.\u003C/strong\u003E A petition advocating for automatic by-elections when MPs switch parties has surpassed 100,000 signatures and will be debated in Parliament. This reflects growing public concern over accountability in light of recent defections.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EFarage\u0026#x27;s stance on party switching highlights hypocrisy in politics.\u003C/strong\u003E Nigel Farage, who previously condemned party-switching as dishonourable, has not insisted on by-elections for recent defectors to Reform UK, illustrating a shift in his position. This inconsistency raises questions about the integrity of party loyalty among MPs.\u003C/p\u003E\u003Cp\u003E\u003Cstrong\u003EHistorical context shows rarity of by-elections for defections.\u003C/strong\u003E Since 1979, only three MPs have resigned to contest by-elections after changing parties, indicating a long-standing trend of MPs remaining in their seats despite party changes. This practice suggests that the party label, while significant, may not be as critical to voters as previously thought.\u003C/p\u003E",
          "topics": [
            "Reform"
          ],
          "article_url": "https://open.substack.com/pub/swingometer/p/waka-waka-waka?utm_source=email\u0026redirect=app-store\u0026utm_campaign=email-read-in-app",
          "gmail_link": "https://mail.google.com/mail/u/0/#all/19c4b9c323f12872",
          "open_url": "https://mail.google.com/mail/u/0/#all/19c4b9c323f12872",
          "open_url_type": "gmail"
        }
      ]
    },
    {
      "key": "thu",
      "name": "Thursday",
      "date": "12 Feb",
      "dateFull": "Thursday 12 February 2026",
      "items": []
    },
    {
      "key": "fri",
      "name": "Friday",
      "date": "13 Feb",
      "dateFull": "Friday 13 February 2026",
      "items": []
    }
  ]
};

// Determine today's tab
const UI_ASSETS = {
  faceSrc: './assets/calum-face.jpg'
};

	const STORAGE_KEYS = {
	  theme: 'cwDigest.theme',
	  sortMode: 'cwDigest.sortMode',
	  searchVisible: 'cwDigest.searchVisibleV2',
	  uiDensity: 'cwDigest.uiDensity',
	  viewMode: 'cwDigest.viewModeV1',
	  readMap: 'cwDigest.readMapV1',
	  savedMap: 'cwDigest.savedMapV1',
	  mutedSenders: 'cwDigest.mutedSendersV1',
	  mutedSources: 'cwDigest.mutedSourcesV1',
	  lastRefreshAt: 'cwDigest.lastRefreshAtV1'
	};

const SOURCE_CLASSES = new Set(['politico', 'substack', 'stephen_bush', 'newsletter', 'alert']);

	const DOM = {
	  utilityShell: document.querySelector('.utility-shell'),
	  utilityBar: document.querySelector('.utility-bar'),
	  tabs: document.getElementById('dayTabs'),
	  content: document.getElementById('contentMount'),
	  searchInput: document.getElementById('searchInput'),
	  clearSearchBtn: document.getElementById('clearSearch'),
	  searchToggleBtn: document.getElementById('searchToggle'),
	  refreshBtn: document.getElementById('refreshDigest'),
	  refreshMeta: document.getElementById('refreshMeta'),
	  themeBtn: document.getElementById('themeToggle'),
	  sortBtn: document.getElementById('sortToggle'),
	  viewToggle: document.getElementById('viewToggle'),
	  archiveSelect: document.getElementById('archiveSelect'),
	  topicHeat: document.getElementById('topicHeat'),
	  resultsBanner: document.getElementById('resultsBanner'),
	  filtersMeta: document.getElementById('activeFilters'),
	  clearFilters: document.getElementById('clearFilters'),
	  muteManager: document.getElementById('muteManager'),
	  muteCount: document.getElementById('muteCount'),
	  mutedSenders: document.getElementById('mutedSenders'),
	  mutedSources: document.getElementById('mutedSources'),
	  clearMutes: document.getElementById('clearMutes'),
	  progressBar: document.getElementById('progressBar'),
	  faceWidget: document.getElementById('faceWidget'),
	  faceImage: document.getElementById('faceImage'),
	  weekLabel: document.querySelector('.week-label'),
	  eggToast: document.getElementById('eggToast'),
	  cardMenu: document.getElementById('cardMenu'),
	  shortcutsOverlay: document.getElementById('shortcutsOverlay'),
	  shortcutsClose: document.getElementById('shortcutsClose'),
	  cmdPalette: document.getElementById('cmdPalette'),
	  cmdPaletteInput: document.getElementById('cmdPaletteInput'),
	  cmdPaletteResults: document.getElementById('cmdPaletteResults'),
	  dailyQuote: document.getElementById('dailyQuote'),
	  whipPanel: document.getElementById('whipPanel'),
	  orderPanel: document.getElementById('orderPanel'),
	  dispatchOverlay: document.getElementById('dispatchOverlay'),
	  dispatchGrid: document.getElementById('dispatchGrid'),
	  dispatchClose: document.getElementById('dispatchClose'),
	  blackrodOverlay: document.getElementById('blackrodOverlay'),
	  blackrodMeta: document.getElementById('blackrodMeta'),
	  blackrodSender: document.getElementById('blackrodSender'),
	  blackrodTime: document.getElementById('blackrodTime'),
	  blackrodTitle: document.getElementById('blackrodTitle'),
	  blackrodStatus: document.getElementById('blackrodStatus'),
	  blackrodSummary: document.getElementById('blackrodSummary'),
	  blackrodTopics: document.getElementById('blackrodTopics'),
	  blackrodLink: document.getElementById('blackrodLink'),
	  blackrodClose: document.getElementById('blackrodClose'),
	  prorogueOverlay: document.getElementById('prorogueOverlay'),
	  mainContent: document.getElementById('mainContent'),
	  weatherLine: document.getElementById('weatherLine'),
	  quickLinks: document.getElementById('quickLinks'),
	  todoPanel: document.getElementById('todoPanel'),
	  todoPanelList: document.getElementById('todoPanelList'),
	  todoPanelCount: document.getElementById('todoPanelCount'),
	  todoPanelInput: document.getElementById('todoPanelInput'),
	  todoPanelCollapse: document.getElementById('todoPanelCollapse'),
	  todoToggleTab: document.getElementById('todoToggleTab')
	};

const CURRENT_WEEK_LABEL = (DOM.weekLabel?.textContent || 'Current Week').trim();
const POLLSTER_MODE_KEY_SEQUENCE = ['m', 'r', 'p'];
const POLLSTER_MODE_TIMEOUT_MS = 1800;
const FACE_OVERDRIVE_CLICKS = 5;
const FACE_OVERDRIVE_WINDOW_MS = 2500;
const FACE_OVERDRIVE_DURATION_MS = 6000;
const WEEK_LABEL_HOVERS = 3;
const WEEK_LABEL_WINDOW_MS = 5000;
const WEEK_LABEL_GAG_MS = 2400;
const WEEK_LABEL_GAG_TEXT = 'Fieldwork complete · MoE ±3.0 (ish)';
const STALE_REFRESH_MS = 12 * 60 * 60 * 1000;

const DISPATCH_KEY_SEQUENCE = ['p', 'm', 'q'];
const DISPATCH_TIMEOUT_MS = 1800;

const KONAMI_SEQUENCE = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
const KONAMI_TIMEOUT_MS = 3000;

const RESIGN_KEY_SEQUENCE = ['r','e','s','i','g','n'];
const RESIGN_TIMEOUT_MS = 3000;

const HANSARD_QUOTES = [
  // Classic
  { text: 'All political lives end in failure.', attr: 'Enoch Powell' },
  { text: 'A week is a long time in politics.', attr: 'Harold Wilson' },
  { text: 'Events, dear boy, events.', attr: 'Harold Macmillan' },
  { text: 'Education, education, education.', attr: 'Tony Blair' },
  { text: 'We are the masters now.', attr: 'Hartley Shawcross' },
  { text: 'In victory, magnanimity.', attr: 'Winston Churchill' },
  { text: 'The white heat of technology.', attr: 'Harold Wilson' },
  { text: 'I have nothing to offer but blood, toil, tears and sweat.', attr: 'Winston Churchill' },
  { text: 'The NHS will last as long as there are folk left with faith to fight for it.', attr: 'Aneurin Bevan' },
  { text: 'We know what happens to people who stay in the middle of the road. They get run over!', attr: 'Aneurin Bevan' },
  { text: 'Democracy means government by discussion, but it is only effective if you can stop people talking.', attr: 'Clement Attlee' },
  { text: 'Power without principle is barren, but principle without power is futile.', attr: 'Tony Blair' },
  { text: 'Things can only get better.', attr: 'D:Ream, 1997' },
  { text: 'The price of greatness is responsibility.', attr: 'Winston Churchill' },
  { text: 'You\u2019ve never had it so good.', attr: 'Harold Macmillan' },
  { text: 'The ship of state is the only ship that leaks from the top.', attr: 'James Reston' },
  { text: 'All I say is, if you cannot ride two horses you have no right in the circus.', attr: 'James Maxton' },
  { text: 'If voting changed anything, they\u2019d abolish it.', attr: 'Ken Livingstone' },
  { text: 'Come, friendly bombs, and fall on Slough. It isn\u2019t fit for humans now.', attr: 'John Betjeman' },
  { text: 'Bugger Bognor.', attr: 'George V, alleged last words' },
  // Putdowns
  { text: 'Being attacked by Geoffrey Howe is like being savaged by a dead sheep.', attr: 'Denis Healey' },
  { text: 'He was the future once.', attr: 'David Cameron on Tony Blair' },
  { text: 'The Honourable Member is living proof that a pig\u2019s bladder on a stick can be elected to Parliament.', attr: 'Tony Banks' },
  { text: 'A shiver looking for a spine to run up.', attr: 'Harold Wilson on Edward Heath' },
  { text: 'A modest man who has much to be modest about.', attr: 'Winston Churchill on Clement Attlee' },
  { text: 'He occasionally stumbled over the truth, but hastily picked himself up and hurried on as if nothing had happened.', attr: 'Winston Churchill on Stanley Baldwin' },
  { text: 'He has something of the night about him.', attr: 'Ann Widdecombe on Michael Howard' },
  { text: 'I wouldn\u2019t say she is open-minded on the Middle East so much as empty-headed.', attr: 'Jonathan Aitken on Margaret Thatcher' },
  { text: 'Weak, weak, weak!', attr: 'Tony Blair on John Major, PMQs' },
  { text: 'I may be drunk, but you are ugly, and in the morning I shall be sober.', attr: 'Winston Churchill' },
  { text: 'I warn you there are going to be howls of anguish from those rich enough to pay over 75% on the last slice of their income.', attr: 'Denis Healey' },
  // Gaffes
  { text: 'That bigoted woman.', attr: 'Gordon Brown, live mic, 2010' },
  { text: 'Crisis? What crisis?', attr: 'The Sun, 1979' },
  { text: 'Nothing has changed! Nothing has changed!', attr: 'Theresa May, 2017' },
  { text: 'Brexit means Brexit.', attr: 'Theresa May' },
  { text: 'Strong and stable.', attr: 'Theresa May, 2017' },
  { text: 'I\u2019m a pretty straight sort of guy.', attr: 'Tony Blair, 1997' },
  { text: 'I did have a large number of meetings that I forgot about.', attr: 'Keith Vaz, 2016' },
  { text: 'The pound in your pocket has not been devalued.', attr: 'Harold Wilson, 1967' },
  { text: 'I\u2019m afraid there is no money. Kind regards and good luck.', attr: 'Liam Byrne, note to his successor, 2010' },
  { text: 'We got all the big calls right.', attr: 'Boris Johnson' },
  { text: 'I went to Peppa Pig World. It was very much my kind of place.', attr: 'Boris Johnson, CBI speech, 2021' },
  { text: 'Fuck business.', attr: 'Boris Johnson, 2018' },
  { text: 'Calm down, dear.', attr: 'David Cameron to Angela Eagle, PMQs, 2011' },
  { text: 'Hell, yes, I\u2019m tough enough.', attr: 'Ed Miliband, 2015' },
  { text: 'Am I bovvered?', attr: 'Catherine Tate to Tony Blair (and vice versa), Comic Relief, 2007' },
  { text: 'I\u2019ll eat my hat on live television.', attr: 'Paddy Ashdown, election night 1992' },
  { text: 'Omnishambles.', attr: 'Ed Miliband on the 2012 Budget' },
  { text: 'Back me or sack me.', attr: 'John Major, 1995' },
  { text: 'We\u2019re all in this together.', attr: 'George Osborne' },
  { text: 'I\u2019m enjoying this.', attr: 'Theresa May, 2017 election campaign' },
  { text: 'People in this country have had enough of experts.', attr: 'Michael Gove, 2016' },
  { text: 'Do you know who I am? I\u2019m the Chief Whip and I\u2019m telling you, you\u2019re fucking plebs.', attr: 'Andrew Mitchell, Plebgate, 2012' },
  { text: 'Get Brexit done.', attr: 'Boris Johnson, 2019' },
  { text: 'An oven-ready deal.', attr: 'Boris Johnson, 2019' },
  { text: 'We will make Brexit a titanic success.', attr: 'Boris Johnson' },
  { text: 'My policy on cake is pro having it and pro eating it.', attr: 'Boris Johnson' },
  { text: 'I\u2019m passionately in favour of foxhunting, and if it were up to me, I\u2019d have it going on in the streets of London.', attr: 'Boris Johnson' },
  { text: 'What larks!', attr: 'Boris Johnson' },
  { text: 'Piffle.', attr: 'Boris Johnson' },
  { text: 'My friends, as I have discovered myself, there are no disasters, only opportunities. And indeed, opportunities for fresh disasters.', attr: 'Boris Johnson' },
  { text: 'If anybody is suggesting I set up Tory donors with privileged access to me, that is simply not the case.', attr: 'David Cameron, 2021' },
  { text: 'Tough on crime, tough on the causes of crime.', attr: 'Tony Blair' },
  // Liz Truss
  { text: 'I was making my own cheese.', attr: 'Liz Truss' },
  { text: 'We will grow the economy, we will grow the economy, we will grow the economy.', attr: 'Liz Truss, conference speech, 2022' },
  { text: 'I\u2019m a fighter, not a quitter.', attr: 'Liz Truss, six days before resigning' },
  { text: 'We import two thirds of our cheese. That is a disgrace.', attr: 'Liz Truss, 2014 conference speech' },
  { text: 'In Beijing they are eating British pork pies. I think that\u2019s a tremendous thing.', attr: 'Liz Truss' },
  // Bercow
  { text: 'Order! ORDERRR!', attr: 'John Bercow' },
  { text: 'The Right Honourable Gentleman is chuntering from a sedentary position.', attr: 'John Bercow' },
  { text: 'I require no assistance from the Honourable Gentleman. He can gesticulate to his heart\u2019s content from a sedentary position.', attr: 'John Bercow' },
  // Skinner
  { text: 'The only good Tory is a lavatory.', attr: 'Dennis Skinner' },
  { text: 'Tarmac it. We could use another runway.', attr: 'Dennis Skinner on the House of Lords' },
  // Prescott
  { text: 'He has the energy to win people over to Labour. And he scares the life out of the Tories... and me. That\'s not in the script.', attr: 'John Prescott on Tony Blair, 1994' },
  { text: 'This will be an election about Labour\'s values as we move towards the 20th century.', attr: 'John Prescott on the 1994 Labour leadership campaign, 1994' },
  { text: 'Here we have a government disintegrating between our eyes.', attr: 'John Prescott on John Major, 1997' },
  { text: 'It\'s great to be back on terra cotta.', attr: 'John Prescott on being safe after a stormy flight, 1999' },
  { text: 'I would like to have put my foot in his bloody throat.', attr: 'John Prescott on having iced water thrown over him, 1998' },
  { text: 'The Green Belt is a Labour achievement and we intend to build on it.', attr: 'John Prescott on the environment, 1998' },
  { text: 'Any definition of homelessness that suggests that people haven\'t got a home is not good.', attr: 'John Prescott on housing, 2004' },
  { text: 'They [rail companies] only get a contract for six or seven years. All I\'ll be doing is taking the contracts back. So make no mistake about it, it\'ll be coming back to a publicly owned network.', attr: 'John Prescott on transport, 1995' },
  { text: 'I\'m asking you, if I give you these facts, you are supposed to give some factual analysis to it. I mean, you are not denying that these facts are wrong, are you?', attr: 'John Prescott on political commentators, 2002' },
  { text: 'Women do like their men to be a bit aggressive, don\'t they?', attr: 'John Prescott on his appeal among voters, 2006' },
  { text: 'She said: \'My God, can I go and buy that Brueghel print at WH Smith\'s?\' I said: \'You can buy the original on the money that comes out of Europe\'', attr: 'John Prescott on telling his wife he\'d been offered the job of European Commissioner, 1989' },
  { text: 'They are gnats on an elephant\'s backside.', attr: 'John Prescott on Labour\'s spin doctors, 1997' },
  { text: 'It\'s not the sanity [sic] of picket lines that bothers me, it\'s the sanity [sic] of human life.', attr: 'John Prescott on the sanctity of the picket line, 2002' },
  { text: 'I can get on a platform with thousands of people there and I defy anyone to shout me down. Yet I won\'t go into a restaurant unless there\'s a table booked. I\'m afraid of rejection.', attr: 'John Prescott on himself, 1993' },
  { text: 'I still love them - one of my favourites. I can eat them for ever.', attr: 'John Prescott on Marks & Spencer trifles, 2008' },
  // Real quotes that sound fictional
  { text: 'Economical with the actualit\u00e9.', attr: 'Alan Clark' },
  { text: 'If you open that Pandora\u2019s box, you never know what Trojan horses will jump out.', attr: 'Ernest Bevin' },
  { text: 'You might very well think that. I couldn\u2019t possibly comment.', attr: 'Francis Urquhart, House of Cards' },
  // More attributed
  { text: 'I am not prepared to go about the country stirring up apathy.', attr: 'William Whitelaw' },
  { text: 'The Right Honourable Gentleman has sat on the fence so long that the iron has entered his soul.', attr: 'David Lloyd George' },
  { text: 'Don\u2019t talk to me about naval tradition. It\u2019s nothing but rum, sodomy and the lash.', attr: 'Winston Churchill' },
  { text: 'A sheep in sheep\u2019s clothing.', attr: 'Winston Churchill on Clement Attlee' },
  { text: 'An empty taxi arrived at 10 Downing Street, and when the door was opened, Attlee got out.', attr: 'Winston Churchill' },
  { text: 'There but for the grace of God, goes God.', attr: 'Winston Churchill on Stafford Cripps' },
  { text: 'Nor shall we flag or fail. We shall go on to the end.', attr: 'Winston Churchill, 1940' },
  { text: 'Madam, if you were my wife, I\u2019d drink it.', attr: 'Winston Churchill to Lady Astor' },
  { text: 'The Labour Party is going about the country stirring up complacency.', attr: 'William Whitelaw' },
  { text: 'If I\u2019m here for five years, I\u2019ll have been here for far too long.', attr: 'Gordon Brown, 2007' },
  { text: 'This is the day I was meant not to be Prime Minister.', attr: 'Theresa May, on her last day, 2019' },
  { text: 'Hasta la vista, baby.', attr: 'Boris Johnson, final PMQs, 2022' },
  { text: 'History will be kind to me, for I intend to write it.', attr: 'Winston Churchill' },
  { text: 'The Right Honourable Gentleman is reminiscent of a poker. The only difference is that a poker gives off occasional signs of warmth.', attr: 'Benjamin Disraeli on Robert Peel' },
  { text: 'He is a self-made man and worships his creator.', attr: 'Benjamin Disraeli on John Bright' },
  { text: 'If Gladstone fell into the Thames, that would be a misfortune. If anybody pulled him out, that would be a calamity.', attr: 'Benjamin Disraeli' },
  { text: 'He has not a single redeeming defect.', attr: 'Benjamin Disraeli on William Gladstone' },
  { text: 'Mr Gladstone speaks to me as if I were a public meeting.', attr: 'Queen Victoria' },
  { text: 'I could not dig. I dared not rob. Therefore I lied to please the mob.', attr: 'Rudyard Kipling' },
  // Gladstone & Disraeli era
  { text: 'He made his conscience not his guide but his accomplice.', attr: 'Benjamin Disraeli on Gladstone' },
  { text: 'A sophistical rhetorician, inebriated with the exuberance of his own verbosity.', attr: 'Benjamin Disraeli on Gladstone' },
  { text: 'A fully equipped duke costs as much to keep up as two Dreadnoughts, and dukes are just as great a terror, and they last longer.', attr: 'David Lloyd George' },
  { text: 'The House of Lords is not the watchdog of the constitution. It is Mr Balfour\u2019s poodle.', attr: 'David Lloyd George' },
  // Labour movement
  { text: 'The Labour Party is a moral crusade or it is nothing.', attr: 'Harold Wilson' },
  { text: 'If we can find money to kill people, we can find money to help people.', attr: 'Tony Benn' },
  { text: 'I did not enter the Labour Party forty-seven years ago to have our manifesto written by Dr Mori, Dr Gallup and Mr Harris.', attr: 'Tony Benn, 1997' },
  { text: 'Why am I the first Kinnock in a thousand generations to be able to get to university?', attr: 'Neil Kinnock, 1987' },
  { text: 'I warn you not to be ordinary. I warn you not to be young. I warn you not to fall ill. I warn you not to get old.', attr: 'Neil Kinnock, 1983' },
  { text: 'From the cradle to the grave.', attr: 'Beveridge Report, adopted by Attlee\u2019s government, 1942' },
  // Bevan
  { text: 'This island is made mainly of coal and surrounded by fish. Only an organising genius could produce a shortage of coal and fish at the same time.', attr: 'Aneurin Bevan' },
  { text: 'No amount of cajolery, and no attempts at ethical or social seduction, can eradicate from my heart a deep burning hatred for the Tory Party.', attr: 'Aneurin Bevan' },
  { text: 'I read the newspapers avidly. It is my one form of continuous fiction.', attr: 'Aneurin Bevan' },
  { text: 'The purpose of getting power is to be able to give it away.', attr: 'Aneurin Bevan' },
  // Attlee
  { text: 'A period of silence on your part would be welcome.', attr: 'Clement Attlee' },
  { text: 'Charity is a cold grey loveless thing. If a rich man wants to help the poor, he should pay his taxes gladly, not dole out money at a whim.', attr: 'Clement Attlee' },
  { text: 'Few thought he was even a starter. There were many who thought themselves smarter. But he ended PM, CH and OM, an earl and a knight of the garter.', attr: 'Clement Attlee, on himself' },
  // Healey
  { text: 'Healey\u2019s first law of holes: when in one, stop digging.', attr: 'Denis Healey' },
  { text: 'Her Foreign Secretary, Lord Carrington, has been bamboozled by the Argentinians. It turns out he is even more stupid than I thought, and I thought he was pretty stupid.', attr: 'Denis Healey' },
  // Major, Brown, Blair
  { text: 'When your back\u2019s against the wall, it\u2019s time to turn round and fight.', attr: 'John Major' },
  { text: 'It is time to get back to basics: to self-discipline and respect for the law, to consideration for others, to accepting responsibility for yourself and your family.', attr: 'John Major, 1993. Several of his Cabinet were then caught having affairs.' },
  { text: 'We\u2019re alright! We\u2019re alright!', attr: 'Neil Kinnock, Sheffield rally, 1992' },
  { text: 'The British disease is not one of the body but of the soul.', attr: 'Gordon Brown' },
  { text: 'Not flash, just Gordon.', attr: 'Gordon Brown campaign slogan, 2007' },
  { text: 'British jobs for British workers.', attr: 'Gordon Brown, 2007. Borrowed, ironically, from the BNP.' },
  { text: 'I don\u2019t think it\u2019s possible to do this job and come out of it as the same person.', attr: 'Tony Blair' },
  { text: 'I can only go one way. I\u2019ve not got a reverse gear.', attr: 'Tony Blair, conference speech, 2003' },
  { text: 'Ask me my three main priorities for government and I tell you: education, education, education.', attr: 'Tony Blair, 1996' },
  // Modern
  { text: 'I\u2019m a Yorkshireman. We don\u2019t say what we don\u2019t mean.', attr: 'William Hague' },
  { text: 'I drank fourteen pints of beer a day.', attr: 'William Hague' },
  { text: 'If we don\u2019t take action now, we will settle for a world where a few people do very well whilst the many stay stuck.', attr: 'Ed Miliband' },
  { text: 'These strikes are wrong. The negotiations were going on.', attr: 'Ed Miliband, repeated seven times in one interview, 2011' },
  { text: 'The chaos with Ed Miliband.', attr: 'David Cameron, 2015. Became a meme.' },
  { text: 'We don\u2019t do God.', attr: 'Alastair Campbell, cutting short a Blair interview, 2003' },
  // Misc
  { text: 'The trouble with Twitter, the instantness of it – too many twits might make a twat.', attr: 'David Cameron, 2009' },
  { text: 'It is not necessary that every time he rises he should give his famous imitation of a semi-house-trained polecat.', attr: 'Michael Foot on Norman Tebbit, 1978' },
  { text: 'Greater love hath no man than this, that he lay down his friends for his life.', attr: 'Jeremy Thorpe on Harold Macmillan, 1962' },
  { text: 'The longest suicide note in history.', attr: 'Gerald Kaufman on Labour’s 1983 manifesto' },
  { text: 'You have sat too long here for any good you have been doing. Depart, I say, and let us have done with you. In the name of God, go!', attr: 'Leo Amery to Neville Chamberlain, 1940 (quoting Oliver Cromwell)' },
  { text: 'As far as I can see, he was, in a sense, ambushed with a cake.', attr: 'Conor Burns on Boris Johnson, 2022' },
  { text: 'Half the Tory members opposite are crooks. Okay, half the Tory members opposite aren’t crooks.', attr: 'Dennis Skinner' },
  { text: 'Sit down, man. You\u2019re a bloody tragedy.', attr: 'James Maxton to Ramsay MacDonald' },
  { text: 'The language of priorities is the religion of socialism.', attr: 'Aneurin Bevan, 1949' },
  { text: 'If Margaret Thatcher wins on Thursday, I warn you not to be ordinary. I warn you not to be young.', attr: 'Neil Kinnock, Bridgend, 1983' },
  { text: 'You can\u2019t play politics with people\u2019s jobs and people\u2019s services.', attr: 'Neil Kinnock, 1985' },
  { text: 'The opportunity to serve our country. That is all we ask.', attr: 'John Smith, 1994. Smith died the following morning.' },
  { text: 'The settled will of the Scottish people.', attr: 'John Smith on devolution' },
  { text: 'A new Labour. A new Britain.', attr: 'Tony Blair, 1994' },
  { text: 'This is not the time for soundbites. I can feel the hand of history upon our shoulders.', attr: 'Tony Blair, Good Friday Agreement, 1998' }
];

const LOBBY_HEADLINES = [
  'Minister denies having read own policy document',
  'Unnamed source briefed against unnamed source',
  'Backbencher tables EDM calling for more EDMs',
  'Think-tank publishes report calling for more think-tanks',
  'Senior figure says thing they already said publicly',
  'BREAKING: Reshuffle rumours based on seating arrangement at dinner',
  'Shadow minister vows to hold government to account at some point',
  'Leaked memo reveals existence of other memos',
  'PM\u2019s spokesperson says PM is focused on the issues that matter',
  'Former adviser writes memoir saying they were right all along',
  'Cross-party group agrees on need for more cross-party groups',
  'SpAd tweets thread that could have been an email',
  'Backbencher threatens rebellion, backs down at division',
  'Poll of polls suggests polls are roughly correct',
  'Minister confident despite being visibly not confident',
  'Select committee publishes report nobody will read',
  'Government source describes situation as \u201cchallenging but manageable\u201d',
  'Opposition calls for inquiry into lack of inquiries',
  'Veteran MP shares anecdote from the 1990s again',
  'Westminster bubble debates whether Westminster bubble exists'
];

	const STATE = {
	  activeDayKey: getTodayKey(),
	  query: '',
	  activeTopic: null,
	  viewMode: localStorage.getItem(STORAGE_KEYS.viewMode) || 'all',
	  sortMode: localStorage.getItem(STORAGE_KEYS.sortMode) || 'newest',
	  searchVisible: localStorage.getItem(STORAGE_KEYS.searchVisible) === 'true',
	  theme: localStorage.getItem(STORAGE_KEYS.theme) || 'system',
	  currentWeekLabel: CURRENT_WEEK_LABEL,
	  activeArchiveWeekId: null,
	  pollsterMode: false,
	  readMap: {},
	  savedMap: {},
	  mutedSenders: new Set(),
	  mutedSources: new Set(),
	  lastRefreshAt: 0,
	  serverHealthy: false,
	  focusedItemKey: null,
	  visibleItemKeys: [],
	  dataView: DATA,
	  weekIndex: [],
	  topicCounts: [],
	  archiveWeeks: []
	};

let eggToastTimer = null;
let pollsterKeyBuffer = [];
let pollsterKeyLastTs = 0;
let faceClickBuffer = [];
let faceOverdriveTimer = null;
let faceSpinning = false;
let weekHoverBuffer = [];
let weekHoverTriggered = false;
let dispatchKeyBuffer = [];
let dispatchKeyLastTs = 0;
let konamiKeyBuffer = [];
let konamiKeyLastTs = 0;
let resignKeyBuffer = [];
let resignKeyLastTs = 0;
let resignTimer = null;
let whipPanelOpen = false;
let orderPanelOpen = false;
let blackrodOpen = false;
let dispatchOpen = false;
let lobbyModeTimer = null;
let divisionBellLastHour = -1;
let idleTimer = null;
let prorogued = false;
const IDLE_TIMEOUT_MS = 300000;
let touchStartX = 0;
let touchStartY = 0;
let weekLabelGagTimer = null;
let weekLabelSpoofActive = false;
let weekLabelBaseText = CURRENT_WEEK_LABEL;
let suppressUrlWrites = false;
let activeMenuItemKey = null;
let activeMenuAnchorRect = null;
let shortcutsOpen = false;
let cmdPaletteOpen = false;
let paletteActiveIdx = 0;
let paletteAllItems = [];
let paletteVisibleItems = [];
let paletteRestoreFocusEl = null;

function getTodayKey() {
  const now = new Date();
  const dayMap = { 6: 'sat', 0: 'sun', 1: 'mon', 2: 'tue', 3: 'wed', 4: 'thu', 5: 'fri' };
  return dayMap[now.getDay()] || 'thu';
}

function escapeHtml(value) {
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function escapeRegExp(value) {
  return String(value).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function cssEscape(value) {
  try {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(String(value));
    }
  } catch (_error) {
    // Fall back below.
  }
  return String(value).replace(/["\\]/g, '\\$&');
}

function normalizeViewMode(mode) {
  return mode === 'unread' || mode === 'saved' ? mode : 'all';
}

function loadJson(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    const parsed = JSON.parse(raw);
    return parsed ?? fallback;
  } catch (_error) {
    return fallback;
  }
}

function saveJson(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (_error) {
    // Ignore quota / private browsing failures.
  }
}

function extractGmailMessageId(url) {
  const match = String(url || '').match(/#all\/([^/?#]+)/);
  return match ? match[1] : '';
}

function normalizeSenderKey(fromValue) {
  return String(fromValue || '')
    .replace(/^['"]+|['"]+$/g, '')
    .replace(/\s+/g, ' ')
    .trim()
    .toLowerCase();
}

function getItemKey(item) {
  const gmailId = extractGmailMessageId(item.gmail_link) || extractGmailMessageId(item.open_url);
  if (gmailId) return `gmail:${gmailId}`;
  const seed = `${item.source || ''}|${item.from || ''}|${item.title || ''}|${item.time || ''}|${item.dayDateFull || item.dayDate || ''}`;
  return `fallback:${hashString(seed)}`;
}

function formatRelativeTime(epochMs) {
  const ts = Number(epochMs || 0);
  if (!ts) return 'never';
  const delta = Date.now() - ts;
  if (delta < 0) return 'just now';
  const mins = Math.round(delta / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.round(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.round(hours / 24);
  return `${days}d ago`;
}

function showEggToast(message, durationMs = 1800) {
  if (!DOM.eggToast || !message) return;
  if (eggToastTimer) {
    clearTimeout(eggToastTimer);
    eggToastTimer = null;
  }

  DOM.eggToast.textContent = message;
  DOM.eggToast.hidden = false;
  DOM.eggToast.classList.add('show');

  eggToastTimer = setTimeout(() => {
    DOM.eggToast.classList.remove('show');
    setTimeout(() => {
      if (DOM.eggToast && !DOM.eggToast.classList.contains('show')) {
        DOM.eggToast.hidden = true;
      }
    }, 180);
    eggToastTimer = null;
  }, Math.max(600, durationMs));
}

function hashString(value) {
  let hash = 2166136261;
  const text = String(value || '');
  for (let i = 0; i < text.length; i += 1) {
    hash ^= text.charCodeAt(i);
    hash = Math.imul(hash, 16777619);
  }
  return hash >>> 0;
}

function pollReadProbability(item) {
  const seed = `${item.title || ''}|${item.source || ''}|${item.dayKey || ''}`;
  return 51 + (hashString(seed) % 39);
}

function pollWeightingEfficiency(item) {
  const seed = `${item.from || ''}|${item.time || ''}|${item.title || ''}`;
  const raw = 83 + ((hashString(seed) % 151) / 10);
  return raw.toFixed(1);
}

function togglePollsterMode() {
  STATE.pollsterMode = !STATE.pollsterMode;
  document.body.classList.toggle('pollster-mode', STATE.pollsterMode);
  showEggToast(
    STATE.pollsterMode
      ? 'Model run complete. n=2,052 (weighted).'
      : 'Model archived. Back to raw feed.'
  );
  renderContent();
}

function handlePollsterModeSequence(key, isTyping) {
  if (isTyping || !key || key.length !== 1 || !/[a-z]/i.test(key)) return false;
  const now = Date.now();
  if (now - pollsterKeyLastTs > POLLSTER_MODE_TIMEOUT_MS) {
    pollsterKeyBuffer = [];
  }
  pollsterKeyLastTs = now;
  pollsterKeyBuffer.push(key.toLowerCase());
  if (pollsterKeyBuffer.length > POLLSTER_MODE_KEY_SEQUENCE.length) {
    pollsterKeyBuffer = pollsterKeyBuffer.slice(-POLLSTER_MODE_KEY_SEQUENCE.length);
  }
  const buffer = pollsterKeyBuffer.join('');
  const target = POLLSTER_MODE_KEY_SEQUENCE.join('');
  if (!target.startsWith(buffer)) {
    pollsterKeyBuffer = [];
    return false;
  }
  if (buffer === target) {
    pollsterKeyBuffer = [];
    togglePollsterMode();
    return true;
  }
  return false;
}

function triggerFaceOverdrive() {
  showEggToast('Spinner now weighted by political attention.');
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

  DOM.faceWidget.classList.remove('face-spinning');
  DOM.faceWidget.classList.add('face-overdrive');
  faceSpinning = true;
  if (faceOverdriveTimer) clearTimeout(faceOverdriveTimer);
  faceOverdriveTimer = setTimeout(() => {
    DOM.faceWidget.classList.remove('face-overdrive');
    DOM.faceWidget.classList.add('face-spinning');
    faceOverdriveTimer = null;
  }, FACE_OVERDRIVE_DURATION_MS);
}

function handleFaceWidgetClickEgg() {
  const now = Date.now();
  faceClickBuffer = faceClickBuffer.filter(ts => now - ts <= FACE_OVERDRIVE_WINDOW_MS);
  faceClickBuffer.push(now);

  // Five rapid clicks → overdrive
  if (faceClickBuffer.length >= FACE_OVERDRIVE_CLICKS) {
    faceClickBuffer = [];
    triggerFaceOverdrive();
    return;
  }

  // Single click (only on first click, not during rapid-click buildup)
  if (faceClickBuffer.length === 1) {
    if (faceOverdriveTimer) return; // don't toggle off during overdrive
    faceSpinning = !faceSpinning;
    DOM.faceWidget.classList.toggle('face-spinning', faceSpinning);
  }
}

function handleWeekLabelHoverEgg() {
  if (!DOM.weekLabel || weekHoverTriggered || weekLabelSpoofActive) return;
  const now = Date.now();
  weekHoverBuffer = weekHoverBuffer.filter(ts => now - ts <= WEEK_LABEL_WINDOW_MS);
  weekHoverBuffer.push(now);
  if (weekHoverBuffer.length < WEEK_LABEL_HOVERS) return;

  weekHoverTriggered = true;
  weekLabelSpoofActive = true;
  DOM.weekLabel.textContent = WEEK_LABEL_GAG_TEXT;
  showEggToast('Fieldwork mode activated.');
  if (weekLabelGagTimer) clearTimeout(weekLabelGagTimer);
  weekLabelGagTimer = setTimeout(() => {
    weekLabelSpoofActive = false;
    DOM.weekLabel.textContent = weekLabelBaseText;
    weekLabelGagTimer = null;
  }, WEEK_LABEL_GAG_MS);
}

// — Hansard: daily quote —
function renderDailyQuote() {
  if (!DOM.dailyQuote) return;
  const dayIndex = Math.floor(Date.now() / 1800000) % HANSARD_QUOTES.length;
  const q = HANSARD_QUOTES[dayIndex];
  DOM.dailyQuote.innerHTML = `<blockquote>\u201c${escapeHtml(q.text)}\u201d<span class="quote-attr">\u2014 ${escapeHtml(q.attr)}</span></blockquote>`;
  const quoteEl = DOM.dailyQuote.querySelector('blockquote');
  if (quoteEl) {
    quoteEl.onclick = () => {
      const copyText = `\u201c${q.text}\u201d \u2014 ${q.attr}`;
      navigator.clipboard.writeText(copyText).catch(() => {});
      DOM.dailyQuote.classList.add('flash');
      showEggToast('Copied to clipboard.');
      setTimeout(() => DOM.dailyQuote.classList.remove('flash'), 600);
    };
  }
}

// — Division Bell: time-aware personality —
function getTimeOfDayLabel() {
  const h = new Date().getHours();
  if (h >= 5 && h < 12) return 'Morning briefing';
  if (h >= 12 && h < 17) return 'Afternoon dispatch';
  if (h >= 17 && h < 21) return 'Evening edition';
  return 'Late edition';
}

function isLateEdition() {
  const h = new Date().getHours();
  return h >= 21 || h < 5;
}

function checkDivisionBell() {
  const now = new Date();
  const currentHour = now.getHours();
  if (now.getMinutes() !== 0) return;
  if (currentHour === divisionBellLastHour) return;
  divisionBellLastHour = currentHour;
  if (!DOM.progressBar) return;
  DOM.progressBar.classList.add('division-bell');
  DOM.progressBar.style.width = '100%';
  showEggToast('Division bell.');
  setTimeout(() => {
    DOM.progressBar.classList.remove('division-bell');
    updateReadingProgress();
  }, 1200);
}

// — Prorogation: idle screensaver —
function showProrogation() {
  if (prorogued || !DOM.prorogueOverlay) return;
  DOM.prorogueOverlay.hidden = false;
  DOM.prorogueOverlay.classList.remove('hiding');
  requestAnimationFrame(() => DOM.prorogueOverlay.classList.add('show'));
  prorogued = true;
}

function hideProrogation() {
  if (!prorogued || !DOM.prorogueOverlay) return;
  DOM.prorogueOverlay.classList.remove('show');
  DOM.prorogueOverlay.classList.add('hiding');
  setTimeout(() => {
    DOM.prorogueOverlay.hidden = true;
    DOM.prorogueOverlay.classList.remove('hiding');
  }, 350);
  prorogued = false;
  resetIdleTimer();
}

function resetIdleTimer() {
  if (idleTimer) clearTimeout(idleTimer);
  if (document.hidden) return;
  idleTimer = setTimeout(showProrogation, IDLE_TIMEOUT_MS);
}

// — Whip's Office: topic bar panel —
function openWhipPanel() {
  if (!DOM.whipPanel || !STATE.topicCounts.length) return;
  const maxCount = STATE.topicCounts[0]?.[1] || 1;
  const rows = STATE.topicCounts.map(([topic, count]) => {
    const pct = Math.round((count / maxCount) * 100);
    return `<div class="whip-bar-row">
      <span class="whip-bar-label">${escapeHtml(topic)}</span>
      <div class="whip-bar-fill" style="width:${pct}px"></div>
      <span class="whip-bar-count">${count}</span>
    </div>`;
  }).join('');
  DOM.whipPanel.innerHTML = `<div class="whip-title">Whip\u2019s Office</div>${rows}`;
  DOM.whipPanel.hidden = false;
  requestAnimationFrame(() => DOM.whipPanel.classList.add('show'));
  whipPanelOpen = true;
  showEggToast('Three-line whip issued.');
}

function closeWhipPanel() {
  if (!DOM.whipPanel) return;
  DOM.whipPanel.classList.remove('show');
  setTimeout(() => { DOM.whipPanel.hidden = true; }, 200);
  whipPanelOpen = false;
}

function toggleWhipPanel() {
  if (whipPanelOpen) closeWhipPanel();
  else openWhipPanel();
}

// — Order Paper: source rankings panel —
function buildSenderCounts() {
  const counts = new Map();
  STATE.weekIndex.forEach(item => {
    if (isMutedRow(item)) return;
    const sender = item.from || 'Unknown';
    counts.set(sender, (counts.get(sender) || 0) + 1);
  });
  return [...counts.entries()]
    .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
    .slice(0, 10);
}

function openOrderPanel() {
  if (!DOM.orderPanel) return;
  const senderCounts = buildSenderCounts();
  if (!senderCounts.length) return;
  const maxCount = senderCounts[0][1] || 1;
  const rows = senderCounts.map(([sender, count]) => {
    const pct = Math.round((count / maxCount) * 100);
    return `<div class="order-bar-row">
      <span class="order-bar-label" title="${escapeHtml(sender)}">${escapeHtml(sender)}</span>
      <div class="order-bar-track"><div class="order-bar-fill" style="width:${pct}%"></div></div>
      <span class="order-bar-count">${count}</span>
    </div>`;
  }).join('');
  DOM.orderPanel.innerHTML = `<div class="order-title">Order Paper</div>${rows}`;
  DOM.orderPanel.hidden = false;
  requestAnimationFrame(() => DOM.orderPanel.classList.add('show'));
  orderPanelOpen = true;
  showEggToast('Order paper published.');
}

function closeOrderPanel() {
  if (!DOM.orderPanel) return;
  DOM.orderPanel.classList.remove('show');
  setTimeout(() => { DOM.orderPanel.hidden = true; }, 200);
  orderPanelOpen = false;
}

function toggleOrderPanel() {
  if (orderPanelOpen) closeOrderPanel();
  else openOrderPanel();
}

// — Black Rod: focus reading overlay —
function openBlackrodOverlay() {
  const key = STATE.focusedItemKey;
  if (!key || !DOM.blackrodOverlay) return;
  const item = STATE.weekIndex.find(i => i.itemKey === key);
  if (!item) return;
  const openMeta = getOpenMeta(item);
  const isRead = isItemRead(key);
  const isSaved = isItemSaved(key);
  DOM.blackrodMeta.innerHTML = `<span class="source-tag ${sourceClass(item.source)}">${escapeHtml(item.sourceLabel)}</span>`;
  DOM.blackrodSender.textContent = item.from || '';
  DOM.blackrodTime.textContent = `${item.dayName || ''} ${item.dayDate || ''} \u00b7 ${item.time || ''}`;
  DOM.blackrodTitle.textContent = item.title || '';
  const badges = [];
  if (isRead) badges.push('<span class="blackrod-badge is-on">Read</span>');
  if (isSaved) badges.push('<span class="blackrod-badge is-on">Saved</span>');
  if (!isRead && !isSaved) badges.push('<span class="blackrod-badge">Unread</span>');
  DOM.blackrodStatus.innerHTML = badges.join('');
  DOM.blackrodSummary.innerHTML = sanitizeSummaryHtml(item.summary);
  DOM.blackrodTopics.innerHTML = (item.topics || []).map(t =>
    `<span class="topic">${escapeHtml(t)}</span>`
  ).join('');
  if (openMeta.openUrl) {
    DOM.blackrodLink.href = openMeta.openUrl;
    DOM.blackrodLink.textContent = openMeta.openLabel || 'Open article';
    DOM.blackrodLink.hidden = false;
  } else {
    DOM.blackrodLink.hidden = true;
  }
  DOM.blackrodOverlay.hidden = false;
  blackrodOpen = true;
  DOM.blackrodClose.focus();
  showEggToast('Red box opened.');
}

function closeBlackrodOverlay() {
  if (!DOM.blackrodOverlay) return;
  DOM.blackrodOverlay.hidden = true;
  blackrodOpen = false;
}

function toggleBlackrodOverlay() {
  if (blackrodOpen) closeBlackrodOverlay();
  else openBlackrodOverlay();
}

// — Early Day Motion: random unread article —
function jumpToRandomUnread() {
  const candidates = STATE.weekIndex.filter(item =>
    !isItemRead(item.itemKey) && !isMutedRow(item)
  );
  if (!candidates.length) {
    showEggToast('All items read. The House is adjourned.');
    return;
  }
  const picked = candidates[Math.floor(Math.random() * candidates.length)];
  STATE.query = '';
  STATE.activeTopic = null;
  if (STATE.viewMode !== 'all') {
    STATE.viewMode = 'all';
  }
  if (DOM.searchInput) DOM.searchInput.value = '';
  if (STATE.activeDayKey !== picked.dayKey) {
    setActiveTab(picked.dayKey, { render: true });
  } else {
    renderContent();
  }
  setFocusedItemKey(picked.itemKey, { scroll: true });
  writeUrlState({ mode: 'replace' });
  showEggToast('EDM tabled.');
}

// — Royal Assent: batch mark visible as read —
function batchMarkVisibleRead() {
  if (!STATE.readMap || typeof STATE.readMap !== 'object') STATE.readMap = {};
  const keys = STATE.visibleItemKeys || [];
  let count = 0;
  keys.forEach(key => {
    if (!isItemRead(key)) {
      STATE.readMap[key] = Date.now();
      count++;
    }
  });
  if (count === 0) {
    showEggToast('The House has already divided.');
    return;
  }
  persistReadMap();
  renderContentPreservingFocus();
  updateReadingProgress();
  showEggToast(`Royal Assent granted. ${count} item${count !== 1 ? 's' : ''} read.`);
}

// — Dispatch Box: weekly stats overlay —
function openDispatchOverlay() {
  if (!DOM.dispatchOverlay || !DOM.dispatchGrid) return;
  const totalItems = STATE.weekIndex.length;
  const readCount = STATE.weekIndex.filter(i => isItemRead(i.itemKey)).length;
  const savedCount = STATE.weekIndex.filter(i => isItemSaved(i.itemKey)).length;
  const readPct = totalItems ? Math.round((readCount / totalItems) * 100) : 0;

  const sourceCounts = {};
  STATE.weekIndex.forEach(i => {
    const label = i.sourceLabel || 'Unknown';
    sourceCounts[label] = (sourceCounts[label] || 0) + 1;
  });
  const topSource = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1])[0];
  const topTopic = STATE.topicCounts[0];

  const rows = [
    ['Items this week', String(totalItems)],
    ['Read', `${readCount} <span class="pct">(${readPct}%)</span>`],
    ['Saved', String(savedCount)],
    ['Top source', topSource ? escapeHtml(topSource[0]) : '\u2014'],
    ['Top topic', topTopic ? escapeHtml(topTopic[0]) : '\u2014']
  ];

  DOM.dispatchGrid.innerHTML = rows.map(([label, value]) =>
    `<span class="dispatch-label">${label}</span><span class="dispatch-value">${value}</span>`
  ).join('');
  DOM.dispatchOverlay.hidden = false;
  dispatchOpen = true;
  showEggToast('Order, order! Weekly statistics.');
}

function closeDispatchOverlay() {
  if (!DOM.dispatchOverlay) return;
  DOM.dispatchOverlay.hidden = true;
  dispatchOpen = false;
}

function handleDispatchSequence(key, isTyping) {
  if (isTyping || !key || key.length !== 1 || !/[a-z]/i.test(key)) return false;
  const now = Date.now();
  if (now - dispatchKeyLastTs > DISPATCH_TIMEOUT_MS) {
    dispatchKeyBuffer = [];
  }
  dispatchKeyLastTs = now;
  dispatchKeyBuffer.push(key.toLowerCase());
  if (dispatchKeyBuffer.length > DISPATCH_KEY_SEQUENCE.length) {
    dispatchKeyBuffer = dispatchKeyBuffer.slice(-DISPATCH_KEY_SEQUENCE.length);
  }
  const buffer = dispatchKeyBuffer.join('');
  const target = DISPATCH_KEY_SEQUENCE.join('');
  if (!target.startsWith(buffer)) {
    dispatchKeyBuffer = [];
    return false;
  }
  if (buffer === target) {
    dispatchKeyBuffer = [];
    if (dispatchOpen) closeDispatchOverlay();
    else openDispatchOverlay();
    return true;
  }
  return false;
}

// — Lobby Correspondent: konami code —
function handleKonamiSequence(key, isTyping) {
  if (isTyping) return false;
  const now = Date.now();
  if (now - konamiKeyLastTs > KONAMI_TIMEOUT_MS) {
    konamiKeyBuffer = [];
  }
  konamiKeyLastTs = now;
  konamiKeyBuffer.push(key);
  if (konamiKeyBuffer.length > KONAMI_SEQUENCE.length) {
    konamiKeyBuffer = konamiKeyBuffer.slice(-KONAMI_SEQUENCE.length);
  }
  if (konamiKeyBuffer.length < KONAMI_SEQUENCE.length) return false;
  const match = konamiKeyBuffer.every((k, i) => k === KONAMI_SEQUENCE[i]);
  if (!match) return false;
  konamiKeyBuffer = [];
  triggerLobbyMode();
  return true;
}

function triggerLobbyMode() {
  if (lobbyModeTimer) return;
  document.body.classList.add('lobby-mode');
  const cards = document.querySelectorAll('.newsletter-card h3');
  const tags = document.querySelectorAll('.newsletter-card .source-tag');
  const savedTitles = [];
  const savedTags = [];

  cards.forEach((h3, i) => {
    savedTitles.push(h3.innerHTML);
    h3.textContent = LOBBY_HEADLINES[i % LOBBY_HEADLINES.length];
  });
  tags.forEach(tag => {
    savedTags.push(tag.textContent);
    tag.textContent = 'LOBBY';
  });

  showEggToast('You have entered the Lobby. Chatham House rules apply.');

  lobbyModeTimer = setTimeout(() => {
    document.body.classList.remove('lobby-mode');
    cards.forEach((h3, i) => {
      if (savedTitles[i] !== undefined) h3.innerHTML = savedTitles[i];
    });
    tags.forEach((tag, i) => {
      if (savedTags[i] !== undefined) tag.textContent = savedTags[i];
    });
    lobbyModeTimer = null;
  }, 5000);
}

// — Resign: cabinet reshuffle easter egg —
function handleResignSequence(key, isTyping) {
  if (isTyping || !key || key.length !== 1 || !/[a-z]/i.test(key)) return false;
  const now = Date.now();
  if (now - resignKeyLastTs > RESIGN_TIMEOUT_MS) {
    resignKeyBuffer = [];
  }
  resignKeyLastTs = now;
  resignKeyBuffer.push(key.toLowerCase());
  if (resignKeyBuffer.length > RESIGN_KEY_SEQUENCE.length) {
    resignKeyBuffer = resignKeyBuffer.slice(-RESIGN_KEY_SEQUENCE.length);
  }
  const buffer = resignKeyBuffer.join('');
  const target = RESIGN_KEY_SEQUENCE.join('');
  if (!target.startsWith(buffer)) {
    resignKeyBuffer = [];
    return false;
  }
  if (buffer === target) {
    resignKeyBuffer = [];
    triggerResign();
    return true;
  }
  return resignKeyBuffer.length >= 2;
}

function triggerResign() {
  if (resignTimer) return;
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  showEggToast('The Prime Minister has accepted your resignation.');
  if (prefersReduced) return;
  const cards = document.querySelectorAll('.newsletter-card');
  cards.forEach((card, i) => {
    const dx = (Math.random() > 0.5 ? 1 : -1) * (400 + Math.random() * 600);
    const dy = -200 + Math.random() * 500;
    const dr = (Math.random() > 0.5 ? 1 : -1) * (15 + Math.random() * 45);
    card.style.setProperty('--dx', dx + 'px');
    card.style.setProperty('--dy', dy + 'px');
    card.style.setProperty('--dr', dr + 'deg');
    setTimeout(() => card.classList.add('resigning'), i * 50);
  });
  resignTimer = setTimeout(() => {
    cards.forEach(card => {
      card.classList.remove('resigning');
      card.classList.add('returning');
    });
    setTimeout(() => {
      cards.forEach(card => {
        card.classList.remove('returning');
        card.style.removeProperty('--dx');
        card.style.removeProperty('--dy');
        card.style.removeProperty('--dr');
      });
      resignTimer = null;
    }, 1000);
  }, 2500);
}

let _stripHtmlHolder = null;
function stripHtmlToText(summaryHtml) {
  // Hot path on load (indexing): reuse a single element to reduce allocations/GC.
  if (!_stripHtmlHolder) _stripHtmlHolder = document.createElement('div');
  _stripHtmlHolder.innerHTML = sanitizeSummaryHtml(summaryHtml);
  return _stripHtmlHolder.textContent?.replace(/\s+/g, ' ').trim() || '';
}

function parseTimeToMinutes(value) {
  const match = String(value || '').match(/^(\d{1,2}):(\d{2})$/);
  if (!match) return 0;
  return Number(match[1]) * 60 + Number(match[2]);
}

function sourceClass(value) {
  return SOURCE_CLASSES.has(value) ? value : 'newsletter';
}

function normalizeSafeUrl(url) {
  if (typeof url !== 'string' || !url.trim()) return null;
  try {
    const parsed = new URL(url);
    if (parsed.protocol === 'http:' || parsed.protocol === 'https:') {
      return parsed.toString();
    }
  } catch (_) {
    return null;
  }
  return null;
}

const SUMMARY_ALLOWED_TAGS = new Set(['P', 'UL', 'LI', 'STRONG', 'EM', 'B', 'I', 'BR', 'MARK', 'A']);

function _sanitizeSummaryNode(node) {
  if (!node) return;
  if (node.nodeType === Node.TEXT_NODE) return;
  if (node.nodeType !== Node.ELEMENT_NODE) {
    node.parentNode?.removeChild(node);
    return;
  }

  const tag = String(node.tagName || '').toUpperCase();
  if (!SUMMARY_ALLOWED_TAGS.has(tag)) {
    const parent = node.parentNode;
    if (!parent) return;
    const children = [...node.childNodes];
    children.forEach(child => {
      parent.insertBefore(child, node);
      _sanitizeSummaryNode(child);
    });
    parent.removeChild(node);
    return;
  }

  [...node.attributes].forEach(attr => {
    const attrName = String(attr.name || '').toLowerCase();
    if (tag === 'A' && (attrName === 'href' || attrName === 'target' || attrName === 'rel')) return;
    node.removeAttribute(attr.name);
  });

  if (tag === 'A') {
    const safeHref = normalizeSafeUrl(node.getAttribute('href') || '');
    if (!safeHref) {
      const parent = node.parentNode;
      if (parent) {
        const children = [...node.childNodes];
        children.forEach(child => parent.insertBefore(child, node));
        parent.removeChild(node);
      }
      return;
    }
    node.setAttribute('href', safeHref);
    node.setAttribute('target', '_blank');
    node.setAttribute('rel', 'noopener noreferrer');
  }

  [...node.childNodes].forEach(_sanitizeSummaryNode);
}

function sanitizeSummaryHtml(summaryHtml) {
  const wrapper = document.createElement('div');
  wrapper.innerHTML = String(summaryHtml || '');
  [...wrapper.childNodes].forEach(_sanitizeSummaryNode);
  return wrapper.innerHTML;
}

function getOpenMeta(item) {
  const articleUrl = normalizeSafeUrl(item.article_url);
  const gmailLink = normalizeSafeUrl(item.gmail_link);
  const explicitOpenUrl = normalizeSafeUrl(item.open_url);
  const openUrl = gmailLink || explicitOpenUrl || articleUrl;

  if (!openUrl) {
    return { openUrl: null, openUrlType: 'none', openLabel: '' };
  }

  const explicitType = item.open_url_type === 'article' || item.open_url_type === 'gmail'
    ? item.open_url_type
    : null;
  let openUrlType = explicitType || (openUrl === gmailLink ? 'gmail' : 'article');
  if (openUrl === gmailLink) openUrlType = 'gmail';

  return {
    openUrl,
    openUrlType,
    openLabel: openUrlType === 'gmail' ? 'Open in Gmail' : 'Open'
  };
}

function buildWeekIndex(data) {
  const index = [];
  data.days.forEach((day, dayOrder) => {
    day.items.forEach((item, itemOrder) => {
      const topics = Array.isArray(item.topics) ? item.topics : [];
      const summaryText = stripHtmlToText(item.summary);
	      const searchText = [
	        item.title,
	        summaryText,
	        item.from,
	        item.sourceLabel,
	        topics.join(' ')
	      ].join(' ').toLowerCase();
	      const senderKey = normalizeSenderKey(item.from);
	      const itemKey = getItemKey({
	        ...item,
	        dayKey: day.key,
	        dayDate: day.date,
	        dayDateFull: day.dateFull
	      });

	      index.push({
	        ...item,
	        dayKey: day.key,
	        dayName: day.name,
	        dayDate: day.date,
	        dayDateFull: day.dateFull,
	        dayOrder,
	        itemOrder,
	        topics,
	        senderKey,
	        itemKey,
	        summaryText,
	        searchText,
	        rank: dayOrder * 1440 + parseTimeToMinutes(item.time)
	      });
    });
  });
  return index;
}

function buildTopicCounts(index) {
  const counts = new Map();
  index.forEach(row => {
    row.topics.forEach(topic => {
      counts.set(topic, (counts.get(topic) || 0) + 1);
    });
  });
  return [...counts.entries()]
    .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
}

function normalizeSortMode(mode) {
  return mode === 'source' ? 'source' : 'newest';
}

function isRefreshStale() {
  if (!STATE.serverHealthy) return false;
  if (!STATE.lastRefreshAt) return true;
  return Date.now() - STATE.lastRefreshAt > STALE_REFRESH_MS;
}

function updateSearchToggleMeta() {
  if (!DOM.searchToggleBtn) return;
  const base = STATE.searchVisible ? 'Hide search and filters' : 'Show search and filters';
  const stale = isRefreshStale();
  DOM.searchToggleBtn.classList.toggle('is-stale', stale);
  DOM.searchToggleBtn.textContent = STATE.searchVisible ? '▾' : '▸';
  const title = stale ? `${base} · Refresh recommended` : base;
  DOM.searchToggleBtn.title = title;
  DOM.searchToggleBtn.setAttribute('aria-label', title);
}

function updateRefreshMeta() {
  if (!DOM.refreshMeta) return;
  if (!canUseApi()) {
    DOM.refreshMeta.hidden = true;
    return;
  }
  DOM.refreshMeta.hidden = false;
  DOM.refreshMeta.textContent = `Last refresh: ${formatRelativeTime(STATE.lastRefreshAt)}`;
}

function updateViewToggleUi() {
  if (!DOM.viewToggle) return;
  DOM.viewToggle.querySelectorAll('.view-btn').forEach(btn => {
    const view = btn.dataset.view || 'all';
    const isActive = view === STATE.viewMode;
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}

function setViewMode(mode, options = {}) {
  const next = normalizeViewMode(mode);
  STATE.viewMode = next;
  if (options.persist !== false) {
    localStorage.setItem(STORAGE_KEYS.viewMode, next);
  }
  updateViewToggleUi();
}

function setSearchVisibility(visible, options = {}) {
  const nextVisible = Boolean(visible);
  STATE.searchVisible = nextVisible;
  DOM.utilityShell.classList.toggle('search-collapsed', !nextVisible);
  if (options.persist !== false) {
    localStorage.setItem(STORAGE_KEYS.searchVisible, nextVisible ? 'true' : 'false');
  }
  updateSearchToggleMeta();

  if (!nextVisible) {
    clearActiveFilters({ clearView: true });
  } else if (options.focus) {
    DOM.searchInput.focus();
    DOM.searchInput.select();
  }
}

function syncWeekCaches() {
  STATE.weekIndex = buildWeekIndex(STATE.dataView);
  STATE.topicCounts = buildTopicCounts(STATE.weekIndex);
}

function setWeekLabel(label) {
  const nextLabel = label || STATE.currentWeekLabel;
  weekLabelBaseText = nextLabel;
  if (DOM.weekLabel && !weekLabelSpoofActive) DOM.weekLabel.textContent = nextLabel;
}

function canUseApi() {
  return location.protocol === 'http:' || location.protocol === 'https:';
}

function clearActiveFilters(options = {}) {
  const clearView = options.clearView !== false;
  STATE.query = '';
  STATE.activeTopic = null;
  if (clearView) setViewMode('all');
  DOM.searchInput.value = '';
}

function toWeekData(entry) {
  if (!entry || typeof entry !== 'object') return null;
  if (Array.isArray(entry.days)) return { days: entry.days };
  if (entry.data && Array.isArray(entry.data.days)) return { days: entry.data.days };
  return null;
}

function sortItems(items, mode) {
  const sorted = [...items];
  if (mode === 'source') {
    sorted.sort((a, b) =>
      a.sourceLabel.localeCompare(b.sourceLabel)
      || a.title.localeCompare(b.title)
      || b.rank - a.rank
    );
    return sorted;
  }
  sorted.sort((a, b) => b.rank - a.rank || b.itemOrder - a.itemOrder);
  return sorted;
}

function getMuteCount() {
  return (STATE.mutedSenders?.size || 0) + (STATE.mutedSources?.size || 0);
}

function isMutedRow(row) {
  if (!row) return false;
  if (row.senderKey && STATE.mutedSenders && STATE.mutedSenders.has(row.senderKey)) return true;
  if (row.source && STATE.mutedSources && STATE.mutedSources.has(row.source)) return true;
  return false;
}

function isItemRead(itemKey) {
  return Boolean(itemKey && STATE.readMap && STATE.readMap[itemKey]);
}

function isItemSaved(itemKey) {
  return Boolean(itemKey && STATE.savedMap && STATE.savedMap[itemKey]);
}

function persistReadMap() {
  saveJson(STORAGE_KEYS.readMap, STATE.readMap || {});
}

function persistSavedMap() {
  saveJson(STORAGE_KEYS.savedMap, STATE.savedMap || {});
}

function persistMutes() {
  const senders = [...(STATE.mutedSenders || [])];
  const sources = [...(STATE.mutedSources || [])];
  saveJson(STORAGE_KEYS.mutedSenders, senders);
  saveJson(STORAGE_KEYS.mutedSources, sources);
}

function persistLastRefreshAt() {
  try {
    localStorage.setItem(STORAGE_KEYS.lastRefreshAt, String(Number(STATE.lastRefreshAt || 0)));
  } catch (_error) {
    // Ignore storage failures.
  }
}

function setItemReadState(itemKey, isRead) {
  if (!itemKey) return;
  if (!STATE.readMap || typeof STATE.readMap !== 'object') STATE.readMap = {};
  if (isRead) {
    STATE.readMap[itemKey] = Date.now();
  } else {
    delete STATE.readMap[itemKey];
  }
  persistReadMap();
}

function setItemSavedState(itemKey, isSaved) {
  if (!itemKey) return;
  if (!STATE.savedMap || typeof STATE.savedMap !== 'object') STATE.savedMap = {};
  if (isSaved) {
    STATE.savedMap[itemKey] = Date.now();
  } else {
    delete STATE.savedMap[itemKey];
  }
  persistSavedMap();
}

function toggleItemRead(itemKey) {
  setItemReadState(itemKey, !isItemRead(itemKey));
}

function toggleItemSaved(itemKey) {
  setItemSavedState(itemKey, !isItemSaved(itemKey));
}

function markItemRead(itemKey) {
  if (!itemKey || isItemRead(itemKey)) return;
  setItemReadState(itemKey, true);
}

function updateMuteManagerUi() {
  if (!DOM.muteManager) return;
  const senderKeys = [...(STATE.mutedSenders || [])].sort((a, b) => a.localeCompare(b));
  const sourceKeys = [...(STATE.mutedSources || [])].sort((a, b) => a.localeCompare(b));
  const total = senderKeys.length + sourceKeys.length;

  DOM.muteManager.hidden = total === 0;
  if (DOM.muteCount) DOM.muteCount.textContent = String(total);
  if (DOM.mutedSenders) {
    DOM.mutedSenders.innerHTML = senderKeys.map(key => `
      <button class="mute-chip" type="button" data-mute-type="sender" data-mute-value="${escapeHtml(key)}" title="Unmute sender">
        ${escapeHtml(key)} ×
      </button>
    `).join('');
  }
  if (DOM.mutedSources) {
    DOM.mutedSources.innerHTML = sourceKeys.map(key => `
      <button class="mute-chip" type="button" data-mute-type="source" data-mute-value="${escapeHtml(key)}" title="Unmute source">
        ${escapeHtml(key)} ×
      </button>
    `).join('');
  }
}

function rebuildVisibleItemKeys() {
  const cards = [...document.querySelectorAll('.newsletter-card[data-item-key]')];
  const keys = cards.map(card => card.dataset.itemKey || '').filter(Boolean);
  STATE.visibleItemKeys = keys;

  if (!keys.length) {
    STATE.focusedItemKey = null;
    return;
  }
  if (!STATE.focusedItemKey || !keys.includes(STATE.focusedItemKey)) {
    STATE.focusedItemKey = keys[0];
  }
}

function applyFocusUi({ scroll } = {}) {
  const shouldScroll = scroll !== false;
  const key = STATE.focusedItemKey;
  document.querySelectorAll('.newsletter-card[data-item-key]').forEach(card => {
    card.classList.toggle('is-focused', Boolean(key && card.dataset.itemKey === key));
  });
  if (shouldScroll && key) {
    const card = document.querySelector(`.newsletter-card[data-item-key="${cssEscape(key)}"]`);
    if (card) {
      try {
        card.scrollIntoView({ block: 'center', behavior: window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'auto' : 'smooth' });
      } catch (_error) {
        card.scrollIntoView(true);
      }
    }
  }
}

function setFocusedItemKey(itemKey, options = {}) {
  if (!itemKey) return;
  STATE.focusedItemKey = itemKey;
  applyFocusUi({ scroll: options.scroll });
}

function moveFocus(delta) {
  const keys = STATE.visibleItemKeys || [];
  if (!keys.length) return;
  const current = STATE.focusedItemKey;
  const idx = current ? keys.indexOf(current) : -1;
  const nextIdx = Math.max(0, Math.min(keys.length - 1, (idx === -1 ? 0 : idx) + delta));
  setFocusedItemKey(keys[nextIdx]);
}

function openFocusedCard() {
  const key = STATE.focusedItemKey;
  if (!key) return;
  const card = document.querySelector(`.newsletter-card[data-item-key="${cssEscape(key)}"]`);
  const openUrl = card?.dataset.openUrl || '';
  if (!openUrl) return;
  markItemRead(key);
  window.open(openUrl, '_blank', 'noopener,noreferrer');
  if (normalizeViewMode(STATE.viewMode) === 'unread') {
    setTimeout(() => renderContentPreservingFocus(), 0);
  } else {
    // Keep UI snappy: don't force a full render unless needed.
    card?.classList.add('is-read');
  }
}

function closeCardMenu() {
  if (!DOM.cardMenu) return;
  DOM.cardMenu.hidden = true;
  activeMenuItemKey = null;
  activeMenuAnchorRect = null;
}

function syncCardMenuLabels() {
  if (!DOM.cardMenu || !activeMenuItemKey) return;
  const saveBtn = DOM.cardMenu.querySelector('[data-menu-action="toggle-save"]');
  const readBtn = DOM.cardMenu.querySelector('[data-menu-action="toggle-read"]');
  if (saveBtn) saveBtn.textContent = isItemSaved(activeMenuItemKey) ? 'Unsave' : 'Save';
  if (readBtn) readBtn.textContent = isItemRead(activeMenuItemKey) ? 'Mark unread' : 'Mark read';
}

function positionCardMenu() {
  if (!DOM.cardMenu || !activeMenuAnchorRect) return;
  const margin = 10;
  DOM.cardMenu.hidden = false;
  DOM.cardMenu.style.visibility = 'hidden';
  DOM.cardMenu.style.left = '0px';
  DOM.cardMenu.style.top = '0px';

  const menuRect = DOM.cardMenu.getBoundingClientRect();
  const anchor = activeMenuAnchorRect;
  const width = menuRect.width || 200;
  const height = menuRect.height || 160;

  let left = anchor.right - width;
  left = Math.max(margin, Math.min(left, window.innerWidth - width - margin));

  let top = anchor.bottom + 8;
  if (top + height > window.innerHeight - margin) {
    top = anchor.top - height - 8;
  }
  top = Math.max(margin, Math.min(top, window.innerHeight - height - margin));

  DOM.cardMenu.style.left = `${Math.round(left)}px`;
  DOM.cardMenu.style.top = `${Math.round(top)}px`;
  DOM.cardMenu.style.visibility = 'visible';
}

function openCardMenu(itemKey, anchorRect) {
  if (!DOM.cardMenu || !itemKey || !anchorRect) return;
  activeMenuItemKey = itemKey;
  activeMenuAnchorRect = anchorRect;
  syncCardMenuLabels();
  positionCardMenu();
}

const URL_DAY_KEYS = new Set(['sat', 'sun', 'mon', 'tue', 'wed', 'thu', 'fri']);

function readUrlState() {
  const url = new URL(window.location.href);
  const week = (url.searchParams.get('week') || '').trim();
  const day = (url.searchParams.get('day') || '').trim();
  const q = url.searchParams.get('q') || '';
  const topic = (url.searchParams.get('topic') || '').trim();
  const view = normalizeViewMode((url.searchParams.get('view') || 'all').trim());
  const sort = normalizeSortMode((url.searchParams.get('sort') || 'newest').trim());
  return {
    week: week || null,
    day: URL_DAY_KEYS.has(day) ? day : null,
    q,
    topic: topic || null,
    view,
    sort
  };
}

function writeUrlState(options = {}) {
  if (suppressUrlWrites) return;
  const mode = options.mode === 'push' ? 'push' : 'replace';
  const url = new URL(window.location.href);
  const params = url.searchParams;

  if (STATE.activeArchiveWeekId) params.set('week', STATE.activeArchiveWeekId);
  else params.delete('week');

  if (STATE.activeDayKey && STATE.activeDayKey !== getLatestDayWithContent()) params.set('day', STATE.activeDayKey);
  else params.delete('day');

  const q = String(STATE.query || '').trim();
  if (q) params.set('q', q);
  else params.delete('q');

  if (STATE.activeTopic) params.set('topic', STATE.activeTopic);
  else params.delete('topic');

  const view = normalizeViewMode(STATE.viewMode);
  if (view && view !== 'all') params.set('view', view);
  else params.delete('view');

  const sort = normalizeSortMode(STATE.sortMode);
  if (sort && sort !== 'newest') params.set('sort', sort);
  else params.delete('sort');

  const query = params.toString();
  const nextUrl = `${url.pathname}${query ? `?${query}` : ''}`;
  try {
    if (mode === 'push') window.history.pushState({}, '', nextUrl);
    else window.history.replaceState({}, '', nextUrl);
  } catch (_error) {
    // Some contexts (notably file://) can disallow history mutations.
  }
}

function applyUrlState(urlState, options = {}) {
  const state = urlState || readUrlState();
  const autoExpandPanel = Boolean(options.autoExpandPanel);
  suppressUrlWrites = true;
  try {
    const targetWeek = state.week;
    const hasWeek = Boolean(targetWeek && STATE.archiveWeeks.some(row => String(row.week_id) === String(targetWeek)));
    if (hasWeek) {
      applyArchiveSelection(targetWeek, { render: false });
    } else if (targetWeek) {
      applyArchiveSelection('current', { render: false });
    }

    setActiveTab(state.day || STATE.activeDayKey, { render: false });

    STATE.query = state.q || '';
    if (DOM.searchInput) DOM.searchInput.value = STATE.query;

    STATE.activeTopic = state.topic || null;

    setViewMode(state.view || 'all');

    STATE.sortMode = normalizeSortMode(state.sort || STATE.sortMode);
    localStorage.setItem(STORAGE_KEYS.sortMode, STATE.sortMode);
    updateSortUi();

    renderContent();

    if (autoExpandPanel && !STATE.searchVisible && (STATE.query.trim() || STATE.activeTopic || normalizeViewMode(STATE.viewMode) !== 'all')) {
      setSearchVisibility(true, { persist: false });
    }
  } finally {
    suppressUrlWrites = false;
  }
}

function afterRender() {
  updateMuteManagerUi();
  rebuildVisibleItemKeys();
  applyFocusUi({ scroll: false });
  syncCardMenuLabels();
  if (activeMenuItemKey && STATE.visibleItemKeys && !STATE.visibleItemKeys.includes(activeMenuItemKey)) {
    closeCardMenu();
  }
}

function renderContentPreservingFocus() {
  const prevKeys = STATE.visibleItemKeys || [];
  const prevKey = STATE.focusedItemKey;
  const prevIndex = prevKey ? prevKeys.indexOf(prevKey) : -1;

  renderContent();

  if (!STATE.visibleItemKeys || !STATE.visibleItemKeys.length) return;
  if (prevKey && STATE.visibleItemKeys.includes(prevKey)) {
    STATE.focusedItemKey = prevKey;
  } else if (prevIndex >= 0) {
    STATE.focusedItemKey = STATE.visibleItemKeys[Math.min(prevIndex, STATE.visibleItemKeys.length - 1)];
  }
  applyFocusUi({ scroll: false });
}

function openShortcutsOverlay() {
  if (!DOM.shortcutsOverlay) return;
  DOM.shortcutsOverlay.hidden = false;
  shortcutsOpen = true;
  DOM.shortcutsClose?.focus();
}

function closeShortcutsOverlay() {
  if (!DOM.shortcutsOverlay) return;
  DOM.shortcutsOverlay.hidden = true;
  shortcutsOpen = false;
}

function toggleShortcutsOverlay() {
  if (shortcutsOpen) closeShortcutsOverlay();
  else openShortcutsOverlay();
}

// — Command palette (Cmd/Ctrl+K) —
function _cmdTypeLabel(type) {
  const t = String(type || '').toLowerCase();
  if (t === 'action') return 'ACTION';
  if (t === 'link') return 'LINK';
  if (t === 'article') return 'ARTICLE';
  if (t === 'todo') return 'TODO';
  return t.toUpperCase() || 'ITEM';
}

function _toggleSortFromPalette() {
  STATE.sortMode = STATE.sortMode === 'newest' ? 'source' : 'newest';
  localStorage.setItem(STORAGE_KEYS.sortMode, STATE.sortMode);
  updateSortUi();
  renderContentPreservingFocus();
  writeUrlState({ mode: 'replace' });
}

function _setViewModeFromPalette(mode) {
  setViewMode(mode);
  renderContentPreservingFocus();
  writeUrlState({ mode: 'push' });
}

function _toggleDispatchOverlay() {
  if (dispatchOpen) closeDispatchOverlay();
  else openDispatchOverlay();
}

function buildPaletteItems() {
  const items = [];

  const actions = [
    { label: 'Toggle theme', action: () => cycleTheme() },
    { label: 'Refresh digest', action: () => { void runRefresh(); } },
    { label: 'Toggle sort (Newest/Source)', action: () => _toggleSortFromPalette() },
    { label: 'View: all', action: () => _setViewModeFromPalette('all') },
    { label: 'View: unread only', action: () => _setViewModeFromPalette('unread') },
    { label: 'View: saved only', action: () => _setViewModeFromPalette('saved') },
    { label: "Topic breakdown (Whip's Office)", action: () => toggleWhipPanel() },
    { label: 'Source rankings (Order Paper)', action: () => toggleOrderPanel() },
    { label: 'Focus reading (Black Rod)', action: () => toggleBlackrodOverlay() },
    { label: 'Toggle Order Paper panel', action: () => toggleTodoPanel() },
    { label: 'Keyboard shortcuts', action: () => toggleShortcutsOverlay() },
    { label: 'Weekly stats (Dispatch Box)', action: () => _toggleDispatchOverlay() },
    { label: 'Clear all filters', action: () => {
      clearActiveFilters({ clearView: true });
      renderContentPreservingFocus();
      writeUrlState({ mode: 'push' });
    }},
    { label: 'Mark all visible read', action: () => batchMarkVisibleRead() },
    { label: 'Jump to random unread (EDM)', action: () => jumpToRandomUnread() },
    { label: 'Toggle pollster mode', action: () => togglePollsterMode() }
  ];
  actions.forEach(a => {
    items.push({
      type: 'action',
      label: a.label,
      detail: '',
      action: a.action
    });
  });

  (QUICK_FOLDERS || []).forEach(folder => {
    (folder.links || []).forEach(link => {
      const safeUrl = normalizeSafeUrl(link.url);
      if (!safeUrl) return;
      items.push({
        type: 'link',
        label: link.name,
        detail: folder.label,
        action: () => window.open(safeUrl, '_blank', 'noopener')
      });
    });
  });

  (STATE.weekIndex || []).forEach(item => {
    const label = item.title || 'Untitled';
    const day = item.dayName || item.dayDate || '';
    const from = item.from || 'Unknown sender';
    items.push({
      type: 'article',
      label,
      detail: day ? `${from} · ${day}` : from,
      action: () => {
        const openMeta = getOpenMeta(item);
        if (openMeta.openUrl) window.open(openMeta.openUrl, '_blank', 'noopener');
      }
    });
  });

  const pendingTodos = loadTodos().filter(t => !t.done);
  pendingTodos.forEach(t => {
    const pri = (t.priority && t.priority !== 'none') ? String(t.priority).toUpperCase() : '';
    const due = formatDueDate(t.due);
    items.push({
      type: 'todo',
      label: t.text || '(Untitled)',
      detail: [pri, due].filter(Boolean).join(' · '),
      action: () => toggleTodoDone(t.id)
    });
  });

  // Precompute haystack for filtering.
  items.forEach(item => {
    item._haystack = `${item.type} ${item.label} ${item.detail}`.toLowerCase();
  });

  return items;
}

function filterPaletteItems(items, query) {
  const q = String(query || '').trim().toLowerCase();
  if (!q) {
    return items
      .filter(item => item.type === 'action' || item.type === 'link')
      .slice(0, 20);
  }

  const words = q.split(/\s+/).filter(Boolean);
  return items.filter(item => {
    const text = item._haystack || '';
    return words.every(w => text.includes(w));
  });
}

function _paletteClampActive() {
  if (!paletteVisibleItems.length) {
    paletteActiveIdx = 0;
    return;
  }
  paletteActiveIdx = Math.max(0, Math.min(paletteVisibleItems.length - 1, paletteActiveIdx));
}

function _paletteEnsureActiveVisible() {
  if (!DOM.cmdPaletteResults) return;
  const activeEl = DOM.cmdPaletteResults.querySelector(`.cmd-result[data-idx="${paletteActiveIdx}"]`);
  if (activeEl && typeof activeEl.scrollIntoView === 'function') {
    activeEl.scrollIntoView({ block: 'nearest' });
  }
}

function updatePaletteActive(options = {}) {
  if (!DOM.cmdPaletteResults) return;
  DOM.cmdPaletteResults.querySelectorAll('.cmd-result').forEach(row => {
    const idx = Number(row.dataset.idx);
    row.classList.toggle('active', idx === paletteActiveIdx);
  });
  if (options.scroll !== false) _paletteEnsureActiveVisible();
}

function renderPaletteResults(items) {
  if (!DOM.cmdPaletteResults) return;
  paletteVisibleItems = Array.isArray(items) ? items : [];
  _paletteClampActive();

  if (!paletteVisibleItems.length) {
    DOM.cmdPaletteResults.innerHTML = `<div class="cmd-palette-empty">No matches</div>`;
    return;
  }

  DOM.cmdPaletteResults.innerHTML = paletteVisibleItems.map((item, idx) => {
    const activeClass = idx === paletteActiveIdx ? ' active' : '';
    const detail = item.detail ? `<span class="cmd-result-detail">${escapeHtml(item.detail)}</span>` : '';
    return `<div class="cmd-result${activeClass}" data-idx="${idx}" role="option" aria-selected="${idx === paletteActiveIdx ? 'true' : 'false'}">
      <span class="cmd-result-type" data-type="${escapeHtml(item.type)}">${escapeHtml(_cmdTypeLabel(item.type))}</span>
      <span class="cmd-result-label">${escapeHtml(item.label)}</span>
      ${detail}
    </div>`;
  }).join('');

  _paletteEnsureActiveVisible();
}

function _runPaletteItem(item) {
  if (!item || typeof item.action !== 'function') return;
  try {
    item.action();
  } catch (error) {
    console.error(error);
    showEggToast('Command failed.');
  }
}

function openCmdPalette() {
  if (!DOM.cmdPalette || !DOM.cmdPaletteInput) return;
  paletteRestoreFocusEl = document.activeElement instanceof HTMLElement ? document.activeElement : null;
  cmdPaletteOpen = true;
  DOM.cmdPalette.hidden = false;
  DOM.cmdPaletteInput.value = '';
  paletteActiveIdx = 0;
  paletteAllItems = buildPaletteItems();
  renderPaletteResults(filterPaletteItems(paletteAllItems, ''));
  DOM.cmdPaletteInput.focus();
}

function closeCmdPalette() {
  if (!DOM.cmdPalette) return;
  cmdPaletteOpen = false;
  DOM.cmdPalette.hidden = true;
  paletteVisibleItems = [];
  paletteAllItems = [];

  const restore = paletteRestoreFocusEl;
  paletteRestoreFocusEl = null;
  try {
    if (restore && document.contains(restore)) restore.focus();
  } catch (_error) {
    // Ignore focus failures.
  }
}

function toggleCmdPalette() {
  if (cmdPaletteOpen) closeCmdPalette();
  else openCmdPalette();
}

async function probeServerHealth() {
  if (!canUseApi()) {
    STATE.serverHealthy = false;
    updateSearchToggleMeta();
    updateRefreshMeta();
    return;
  }
  try {
    const response = await fetch('/api/health', { cache: 'no-store' });
    if (!response.ok) throw new Error('health check failed');
    const payload = await response.json().catch(() => ({}));
    STATE.serverHealthy = Boolean(payload && payload.ok);
  } catch (_error) {
    STATE.serverHealthy = false;
  }
  updateSearchToggleMeta();
  updateRefreshMeta();
}

function filterItems(index, query, topic) {
  const q = String(query || '').trim().toLowerCase();
  const view = normalizeViewMode(STATE.viewMode);
  return index.filter(row => {
    if (isMutedRow(row)) return false;
    if (view === 'unread' && isItemRead(row.itemKey)) return false;
    if (view === 'saved' && !isItemSaved(row.itemKey)) return false;
    if (topic && !row.topics.includes(topic)) return false;
    if (q && !row.searchText.includes(q)) return false;
    return true;
  });
}

function highlightText(value, query) {
  const safe = escapeHtml(value);
  const q = String(query || '').trim();
  if (!q) return safe;
  const regex = new RegExp(`(${escapeRegExp(q)})`, 'ig');
  return safe.replace(regex, '<mark>$1</mark>');
}

function highlightSummaryHtml(summaryHtml, query) {
  const safeSummaryHtml = sanitizeSummaryHtml(summaryHtml);
  const q = String(query || '').trim();
  if (!q) return safeSummaryHtml;

  const wrapper = document.createElement('div');
  wrapper.innerHTML = safeSummaryHtml;
  const textNodes = [];
  const walker = document.createTreeWalker(wrapper, NodeFilter.SHOW_TEXT);
  while (walker.nextNode()) textNodes.push(walker.currentNode);

  textNodes.forEach(node => {
    const original = node.nodeValue || '';
    const regex = new RegExp(escapeRegExp(q), 'ig');
    if (!regex.test(original)) return;

    regex.lastIndex = 0;
    const frag = document.createDocumentFragment();
    let lastIndex = 0;
    original.replace(regex, (match, _group, offset) => {
      if (offset > lastIndex) {
        frag.appendChild(document.createTextNode(original.slice(lastIndex, offset)));
      }
      const mark = document.createElement('mark');
      mark.textContent = match;
      frag.appendChild(mark);
      lastIndex = offset + match.length;
      return match;
    });

    if (lastIndex < original.length) {
      frag.appendChild(document.createTextNode(original.slice(lastIndex)));
    }
    node.parentNode?.replaceChild(frag, node);
  });

  return wrapper.innerHTML;
}

function renderTabs() {
  DOM.tabs.innerHTML = STATE.dataView.days.map(day => {
    const visibleCount = STATE.weekIndex.length
      ? STATE.weekIndex.filter(row => row.dayKey === day.key && !isMutedRow(row)).length
      : day.items.length;
    const isEmpty = visibleCount === 0;
    return `
      <li class="day-tab ${isEmpty ? 'empty' : ''}" data-key="${day.key}">
        <span class="day-name">${escapeHtml(day.name)}</span>
        <span class="day-date">${escapeHtml(day.date)}</span>
        <span class="count-badge">${visibleCount}</span>
      </li>
    `;
  }).join('');
}

function updateActiveTabUi() {
  document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
  const activeTab = document.querySelector(`.day-tab[data-key="${STATE.activeDayKey}"]`);
  if (activeTab) activeTab.classList.add('active');
}

function renderTopicHeat() {
  if (!STATE.topicCounts.length) {
    DOM.topicHeat.innerHTML = '';
    return;
  }

  const chips = STATE.topicCounts.slice(0, 16).map(([topic, count]) => `
    <button class="topic-chip ${STATE.activeTopic === topic ? 'active' : ''}" data-topic="${escapeHtml(topic)}" type="button">
      ${escapeHtml(topic)} · ${count}
    </button>
  `).join('');

  const allChip = `
    <button class="topic-chip ${!STATE.activeTopic ? 'active' : ''}" data-topic="" type="button">
      All topics
    </button>
  `;

  DOM.topicHeat.innerHTML = allChip + chips;
}

function renderFiltersMeta(resultCount) {
  const pills = [];
  if (STATE.activeArchiveWeekId) {
    const archive = STATE.archiveWeeks.find(row => row.week_id === STATE.activeArchiveWeekId);
    if (archive?.week_label) {
      pills.push(`<span class="pill">Archive: ${escapeHtml(archive.week_label)}</span>`);
    }
  }
  if (STATE.query.trim()) pills.push(`<span class="pill">Query: ${escapeHtml(STATE.query.trim())}</span>`);
  if (STATE.activeTopic) pills.push(`<span class="pill">Topic: ${escapeHtml(STATE.activeTopic)}</span>`);
  if (normalizeViewMode(STATE.viewMode) !== 'all') {
    const label = STATE.viewMode === 'saved' ? 'Saved' : 'Unread';
    pills.push(`<span class="pill">View: ${label}</span>`);
  }
  if (getMuteCount() > 0) {
    pills.push(`<span class="pill">Muted: ${getMuteCount()}</span>`);
  }
  pills.push(`<span class="pill">Sort: ${STATE.sortMode === 'source' ? 'Source' : 'Newest'}</span>`);
  if (typeof resultCount === 'number') pills.push(`<span class="pill">${resultCount} results</span>`);
  if (!pills.length) pills.push('<span class="pill">No filters</span>');
  DOM.filtersMeta.innerHTML = `${pills.join('')}<a class="clear-filters" id="clearFilters">Clear filters</a>`;
}

function renderCard(item, query, showDayMeta) {
  const openMeta = getOpenMeta(item);
  const itemKey = item.itemKey || getItemKey(item);
  const senderKey = item.senderKey || normalizeSenderKey(item.from);
  const isRead = isItemRead(itemKey);
  const isSaved = isItemSaved(itemKey);
  const isRedBoxed = isSaved;
  const isFocused = Boolean(itemKey && STATE.focusedItemKey && itemKey === STATE.focusedItemKey);
  const safeFrom = escapeHtml(item.from);
  const renderedTitle = highlightText(item.title, query);
  const renderedSummary = highlightSummaryHtml(item.summary, query);
  const timeLabel = showDayMeta
    ? `${escapeHtml(item.dayName)} · ${escapeHtml(item.dayDate)} · ${escapeHtml(item.time)}`
    : escapeHtml(item.time);

  const titleHtml = openMeta.openUrl
    ? `<h3><a class="card-link-title" href="${escapeHtml(openMeta.openUrl)}" target="_blank" rel="noopener noreferrer">${renderedTitle}</a></h3>`
    : `<h3>${renderedTitle}</h3>`;

  const openAction = openMeta.openUrl
    ? `<a class="open-link" href="${escapeHtml(openMeta.openUrl)}" target="_blank" rel="noopener noreferrer">${openMeta.openLabel}</a>`
    : '';

  const saveBtn = `
    <button
      class="card-action card-save ${isSaved ? 'is-on' : ''}"
      type="button"
      data-card-action="toggle-save"
      aria-label="${isSaved ? 'Unsave' : 'Save'}"
      title="${isSaved ? 'Unsave' : 'Save'}"
    >${isSaved ? '★' : '☆'}</button>
  `;

  const menuBtn = `
    <button
      class="card-action card-menu-btn"
      type="button"
      data-card-action="menu"
      aria-label="More actions"
      title="More actions"
    >⋯</button>
  `;

  const pollsterLine = STATE.pollsterMode
    ? `<div class="pollster-line">Likely read: ${pollReadProbability(item)}% · Weighting efficiency: ${pollWeightingEfficiency(item)}%</div>`
    : '';

  return `
    <article
      class="newsletter-card${isRead ? ' is-read' : ''}${isSaved ? ' is-saved' : ''}${isRedBoxed ? ' is-red-boxed' : ''}${isFocused ? ' is-focused' : ''}"
      data-item-key="${escapeHtml(itemKey)}"
      data-sender-key="${escapeHtml(senderKey)}"
      data-source="${escapeHtml(item.source || '')}"
      data-open-url="${escapeHtml(openMeta.openUrl || '')}"
    >
      <div class="card-meta">
        <span class="source-tag ${sourceClass(item.source)}">${escapeHtml(item.sourceLabel)}</span>${isRedBoxed ? '<span class="red-box-label">RED BOX</span>' : ''}
        <span class="time">${timeLabel}${isRead ? '<span class="read-check">\u2713</span>' : ''}</span>
        <span class="from">${safeFrom}</span>
        ${saveBtn}
        ${menuBtn}
        ${openAction}
      </div>
      ${pollsterLine}
      ${titleHtml}
      <div class="summary">${renderedSummary}</div>
      <div class="topics">
        ${(item.topics || []).map(topic => `<span class="topic">${escapeHtml(topic)}</span>`).join('')}
      </div>
    </article>
  `;
}

function renderEmptyDay(day) {
  const isToday = day.key === getTodayKey() && !STATE.activeArchiveWeekId;
  const emptyIcon = isToday && isLateEdition() ? '🌙' : '📭';
  const emptyMsg = isToday && isLateEdition()
    ? 'No newsletters arrived. The House has adjourned.'
    : 'No newsletters arrived this day.';
  const greeting = isToday ? `<div class="time-greeting">${getTimeOfDayLabel()}</div>` : '';
  DOM.content.innerHTML = `
    <div class="day-content active">
      <div class="day-header">
        <h2>${escapeHtml(day.name)}</h2>
        <div class="date-full">${escapeHtml(day.dateFull)}</div>
        ${greeting}
      </div>
      <div class="empty-day">
        <div class="empty-icon">${emptyIcon}</div>
        <p>${emptyMsg}</p>
      </div>
    </div>
  `;
}

function renderDayContent() {
  const days = Array.isArray(STATE.dataView.days) ? STATE.dataView.days : [];
  const day = days.find(row => row.key === STATE.activeDayKey) || days[0];
  if (!day) return;

  const itemsForDay = STATE.weekIndex.filter(row => row.dayKey === day.key && !isMutedRow(row));
  const sorted = sortItems(itemsForDay, STATE.sortMode);
  renderFiltersMeta(sorted.length);

  if (!sorted.length) {
    DOM.resultsBanner.hidden = true;
    renderEmptyDay(day);
    return;
  }

  DOM.resultsBanner.hidden = true;
  const isToday = day.key === getTodayKey() && !STATE.activeArchiveWeekId;
  const greeting = isToday ? `<div class="time-greeting">${getTimeOfDayLabel()}</div>` : '';
  const cards = sorted.map(item => renderCard(item, STATE.query, false)).join('');
  DOM.content.innerHTML = `
    <div class="day-content active">
      <div class="day-header">
        <h2>${escapeHtml(day.name)}</h2>
        <div class="date-full">${escapeHtml(day.dateFull)}</div>
        ${greeting}
      </div>
      ${cards}
    </div>
  `;
}

function renderFilteredResults() {
  const filtered = sortItems(filterItems(STATE.weekIndex, STATE.query, STATE.activeTopic), STATE.sortMode);
  renderFiltersMeta(filtered.length);

  const filterBits = [];
  if (STATE.query.trim()) filterBits.push(`query "<strong>${escapeHtml(STATE.query.trim())}</strong>"`);
  if (STATE.activeTopic) filterBits.push(`topic "<strong>${escapeHtml(STATE.activeTopic)}</strong>"`);
  if (normalizeViewMode(STATE.viewMode) !== 'all') {
    const label = STATE.viewMode === 'saved' ? 'Saved' : 'Unread';
    filterBits.push(`view "<strong>${label}</strong>"`);
  }
  const appliedLabel = filterBits.length ? filterBits.join(' + ') : 'active filters';
  DOM.resultsBanner.hidden = false;
  DOM.resultsBanner.innerHTML = `Showing <strong>${filtered.length}</strong> items for ${appliedLabel}.`;

  if (!filtered.length) {
    DOM.content.innerHTML = `
      <div class="day-content active">
        <div class="day-header">
          <h2>Filtered Results</h2>
          <div class="date-full">${STATE.activeArchiveWeekId ? 'Across selected archive week' : 'Across the whole week'}</div>
        </div>
        <div class="results-empty">
          No items match these filters.
        </div>
      </div>
    `;
    return;
  }

  const cards = filtered.map(item => renderCard(item, STATE.query, true)).join('');
  DOM.content.innerHTML = `
    <div class="day-content active">
      <div class="day-header">
        <h2>Filtered Results</h2>
        <div class="date-full">${STATE.activeArchiveWeekId ? 'Across selected archive week' : 'Across the whole week'}</div>
      </div>
      ${cards}
    </div>
  `;
}

function renderContent() {
  updateActiveTabUi();
  renderTopicHeat();
  if (STATE.query.trim() || STATE.activeTopic || normalizeViewMode(STATE.viewMode) !== 'all') {
    renderFilteredResults();
  } else {
    renderDayContent();
  }
  afterRender();
}

function getLatestDayWithContent(data) {
  const days = (data || STATE.dataView).days || [];
  const now = new Date();
  now.setHours(23, 59, 59, 999);
  // Prefer the latest day that has content and whose date is not in the future
  for (let i = days.length - 1; i >= 0; i--) {
    if (!days[i].items || !days[i].items.length) continue;
    if (days[i].dateFull) {
      const dayDate = new Date(days[i].dateFull);
      if (!isNaN(dayDate) && dayDate > now) continue;
    }
    return days[i].key;
  }
  // Fallback: latest day with any content at all
  for (let i = days.length - 1; i >= 0; i--) {
    if (days[i].items && days[i].items.length > 0) return days[i].key;
  }
  return days[0]?.key || getTodayKey();
}

function setActiveTab(key, options = {}) {
  const dayKeys = (STATE.dataView.days || []).map(day => day.key);
  const candidate = key || getLatestDayWithContent();
  STATE.activeDayKey = dayKeys.includes(candidate) ? candidate : (getLatestDayWithContent());
  if (options.render !== false) {
    renderContent();
  }
}

function updateSortUi() {
  DOM.sortBtn.textContent = `Sort: ${STATE.sortMode === 'source' ? 'Source' : 'Newest'}`;
}

function applyTheme(themeMode) {
  const mode = themeMode === 'light' || themeMode === 'dark' || themeMode === 'system'
    ? themeMode
    : 'system';
  STATE.theme = mode;
  localStorage.setItem(STORAGE_KEYS.theme, mode);

  const resolved = mode === 'system'
    ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
    : mode;

  document.documentElement.setAttribute('data-theme', resolved);
  DOM.themeBtn.textContent = `Theme: ${mode === 'system' ? 'Auto' : (mode === 'dark' ? 'Dark' : 'Light')}`;
}

function cycleTheme() {
  const order = ['system', 'dark', 'light'];
  const idx = order.indexOf(STATE.theme);
  const next = order[(idx + 1) % order.length];
  applyTheme(next);
}

function renderArchiveOptions() {
  const options = [`<option value="current">Archive: Current Week</option>`];
  STATE.archiveWeeks.forEach(week => {
    const label = week.week_label || week.week_id || 'Archived week';
    const selected = STATE.activeArchiveWeekId === week.week_id ? ' selected' : '';
    options.push(`<option value="${escapeHtml(week.week_id || '')}"${selected}>Archive: ${escapeHtml(label)}</option>`);
  });
  DOM.archiveSelect.innerHTML = options.join('');
  if (!STATE.activeArchiveWeekId) DOM.archiveSelect.value = 'current';
}

async function loadArchiveWeeks() {
  if (!canUseApi()) {
    renderArchiveOptions();
    return;
  }
  try {
    const response = await fetch('/api/archive', { cache: 'no-store' });
    if (!response.ok) return;
    const payload = await response.json();
    const weeks = Array.isArray(payload?.weeks) ? payload.weeks : [];
    const unique = [];
    const seen = new Set();
    weeks.forEach(entry => {
      if (!entry || typeof entry !== 'object') return;
      const weekId = String(entry.week_id || '');
      if (!weekId || seen.has(weekId)) return;
      const weekData = toWeekData(entry);
      if (!weekData || !Array.isArray(weekData.days) || !weekData.days.length) return;
      seen.add(weekId);
      unique.push({ ...entry, days: weekData.days });
    });
    STATE.archiveWeeks = unique;
    renderArchiveOptions();
  } catch (_error) {
    renderArchiveOptions();
  }
}

function applyArchiveSelection(value, options = {}) {
  const shouldRender = options.render !== false;
  if (!value || value === 'current') {
    STATE.activeArchiveWeekId = null;
    STATE.dataView = DATA;
    setWeekLabel(STATE.currentWeekLabel);
    clearActiveFilters();
    syncWeekCaches();
    renderTabs();
    setActiveTab(getLatestDayWithContent(DATA), { render: shouldRender });
    renderArchiveOptions();
    return;
  }

  const selected = STATE.archiveWeeks.find(entry => String(entry.week_id) === String(value));
  const selectedData = selected ? toWeekData(selected) : null;
  if (!selected || !selectedData) return;

  STATE.activeArchiveWeekId = String(selected.week_id);
  STATE.dataView = selectedData;
  setWeekLabel(selected.week_label || selected.week_id || STATE.currentWeekLabel);
  clearActiveFilters();
  syncWeekCaches();
  renderTabs();
  setActiveTab(getLatestDayWithContent(selectedData), { render: shouldRender });
  renderArchiveOptions();
}

async function runRefresh() {
  if (!canUseApi()) {
    window.alert('Refresh button needs the local server. Run: .venv/bin/python scripts/serve_digest.py');
    return;
  }

  const originalLabel = DOM.refreshBtn.textContent;
  DOM.refreshBtn.disabled = true;
  DOM.refreshBtn.textContent = 'Refreshing...';

  try {
    const response = await fetch('/api/refresh', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CW-Digest-Request': 'refresh'
      },
      body: JSON.stringify({ source: 'all', max_results: 25, ai_summaries: true, ai_model: 'gpt-4o-mini' })
    });
    const payload = await response.json().catch(() => ({}));
    if (!response.ok) {
      const details = [payload?.error, payload?.stderr, payload?.stdout]
        .map(value => (typeof value === 'string' ? value.trim() : ''))
        .filter(Boolean)
        .join('\n\n');
      throw new Error(details || 'Refresh failed.');
    }

    DOM.refreshBtn.textContent = 'Updated';
    STATE.lastRefreshAt = Date.now();
    persistLastRefreshAt();
    updateRefreshMeta();
    updateSearchToggleMeta();
    await loadArchiveWeeks();
    window.location.reload();
  } catch (error) {
    console.error(error);
    DOM.refreshBtn.textContent = 'Refresh failed';
    const msg = error instanceof Error ? error.message : String(error || '');
    window.alert(`Refresh failed.\n\n${msg || 'Check terminal/server logs and retry.'}`);
    setTimeout(() => {
      DOM.refreshBtn.textContent = originalLabel;
    }, 1600);
  } finally {
    DOM.refreshBtn.disabled = false;
  }
}

function debounce(fn, delayMs) {
  let timer = null;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delayMs);
  };
}

function updateReadingProgress() {
  const doc = document.documentElement;
  const max = doc.scrollHeight - window.innerHeight;
  const ratio = max > 0 ? (window.scrollY / max) * 100 : 0;
  DOM.progressBar.style.width = `${Math.max(0, Math.min(100, ratio)).toFixed(2)}%`;
}

function initFaceWidget() {
  DOM.faceImage.alt = 'Calum avatar';
  if (!UI_ASSETS.faceSrc) {
    DOM.faceWidget.classList.add('fallback');
    return;
  }
  DOM.faceImage.src = UI_ASSETS.faceSrc;
  DOM.faceImage.addEventListener('load', () => DOM.faceWidget.classList.remove('fallback'));
  DOM.faceImage.addEventListener('error', () => DOM.faceWidget.classList.add('fallback'));
}

function bindEvents() {
  DOM.tabs.addEventListener('click', event => {
    const tab = event.target.closest('.day-tab');
    if (!tab) return;
    setActiveTab(tab.dataset.key);
    writeUrlState({ mode: 'push' });
  });

  DOM.topicHeat.addEventListener('click', event => {
    const chip = event.target.closest('.topic-chip');
    if (!chip) return;
    const topic = chip.dataset.topic || null;
    STATE.activeTopic = topic || null;
    renderContentPreservingFocus();
    writeUrlState({ mode: 'push' });
  });

  DOM.sortBtn.addEventListener('click', () => {
    STATE.sortMode = STATE.sortMode === 'newest' ? 'source' : 'newest';
    localStorage.setItem(STORAGE_KEYS.sortMode, STATE.sortMode);
    updateSortUi();
    renderContentPreservingFocus();
    writeUrlState({ mode: 'replace' });
  });

  if (DOM.viewToggle) {
    DOM.viewToggle.addEventListener('click', event => {
      const btn = event.target.closest('.view-btn');
      if (!btn) return;
      setViewMode(btn.dataset.view || 'all');
      renderContentPreservingFocus();
      writeUrlState({ mode: 'push' });
    });
  }

  DOM.searchToggleBtn.addEventListener('click', () => {
    const nextVisible = !STATE.searchVisible;
    setSearchVisibility(nextVisible, { focus: nextVisible });
    if (!nextVisible) {
      renderContentPreservingFocus();
      // Hiding the panel clears filters/view; keep URL in sync.
      writeUrlState({ mode: 'push' });
    }
  });

  DOM.themeBtn.addEventListener('click', cycleTheme);
  DOM.refreshBtn.addEventListener('click', () => {
    void runRefresh();
  });
  DOM.archiveSelect.addEventListener('change', event => {
    const value = event.target instanceof HTMLSelectElement ? event.target.value : 'current';
    applyArchiveSelection(value);
    writeUrlState({ mode: 'push' });
  });

  const onSearchInput = debounce(() => {
    STATE.query = DOM.searchInput.value;
    renderContentPreservingFocus();
    writeUrlState({ mode: 'replace' });
  }, 100);

  DOM.searchInput.addEventListener('input', onSearchInput);

  DOM.clearSearchBtn.addEventListener('click', () => {
    DOM.searchInput.value = '';
    STATE.query = '';
    renderContentPreservingFocus();
    writeUrlState({ mode: 'replace' });
  });

  if (DOM.filtersMeta) {
    DOM.filtersMeta.addEventListener('click', event => {
      const clear = event.target.closest('#clearFilters');
      if (!clear) return;
      clearActiveFilters({ clearView: true });
      renderContentPreservingFocus();
      writeUrlState({ mode: 'push' });
    });
  }

  if (DOM.content) {
    DOM.content.addEventListener('click', event => {
      const card = event.target.closest('.newsletter-card[data-item-key]');
      const itemKey = card?.dataset.itemKey || null;

      // Click sets keyboard focus target.
      if (itemKey) {
        STATE.focusedItemKey = itemKey;
        applyFocusUi({ scroll: false });
      }

      const actionBtn = event.target.closest('button.card-action[data-card-action]');
      if (actionBtn && itemKey) {
        const action = actionBtn.dataset.cardAction;
        if (action === 'toggle-save') {
          toggleItemSaved(itemKey);
          renderContentPreservingFocus();
          return;
        }
        if (action === 'menu') {
          const rect = actionBtn.getBoundingClientRect();
          openCardMenu(itemKey, rect);
          return;
        }
      }

      const link = event.target.closest('a.card-link-title, a.open-link');
      if (link && itemKey) {
        markItemRead(itemKey);
        if (normalizeViewMode(STATE.viewMode) === 'unread') {
          setTimeout(() => renderContentPreservingFocus(), 0);
        } else {
          card?.classList.add('is-read');
        }
      }
    });
  }

  if (DOM.cardMenu) {
    DOM.cardMenu.addEventListener('click', event => {
      const btn = event.target.closest('button.menu-item[data-menu-action]');
      if (!btn || !activeMenuItemKey) return;
      const action = btn.dataset.menuAction;
      const card = document.querySelector(`.newsletter-card[data-item-key="${cssEscape(activeMenuItemKey)}"]`);
      const senderKey = card?.dataset.senderKey || '';
      const sourceKey = card?.dataset.source || '';

      if (action === 'toggle-save') {
        toggleItemSaved(activeMenuItemKey);
        closeCardMenu();
        renderContentPreservingFocus();
        return;
      }
      if (action === 'toggle-read') {
        toggleItemRead(activeMenuItemKey);
        closeCardMenu();
        renderContentPreservingFocus();
        return;
      }
      if (action === 'mute-sender' && senderKey) {
        STATE.mutedSenders.add(senderKey);
        persistMutes();
        closeCardMenu();
        renderTabs();
        renderContentPreservingFocus();
        return;
      }
      if (action === 'mute-source' && sourceKey) {
        STATE.mutedSources.add(sourceKey);
        persistMutes();
        closeCardMenu();
        renderTabs();
        renderContentPreservingFocus();
        return;
      }
    });
  }

  if (DOM.muteManager) {
    DOM.muteManager.addEventListener('click', event => {
      const chip = event.target.closest('button.mute-chip[data-mute-type][data-mute-value]');
      if (!chip) return;
      const type = chip.dataset.muteType;
      const value = chip.dataset.muteValue;
      if (!type || !value) return;
      if (type === 'sender') STATE.mutedSenders.delete(value);
      if (type === 'source') STATE.mutedSources.delete(value);
      persistMutes();
      renderTabs();
      renderContentPreservingFocus();
    });
  }

  if (DOM.clearMutes) {
    DOM.clearMutes.addEventListener('click', () => {
      STATE.mutedSenders = new Set();
      STATE.mutedSources = new Set();
      persistMutes();
      renderTabs();
      renderContentPreservingFocus();
    });
  }

  if (DOM.shortcutsClose) {
    DOM.shortcutsClose.addEventListener('click', closeShortcutsOverlay);
  }
  if (DOM.shortcutsOverlay) {
    DOM.shortcutsOverlay.addEventListener('click', event => {
      if (event.target === DOM.shortcutsOverlay) closeShortcutsOverlay();
    });
  }

  // Command palette
  if (DOM.cmdPalette) {
    DOM.cmdPalette.addEventListener('click', event => {
      if (event.target === DOM.cmdPalette) closeCmdPalette();
    });
  }

  if (DOM.cmdPaletteInput) {
    DOM.cmdPaletteInput.addEventListener('input', () => {
      paletteActiveIdx = 0;
      renderPaletteResults(filterPaletteItems(paletteAllItems, DOM.cmdPaletteInput.value));
    });

    DOM.cmdPaletteInput.addEventListener('keydown', event => {
      if (event.key === 'Escape') {
        event.preventDefault();
        closeCmdPalette();
        return;
      }

      if (event.key === 'ArrowDown') {
        event.preventDefault();
        if (!paletteVisibleItems.length) return;
        paletteActiveIdx = (paletteActiveIdx + 1) % paletteVisibleItems.length;
        updatePaletteActive();
        return;
      }

      if (event.key === 'ArrowUp') {
        event.preventDefault();
        if (!paletteVisibleItems.length) return;
        paletteActiveIdx = (paletteActiveIdx - 1 + paletteVisibleItems.length) % paletteVisibleItems.length;
        updatePaletteActive();
        return;
      }

      if (event.key === 'Enter') {
        event.preventDefault();
        const picked = paletteVisibleItems[paletteActiveIdx] || null;
        closeCmdPalette();
        _runPaletteItem(picked);
        return;
      }
    });
  }

  if (DOM.cmdPaletteResults) {
    DOM.cmdPaletteResults.addEventListener('mouseover', event => {
      const row = event.target.closest('.cmd-result');
      if (!row) return;
      const idx = Number(row.dataset.idx);
      if (!Number.isFinite(idx)) return;
      if (idx === paletteActiveIdx) return;
      paletteActiveIdx = idx;
      updatePaletteActive({ scroll: false });
    });

    DOM.cmdPaletteResults.addEventListener('click', event => {
      const row = event.target.closest('.cmd-result');
      if (!row) return;
      const idx = Number(row.dataset.idx);
      if (!Number.isFinite(idx)) return;
      paletteActiveIdx = idx;
      const picked = paletteVisibleItems[paletteActiveIdx] || null;
      closeCmdPalette();
      _runPaletteItem(picked);
    });
  }

  if (DOM.faceWidget) {
    DOM.faceWidget.addEventListener('click', handleFaceWidgetClickEgg);
  }
  if (DOM.weekLabel) {
    DOM.weekLabel.addEventListener('mouseenter', handleWeekLabelHoverEgg);
  }

  // Dispatch Box: close
  if (DOM.dispatchClose) {
    DOM.dispatchClose.addEventListener('click', closeDispatchOverlay);
  }
  if (DOM.dispatchOverlay) {
    DOM.dispatchOverlay.addEventListener('click', event => {
      if (event.target === DOM.dispatchOverlay) closeDispatchOverlay();
    });
  }
  if (DOM.blackrodClose) {
    DOM.blackrodClose.addEventListener('click', closeBlackrodOverlay);
  }
  if (DOM.blackrodOverlay) {
    DOM.blackrodOverlay.addEventListener('click', event => {
      if (event.target === DOM.blackrodOverlay) closeBlackrodOverlay();
    });
  }

  document.addEventListener('click', event => {
    if (!DOM.cardMenu || DOM.cardMenu.hidden) return;
    if (event.target.closest('#cardMenu')) return;
    if (event.target.closest('[data-card-action="menu"]')) return;
    closeCardMenu();
  });

  document.addEventListener('keydown', event => {
    const target = event.target;
    const isTyping = target instanceof HTMLElement
      && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);

    if ((event.metaKey || event.ctrlKey) && String(event.key || '').toLowerCase() === 'k') {
      event.preventDefault();
      toggleCmdPalette();
      return;
    }

    if (event.key === 'Escape') {
      if (cmdPaletteOpen) {
        event.preventDefault();
        closeCmdPalette();
        return;
      }
      if (blackrodOpen) {
        event.preventDefault();
        closeBlackrodOverlay();
        return;
      }
      if (dispatchOpen) {
        event.preventDefault();
        closeDispatchOverlay();
        return;
      }
      if (orderPanelOpen) {
        event.preventDefault();
        closeOrderPanel();
        return;
      }
      if (whipPanelOpen) {
        event.preventDefault();
        closeWhipPanel();
        return;
      }
      if (shortcutsOpen) {
        event.preventDefault();
        closeShortcutsOverlay();
        return;
      }
      if (openQuickFolder !== null) {
        event.preventDefault();
        closeQuickDropdown();
        return;
      }
      if (DOM.cardMenu && !DOM.cardMenu.hidden) {
        event.preventDefault();
        closeCardMenu();
        return;
      }
    }

    if (cmdPaletteOpen) return;

    // Let all sequence detectors build buffers independently.
    // Only consume the key if one of them actually triggers.
    const _pollFired = handlePollsterModeSequence(event.key, isTyping);
    const _pmqFired = handleDispatchSequence(event.key, isTyping);
    const _konamiFired = handleKonamiSequence(event.key, isTyping);
    const _resignFired = handleResignSequence(event.key, isTyping);
    if (_pollFired || _pmqFired || _konamiFired || _resignFired) return;

    if (event.key === '?' && !isTyping) {
      event.preventDefault();
      toggleShortcutsOverlay();
      return;
    }

    if (shortcutsOpen) return;
    if (blackrodOpen) return;

    if (event.key === '/' && !isTyping) {
      event.preventDefault();
      if (!STATE.searchVisible) {
        setSearchVisibility(true, { focus: true });
        renderContentPreservingFocus();
      } else {
        DOM.searchInput.focus();
        DOM.searchInput.select();
      }
      return;
    }

    if (event.key === 'Escape' && document.activeElement === DOM.searchInput) {
      DOM.searchInput.value = '';
      STATE.query = '';
      DOM.searchInput.blur();
      renderContentPreservingFocus();
      writeUrlState({ mode: 'replace' });
      return;
    }

    if (isTyping) return;

    if (event.key === 'j') {
      event.preventDefault();
      moveFocus(1);
      return;
    }
    if (event.key === 'k') {
      event.preventDefault();
      moveFocus(-1);
      return;
    }
    if (event.key === 'Enter') {
      openFocusedCard();
      return;
    }
    if (event.key === 's') {
      if (!STATE.focusedItemKey) return;
      toggleItemSaved(STATE.focusedItemKey);
      renderContentPreservingFocus();
      return;
    }
    if (event.key === 'r') {
      if (!STATE.focusedItemKey) return;
      toggleItemRead(STATE.focusedItemKey);
      renderContentPreservingFocus();
      return;
    }
    if (event.key === 'a') {
      event.preventDefault();
      batchMarkVisibleRead();
      return;
    }
    if (event.key === 't') {
      event.preventDefault();
      toggleWhipPanel();
      return;
    }
    if (event.key === 'o') {
      event.preventDefault();
      toggleOrderPanel();
      return;
    }
    if (event.key === 'f') {
      event.preventDefault();
      toggleBlackrodOverlay();
      return;
    }
    if (event.key === 'e') {
      event.preventDefault();
      jumpToRandomUnread();
      return;
    }
    if (event.key === 'p') {
      event.preventDefault();
      toggleTodoPanel();
      return;
    }
    if (event.key === '/' && _isTodoPanelOpen()) {
      event.preventDefault();
      toggleTodoSearch();
      return;
    }
  });

  window.addEventListener('popstate', () => {
    applyUrlState(readUrlState(), { autoExpandPanel: false });
  });

  window.addEventListener('scroll', () => {
    updateReadingProgress();
    if (DOM.cardMenu && !DOM.cardMenu.hidden) closeCardMenu();
  }, { passive: true });
  window.addEventListener('resize', () => {
    updateReadingProgress();
    if (DOM.cardMenu && !DOM.cardMenu.hidden) closeCardMenu();
  });

  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  try {
    mq.addEventListener('change', () => {
      if (STATE.theme === 'system') applyTheme('system');
    });
  } catch (_error) {
    if (typeof mq.addListener === 'function') {
      mq.addListener(() => {
        if (STATE.theme === 'system') applyTheme('system');
      });
    }
  }

  // — Prorogation: idle detection —
  const idleResetHandler = () => {
    if (prorogued) { hideProrogation(); return; }
    resetIdleTimer();
  };
  document.addEventListener('mousemove', idleResetHandler, { passive: true });
  document.addEventListener('scroll', idleResetHandler, { passive: true });
  document.addEventListener('touchstart', idleResetHandler, { passive: true });
  document.addEventListener('keydown', idleResetHandler);
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (idleTimer) clearTimeout(idleTimer);
    } else {
      if (prorogued) hideProrogation();
      else resetIdleTimer();
    }
  });

  // — Mobile swipe: day navigation —
  if (DOM.mainContent) {
    DOM.mainContent.addEventListener('touchstart', event => {
      if (event.touches.length === 1) {
        touchStartX = event.touches[0].clientX;
        touchStartY = event.touches[0].clientY;
      }
    }, { passive: true });

    DOM.mainContent.addEventListener('touchend', event => {
      if (event.changedTouches.length !== 1) return;
      const deltaX = event.changedTouches[0].clientX - touchStartX;
      const deltaY = event.changedTouches[0].clientY - touchStartY;
      if (Math.abs(deltaX) < 50 || Math.abs(deltaX) < Math.abs(deltaY)) return;
      const days = (STATE.dataView?.days || []);
      const currentIdx = days.findIndex(d => d.key === STATE.activeDayKey);
      if (currentIdx < 0) return;
      const newIdx = deltaX > 0 ? currentIdx - 1 : currentIdx + 1;
      if (newIdx < 0 || newIdx >= days.length) return;
      setActiveTab(days[newIdx].key);
      writeUrlState({ mode: 'replace' });
    }, { passive: true });
  }
}

// — Weather line (Open-Meteo, no API key) —
const WMO_WEATHER_CODES = {
  0: 'Clear', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
  45: 'Fog', 48: 'Rime fog',
  51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
  56: 'Freezing drizzle', 57: 'Heavy freezing drizzle',
  61: 'Light rain', 63: 'Rain', 65: 'Heavy rain',
  66: 'Freezing rain', 67: 'Heavy freezing rain',
  71: 'Light snow', 73: 'Snow', 75: 'Heavy snow', 77: 'Snow grains',
  80: 'Light showers', 81: 'Showers', 82: 'Heavy showers',
  85: 'Light snow showers', 86: 'Heavy snow showers',
  95: 'Thunderstorm', 96: 'Thunderstorm + hail', 99: 'Heavy thunderstorm'
};

async function fetchWeather() {
  if (!DOM.weatherLine) return;
  try {
    const resp = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.5074&longitude=-0.1278&current=temperature_2m,weather_code');
    if (!resp.ok) throw new Error(resp.status);
    const data = await resp.json();
    const temp = Math.round(data.current.temperature_2m);
    const desc = WMO_WEATHER_CODES[data.current.weather_code] || 'Unknown';
    DOM.weatherLine.textContent = `${temp}\u00B0C \u00B7 ${desc}`;
  } catch {
    DOM.weatherLine.textContent = '\u2014';
  }
}

// — Quick links (bookmark folders) —
const QUICK_FOLDERS = [];

let openQuickFolder = null;

function renderQuickLinks() {
  if (!DOM.quickLinks) return;
  if (!QUICK_FOLDERS.length) {
    DOM.quickLinks.hidden = true;
    DOM.quickLinks.innerHTML = '';
    openQuickFolder = null;
    return;
  }
  DOM.quickLinks.hidden = false;
  DOM.quickLinks.innerHTML = QUICK_FOLDERS.map((folder, i) =>
    `<span class="quick-folder" data-folder-idx="${i}">${escapeHtml(folder.label)}</span>`
  ).join('') + '<div class="quick-dropdown" id="quickDropdown"></div>';
}

function openQuickDropdown(idx) {
  const folder = QUICK_FOLDERS[idx];
  if (!folder) return;
  const dropdown = document.getElementById('quickDropdown');
  if (!dropdown) return;

  const pill = DOM.quickLinks.querySelector(`.quick-folder[data-folder-idx="${idx}"]`);

  // Close if same folder clicked
  if (openQuickFolder === idx) { closeQuickDropdown(); return; }

  // Position dropdown relative to the clicked pill
  if (pill) {
    const parentRect = DOM.quickLinks.getBoundingClientRect();
    const pillRect = pill.getBoundingClientRect();
    dropdown.style.left = (pillRect.left - parentRect.left) + 'px';
  }

  const linksHtml = (folder.links || []).map(link => {
    const safeUrl = normalizeSafeUrl(link.url);
    if (!safeUrl) return '';
    return `<a href="${escapeHtml(safeUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link.name)}</a>`;
  }).join('');
  dropdown.innerHTML = linksHtml || '<span class="quick-link-empty">No valid links</span>';

  // Toggle open states
  DOM.quickLinks.querySelectorAll('.quick-folder').forEach(el => el.classList.remove('open'));
  if (pill) pill.classList.add('open');
  dropdown.classList.add('show');
  openQuickFolder = idx;
}

function closeQuickDropdown() {
  const dropdown = document.getElementById('quickDropdown');
  if (dropdown) dropdown.classList.remove('show');
  DOM.quickLinks?.querySelectorAll('.quick-folder').forEach(el => el.classList.remove('open'));
  openQuickFolder = null;
}

function bindQuickLinkEvents() {
  if (!DOM.quickLinks) return;
  if (!QUICK_FOLDERS.length) return;
  DOM.quickLinks.addEventListener('click', event => {
    const pill = event.target.closest('.quick-folder');
    if (pill) {
      openQuickDropdown(Number(pill.dataset.folderIdx));
      return;
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', event => {
    if (openQuickFolder === null) return;
    if (!event.target.closest('.quick-links')) closeQuickDropdown();
  });
}

// — Order Paper: right-side to-do panel —
const TODO_STORAGE_KEY = 'cw-digest-todos';
const TODO_PANEL_OPEN_KEY = 'cw-digest-todo-panel-open';
const PRIORITY_CYCLE = ['none', 'high', 'med', 'low'];
let todoDragId = null;
let todoDragParentId = '';
let todoSubtaskParent = null;

	function loadTodos() {
	  try {
	    const raw = localStorage.getItem(TODO_STORAGE_KEY);
	    let arr = raw ? JSON.parse(raw) : [];
	    if (!Array.isArray(arr)) arr = [];
	    // Migrate old items
	    arr.forEach((t, i) => {
	      if (!t || typeof t !== 'object') return;
	      if (typeof t.id !== 'number') {
	        const idNum = Number(t.id);
	        if (Number.isFinite(idNum)) t.id = idNum;
	      }
	      if (typeof t.id !== 'number' || !Number.isFinite(t.id)) t.id = Date.now() + i;
	      if (typeof t.text !== 'string') t.text = String(t.text ?? '').trim();
	      if (!t.text) t.text = '(Untitled)';
	      if (t.priority === undefined) t.priority = 'none';
	      if (!PRIORITY_CYCLE.includes(t.priority)) t.priority = 'none';
	      if (t.due === undefined) t.due = null;
	      if (typeof t.done !== 'boolean') t.done = Boolean(t.done);
	      if (t.parentId === undefined || t.parentId === '') t.parentId = null;
	      if (t.parentId !== null && typeof t.parentId !== 'number') {
	        const pidNum = Number(t.parentId);
	        t.parentId = Number.isFinite(pidNum) ? pidNum : null;
	      }
	      if (t.order === undefined) t.order = i;
	      if (typeof t.order !== 'number') {
	        const orderNum = Number(t.order);
	        t.order = Number.isFinite(orderNum) ? orderNum : i;
	      }
	      if (t.collapsed === undefined) t.collapsed = false;
	      if (typeof t.collapsed !== 'boolean') t.collapsed = Boolean(t.collapsed);
	      if (typeof t.notes !== 'string') t.notes = String(t.notes ?? '');
	    });

	    // Repair orphaned parent pointers (treat as top-level).
	    const ids = new Set(arr.map(t => (t && typeof t.id === 'number') ? t.id : null).filter(v => v !== null));
	    arr.forEach(t => {
	      if (!t || typeof t !== 'object') return;
	      if (t.parentId !== null && !ids.has(t.parentId)) t.parentId = null;
	    });
	    return arr;
	  } catch { return []; }
	}

function saveTodos(todos) {
  localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todos));
}

/* — Notes popup — */
let todoOpenNotesId = null;
let todoNotesSaveTimer = null;
let todoUndoStack = null;   // { items: [...], timer: timeoutId }
let todoFilterText = '';

function openTodoNotes(id) {
  closeTodoNotes();

  const todos = loadTodos();
  const item = todos.find(t => t.id === id);
  if (!item) return;

  todoOpenNotesId = id;
  const priLabels = { none: '\u2022', high: '#high', med: '#med', low: '#low' };
  const priColors = { none: 'var(--muted)', high: '#c0392b', med: '#e67e22', low: '#27ae60' };
  const priority = PRIORITY_CYCLE.includes(item.priority) ? item.priority : 'none';
  const wc = (s) => (s || '').trim().split(/\s+/).filter(Boolean).length;

  const overlay = document.createElement('div');
  overlay.className = 'todo-notes-overlay';
  overlay.id = 'todoNotesOverlay';
  overlay.innerHTML = `<div class="todo-notes-popup">
    <div class="todo-notes-popup-header">
      <label class="todo-notes-check-wrap" title="Toggle done">
        <input type="checkbox" class="todo-notes-done-check" ${item.done ? 'checked' : ''}>
      </label>
      <span class="todo-notes-popup-title${item.done ? ' done' : ''}">${escapeHtml(item.text)}</span>
      <button class="todo-notes-pri-btn" data-pri="${priority}" title="Cycle priority" style="color:${priColors[priority]}">${priLabels[priority]}</button>
      <button class="todo-notes-popup-close" title="Close (Esc)">\u00D7</button>
    </div>
    <div class="todo-notes-toolbar">
      <button class="todo-notes-fmt" data-fmt="bold" title="Bold (Cmd+B)"><b>B</b></button>
      <button class="todo-notes-fmt" data-fmt="italic" title="Italic (Cmd+I)"><i>I</i></button>
      <button class="todo-notes-fmt" data-fmt="heading" title="Heading">H</button>
      <button class="todo-notes-fmt" data-fmt="list" title="Bullet list">\u2022</button>
      <button class="todo-notes-fmt" data-fmt="task" title="Task checkbox">\u2610</button>
      <span class="todo-notes-toolbar-spacer"></span>
      <button class="todo-notes-copy-btn" title="Copy notes to clipboard">Copy</button>
    </div>
    <div class="todo-notes-popup-body">
      <textarea class="todo-notes-textarea" placeholder="Write notes here... (markdown-friendly for Obsidian)">${escapeHtml(item.notes || '')}</textarea>
      <div class="todo-notes-footer">
        <span class="todo-notes-wc">${wc(item.notes)} words</span>
        <span class="todo-notes-hint">Auto-saves</span>
      </div>
    </div>
  </div>`;

  document.body.appendChild(overlay);

  const textarea = overlay.querySelector('.todo-notes-textarea');
  const closeBtn = overlay.querySelector('.todo-notes-popup-close');
  const wcEl = overlay.querySelector('.todo-notes-wc');
  textarea.focus();

  // Word count + auto-save
  textarea.addEventListener('input', () => {
    wcEl.textContent = `${wc(textarea.value)} words`;
    if (todoNotesSaveTimer) clearTimeout(todoNotesSaveTimer);
    todoNotesSaveTimer = setTimeout(() => saveTodoNotes(id, textarea.value), 400);
  });

  textarea.addEventListener('blur', () => {
    if (todoNotesSaveTimer) clearTimeout(todoNotesSaveTimer);
    saveTodoNotes(id, textarea.value);
  });

  // Formatting toolbar
  overlay.querySelectorAll('.todo-notes-fmt').forEach(btn => {
    btn.addEventListener('click', () => {
      const f = btn.dataset.fmt;
      const s = textarea.selectionStart, e = textarea.selectionEnd;
      const sel = textarea.value.substring(s, e);
      let ins = '';
      if (f === 'bold') ins = `**${sel || 'text'}**`;
      else if (f === 'italic') ins = `*${sel || 'text'}*`;
      else if (f === 'heading') ins = `## ${sel || 'Heading'}`;
      else if (f === 'list') ins = `- ${sel || 'item'}`;
      else if (f === 'task') ins = `- [ ] ${sel || 'task'}`;
      textarea.setRangeText(ins, s, e, 'end');
      textarea.focus();
      textarea.dispatchEvent(new Event('input'));
    });
  });

  // Keyboard shortcuts
  textarea.addEventListener('keydown', ev => {
    ev.stopPropagation();
    if (ev.key === 'Escape') { closeTodoNotes(); return; }
    if ((ev.metaKey || ev.ctrlKey) && ev.key === 'b') {
      ev.preventDefault();
      overlay.querySelector('[data-fmt="bold"]').click();
    }
    if ((ev.metaKey || ev.ctrlKey) && ev.key === 'i') {
      ev.preventDefault();
      overlay.querySelector('[data-fmt="italic"]').click();
    }
  });

  // Copy notes
  overlay.querySelector('.todo-notes-copy-btn').addEventListener('click', () => {
    navigator.clipboard.writeText(textarea.value).then(() => showEggToast('Notes copied')).catch(() => showEggToast('Copy failed'));
  });

  // Done checkbox
  overlay.querySelector('.todo-notes-done-check').addEventListener('change', (ev) => {
    toggleTodoDone(id);
    overlay.querySelector('.todo-notes-popup-title').classList.toggle('done', ev.target.checked);
  });

  // Priority cycle
  overlay.querySelector('.todo-notes-pri-btn').addEventListener('click', () => {
    cyclePriority(id);
    const u = loadTodos().find(t => t.id === id);
    if (u) {
      const b = overlay.querySelector('.todo-notes-pri-btn');
      b.dataset.pri = u.priority;
      b.style.color = priColors[u.priority];
      b.textContent = priLabels[u.priority];
    }
  });

  closeBtn.addEventListener('click', () => closeTodoNotes());
  overlay.addEventListener('click', ev => { if (ev.target === overlay) closeTodoNotes(); });
  overlay.addEventListener('keydown', ev => { if (ev.key === 'Escape') closeTodoNotes(); });
}

function closeTodoNotes() {
  const overlay = document.getElementById('todoNotesOverlay');
  if (overlay) {
    // Final save before closing
    const textarea = overlay.querySelector('.todo-notes-textarea');
    if (textarea && todoOpenNotesId !== null) {
      if (todoNotesSaveTimer) clearTimeout(todoNotesSaveTimer);
      saveTodoNotes(todoOpenNotesId, textarea.value);
    }
    overlay.remove();
  }
  todoOpenNotesId = null;
}

function saveTodoNotes(id, text) {
  const todos = loadTodos();
  const item = todos.find(t => t.id === id);
  if (!item) return;
  item.notes = text || '';
  saveTodos(todos);
  // Update the notes button indicator without full re-render
  const row = DOM.todoPanelList && DOM.todoPanelList.querySelector(`.todo-row[data-todo-id="${id}"]`);
  if (row) {
    const btn = row.querySelector('.todo-notes-toggle');
    if (btn) {
      btn.classList.toggle('has-notes', Boolean(item.notes));
      btn.title = item.notes ? 'Edit notes' : 'Add notes';
    }
  }
}

/* — Inline text editing — */
function startTodoEdit(id) {
  if (!DOM.todoPanelList) return;
  const row = DOM.todoPanelList.querySelector(`.todo-row[data-todo-id="${id}"]`);
  if (!row) return;
  const span = row.querySelector('.todo-text');
  if (!span) return;
  // Don't open edit if already editing
  if (span.querySelector('.todo-edit-input')) return;

  const currentText = span.textContent;
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'todo-edit-input';
  input.value = currentText;
  input.maxLength = 200;

  span.textContent = '';
  span.appendChild(input);
  input.select();
  input.focus();

  const commit = () => {
    const newText = input.value.trim();
    if (newText && newText !== currentText) {
      renameTodo(id, newText);
    } else {
      span.textContent = currentText;
    }
  };

  let committed = false;
  input.addEventListener('keydown', ev => {
    ev.stopPropagation();
    if (ev.key === 'Enter') { committed = true; commit(); }
    if (ev.key === 'Escape') { committed = true; span.textContent = currentText; }
  });
  input.addEventListener('blur', () => {
    if (!committed) commit();
  });
}

function renameTodo(id, text) {
  const todos = loadTodos();
  const item = todos.find(t => t.id === id);
  if (!item) return;
  item.text = text.trim() || item.text;
  saveTodos(todos);
  renderTodoPanel();
}

/* — Undo delete — */
function clearTodoUndo() {
  if (todoUndoStack) {
    if (todoUndoStack.timer) clearTimeout(todoUndoStack.timer);
    todoUndoStack = null;
  }
  const existing = DOM.todoPanel && DOM.todoPanel.querySelector('.todo-undo-toast');
  if (existing) existing.remove();
}

function showUndoToast(count) {
  if (!DOM.todoPanel) return;
  // Remove any existing toast
  const existing = DOM.todoPanel.querySelector('.todo-undo-toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'todo-undo-toast';
  toast.innerHTML = `<span>Deleted ${count} item${count !== 1 ? 's' : ''}</span><button class="todo-undo-btn">Undo</button>`;
  DOM.todoPanel.appendChild(toast);

  toast.querySelector('.todo-undo-btn').addEventListener('click', undoDeleteTodo);
}

function undoDeleteTodo() {
  if (!todoUndoStack) return;
  const todos = loadTodos();
  todoUndoStack.items.forEach(item => todos.push(item));
  clearTodoUndo();
  saveTodos(todos);
  renderTodoPanel();
  showEggToast('Restored');
}

/* — Search / filter — */
function toggleTodoSearch() {
  const existing = DOM.todoPanel && DOM.todoPanel.querySelector('.todo-filter-row');
  const btn = document.getElementById('todoSearchBtn');
  if (existing) {
    existing.remove();
    todoFilterText = '';
    if (btn) btn.classList.remove('active');
    renderTodoPanel();
    return;
  }

  const inputWrap = DOM.todoPanel && DOM.todoPanel.querySelector('.todo-panel-input-wrap');
  if (!inputWrap) return;

  const filterRow = document.createElement('div');
  filterRow.className = 'todo-filter-row';
  filterRow.innerHTML = '<input class="todo-filter-input" type="text" placeholder="Filter items...">';
  inputWrap.after(filterRow);
  if (btn) btn.classList.add('active');

  const filterInput = filterRow.querySelector('.todo-filter-input');
  filterInput.focus();

  filterInput.addEventListener('input', () => {
    todoFilterText = filterInput.value;
    renderTodoPanel();
  });
  filterInput.addEventListener('keydown', ev => {
    ev.stopPropagation();
    if (ev.key === 'Escape') {
      toggleTodoSearch();
    }
  });
}

function filterTodoTree(tree, query) {
  if (!query) return tree;
  const q = query.toLowerCase();

  const nodeMatches = (node) => {
    if ((node.text || '').toLowerCase().includes(q)) return true;
    if ((node.notes || '').toLowerCase().includes(q)) return true;
    return false;
  };

  const filterNode = (node) => {
    const kids = (node.children || []).map(filterNode).filter(Boolean);
    if (nodeMatches(node) || kids.length > 0) {
      return { ...node, children: kids };
    }
    return null;
  };

  return tree.map(filterNode).filter(Boolean);
}

function highlightMatch(text, query) {
  if (!query) return escapeHtml(text);
  const escaped = escapeHtml(text);
  const q = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const re = new RegExp(`(${q})`, 'gi');
  return escaped.replace(re, '<mark>$1</mark>');
}

/* — Obsidian export — */
function exportTodosAsMarkdown() {
  const todos = loadTodos();
  const tree = getTodoTree(todos);

  const priTag = (p) => p === 'high' ? ' #high' : p === 'med' ? ' #medium' : p === 'low' ? ' #low' : '';

  const renderNode = (node, indent) => {
    const check = node.done ? '[x]' : '[ ]';
    let out = `${indent}- ${check} ${node.text}${priTag(node.priority)}\n`;
    if (node.notes && node.notes.trim()) {
      const ni = indent + '  ';
      node.notes.trim().split('\n').forEach(ln => { out += `${ni}${ln}\n`; });
    }
    (node.children || []).forEach(c => { out += renderNode(c, indent + '  '); });
    return out;
  };

  const isSubtreeDone = (n) => {
    if (!n.done) return false;
    return (n.children || []).every(isSubtreeDone);
  };

  const active = tree.filter(n => !isSubtreeDone(n));
  const completed = tree.filter(n => isSubtreeDone(n));

  let md = '# Order Paper\n\n';
  active.forEach(n => { md += renderNode(n, ''); });
  if (completed.length > 0) {
    md += '\n## Completed\n\n';
    completed.forEach(n => { md += renderNode(n, ''); });
  }
  return md.trimEnd() + '\n';
}

function handleExportClick(event) {
  const md = exportTodosAsMarkdown();
  if (event.shiftKey) {
    const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `order-paper-${new Date().toISOString().slice(0, 10)}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showEggToast('Downloaded order-paper.md');
  } else {
    navigator.clipboard.writeText(md).then(() => {
      showEggToast('Copied to clipboard');
    }).catch(() => {
      const ta = document.createElement('textarea');
      ta.value = md;
      ta.style.cssText = 'position:fixed;opacity:0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showEggToast('Copied to clipboard');
    });
  }
}

	function getTodoTree(todos) {
	  const byId = new Map();
	  todos.forEach(t => {
	    if (t && typeof t === 'object' && typeof t.id === 'number') byId.set(t.id, t);
	  });
	  const childrenByParent = new Map();

	  todos.forEach(t => {
	    if (!t || typeof t !== 'object') return;
	    const rawParent = t.parentId;
	    const parentId = rawParent === null || !byId.has(rawParent) ? null : rawParent;
	    if (!childrenByParent.has(parentId)) childrenByParent.set(parentId, []);
	    childrenByParent.get(parentId).push(t);
	  });

	  childrenByParent.forEach(list => list.sort((a, b) => a.order - b.order));

	  const buildNode = (item) => {
	    const kids = childrenByParent.get(item.id) || [];
	    return { ...item, children: kids.map(buildNode) };
	  };

	  return (childrenByParent.get(null) || []).map(buildNode);
	}


		function renderTodoRow(item, depth, hasChildren, filterQuery) {
		  const doneClass = item.done ? ' done' : '';
		  const lvl = Number.isFinite(depth) ? depth : 0;
		  const subClass = lvl > 0 ? ' subtask' : '';
		  const safePriority = PRIORITY_CYCLE.includes(item.priority) ? item.priority : 'none';
		  const safeTodoId = Number.isFinite(Number(item.id)) ? String(Number(item.id)) : '';
		  const safeParentId = Number.isFinite(Number(item.parentId)) ? String(Number(item.parentId)) : '';
		  const subtaskBtn = `<button class="todo-act-btn todo-add-sub" title="Add subtask">+</button>`;
		  const collapseBtn = hasChildren
		    ? `<button class="todo-act-btn todo-collapse" title="${item.collapsed ? 'Expand' : 'Collapse'}">${item.collapsed ? '\u25B8' : '\u25BE'}</button>`
		    : `<span class="todo-collapse-spacer" aria-hidden="true">▾</span>`;
		  const textHtml = filterQuery ? highlightMatch(item.text, filterQuery) : escapeHtml(item.text);

			  return `<div class="todo-row${doneClass}${subClass}" data-todo-id="${escapeHtml(safeTodoId)}" data-parent-id="${escapeHtml(safeParentId)}" data-level="${lvl}" data-pri="${escapeHtml(safePriority)}" style="--todo-depth:${lvl};" draggable="true">
			    <span class="todo-drag" title="Drag to reorder">\u2261</span>
			    ${collapseBtn}
			    <input type="checkbox" class="todo-check" ${item.done ? 'checked' : ''}>
			    <button class="todo-priority" data-pri="${escapeHtml(safePriority)}" title="Priority: ${escapeHtml(safePriority)}"></button>
		    <span class="todo-text">${textHtml}</span>
	    <button class="todo-notes-toggle${item.notes ? ' has-notes' : ''}" title="${item.notes ? 'Edit notes' : 'Add notes'}">&#9998;</button>
	    <span class="todo-actions">
	      ${subtaskBtn}
	      <button class="todo-act-btn todo-del" title="Delete">\u00D7</button>
	    </span>
	  </div>`;
	}

	function renderTodoPanel() {
	  if (!DOM.todoPanelList || !DOM.todoPanelCount) return;
	  const todos = loadTodos();
	  let tree = getTodoTree(todos);
	  const pending = todos.filter(t => !t.done).length;
	  DOM.todoPanelCount.textContent = pending > 0 ? pending : '';
	  DOM.todoPanelCount.style.display = pending > 0 ? '' : 'none';

	  // Apply filter if active
	  const fq = todoFilterText.trim();
	  if (fq) tree = filterTodoTree(tree, fq);

	  const isSubtreeDone = (node) => {
	    if (!node || typeof node !== 'object') return false;
	    if (!node.done) return false;
	    const kids = Array.isArray(node.children) ? node.children : [];
	    return kids.every(isSubtreeDone);
	  };

	  // Split into active and completed (entire root subtree done)
	  const active = [];
	  const completed = [];
	  (tree || []).forEach(group => ((isSubtreeDone(group) ? completed : active).push(group)));

	  const renderBranch = (node, depth) => {
	    const kids = Array.isArray(node.children) ? node.children : [];
	    const hasChildren = kids.length > 0;
	    html += renderTodoRow(node, depth, hasChildren, fq);
	    if (hasChildren && !node.collapsed) {
	      kids.forEach(child => renderBranch(child, depth + 1));
	    }
	  };

	  let html = '';
	  if (active.length === 0 && completed.length === 0) {
	    if (fq) {
	      html = `<div class="todo-empty"><span class="todo-empty-icon">&#128270;</span>No matches found.</div>`;
	    } else {
	      html = `<div class="todo-empty"><span class="todo-empty-icon">\uD83D\uDCCB</span>No items yet.<br>Type above to add one.</div>`;
	    }
	  } else {
	    active.forEach(item => renderBranch(item, 0));
	  }

	  if (completed.length > 0) {
	    html += `<details class="todo-bin" id="todoBin">
	      <summary class="todo-bin-header">Completed <span class="todo-bin-count">${completed.length}</span></summary>
	      <div class="todo-bin-list">`;
	    completed.forEach(item => renderBranch(item, 0));
	    html += `<button class="todo-clear-done" id="todoClearDone">Clear all completed</button>`;
	    html += `</div></details>`;
	  }

	  DOM.todoPanelList.innerHTML = html;
	}

	function addTodo(text, parentId) {
	  const todos = loadTodos();
	  const pid = (parentId === null || parentId === undefined || parentId === '') ? null : Number(parentId);
	  const safePid = Number.isFinite(pid) ? pid : null;
	  const siblings = todos.filter(t => t.parentId === safePid);
	  const maxOrder = siblings.length > 0 ? Math.max(...siblings.map(s => s.order)) + 1 : 0;
	  if (safePid !== null) {
	    let parent = todos.find(t => t.id === safePid) || null;
	    while (parent) {
	      parent.collapsed = false;
	      parent.done = false;
	      if (parent.parentId === null) break;
	      parent = todos.find(t => t.id === parent.parentId) || null;
	    }
	  }
	  todos.push({
	    id: Date.now() + Math.floor(Math.random() * 1000),
	    text,
	    done: false,
	    priority: 'none',
	    due: null,
	    parentId: safePid,
	    order: maxOrder,
	    collapsed: false,
	    notes: ''
	  });
	  saveTodos(todos);
	  renderTodoPanel();
	}

	function toggleTodoDone(id) {
	  const todos = loadTodos();
	  const item = todos.find(t => t.id === id);
	  if (!item) return;
	  item.done = !item.done;
	  // Also toggle all descendants
	  const byParent = new Map();
	  todos.forEach(t => {
	    const pid = t.parentId === null ? null : t.parentId;
	    if (!byParent.has(pid)) byParent.set(pid, []);
	    byParent.get(pid).push(t);
	  });
	  const stack = [id];
	  while (stack.length) {
	    const parentId = stack.pop();
	    const kids = byParent.get(parentId) || [];
	    kids.forEach(child => {
	      child.done = item.done;
	      stack.push(child.id);
	    });
	  }
	  saveTodos(todos);
	  renderTodoPanel();
	}

	function deleteTodo(id) {
	  let todos = loadTodos();
	  const byParent = new Map();
	  todos.forEach(t => {
	    const pid = t.parentId === null ? null : t.parentId;
	    if (!byParent.has(pid)) byParent.set(pid, []);
	    byParent.get(pid).push(t);
	  });
	  const toDelete = new Set([id]);
	  const stack = [id];
	  while (stack.length) {
	    const parentId = stack.pop();
	    const kids = byParent.get(parentId) || [];
	    kids.forEach(child => {
	      if (!toDelete.has(child.id)) {
	        toDelete.add(child.id);
	        stack.push(child.id);
	      }
	    });
	  }
	  const deleted = todos.filter(t => toDelete.has(t.id));
	  todos = todos.filter(t => !toDelete.has(t.id));
	  // Stash for undo
	  clearTodoUndo();
	  todoUndoStack = {
	    items: deleted,
	    timer: setTimeout(() => clearTodoUndo(), 5000)
	  };
	  saveTodos(todos);
	  renderTodoPanel();
	  showUndoToast(deleted.length);
	}

function cyclePriority(id) {
  const todos = loadTodos();
  const item = todos.find(t => t.id === id);
  if (!item) return;
  const idx = PRIORITY_CYCLE.indexOf(item.priority);
  item.priority = PRIORITY_CYCLE[(idx + 1) % PRIORITY_CYCLE.length];
  saveTodos(todos);
  renderTodoPanel();
}

function reorderTodo(draggedId, targetId, position) {
  const todos = loadTodos();
  const dragged = todos.find(t => t.id === draggedId);
  const target = todos.find(t => t.id === targetId);
  if (!dragged || !target) return;

  // Only allow reordering within the same level (same parentId)
  if (dragged.parentId !== target.parentId) return;

  const siblings = todos.filter(t => t.parentId === dragged.parentId).sort((a, b) => a.order - b.order);
  const filtered = siblings.filter(t => t.id !== draggedId);
  const targetIdx = filtered.findIndex(t => t.id === targetId);
  const insertIdx = position === 'after' ? targetIdx + 1 : targetIdx;
  filtered.splice(insertIdx, 0, dragged);

  filtered.forEach((t, i) => {
    const orig = todos.find(o => o.id === t.id);
    if (orig) orig.order = i;
  });

  saveTodos(todos);
  renderTodoPanel();
}

function toggleTodoCollapsed(id) {
  const todos = loadTodos();
  const item = todos.find(t => t.id === id);
  if (!item) return;
  item.collapsed = !item.collapsed;
  saveTodos(todos);
  renderTodoPanel();
}

	function clearCompletedTodos() {
	  const todos = loadTodos();
	  const tree = getTodoTree(todos);
	  const isSubtreeDone = (node) => {
	    if (!node || typeof node !== 'object') return false;
	    if (!node.done) return false;
	    const kids = Array.isArray(node.children) ? node.children : [];
	    return kids.every(isSubtreeDone);
	  };

	  const toDelete = new Set();
	  const collectIds = (node) => {
	    if (!node || typeof node !== 'object') return;
	    toDelete.add(node.id);
	    (node.children || []).forEach(collectIds);
	  };

	  (tree || []).forEach(root => {
	    if (isSubtreeDone(root)) collectIds(root);
	  });

	  const deleted = todos.filter(t => toDelete.has(t.id));
	  const remaining = todos.filter(t => !toDelete.has(t.id));
	  // Stash for undo
	  if (deleted.length > 0) {
	    clearTodoUndo();
	    todoUndoStack = {
	      items: deleted,
	      timer: setTimeout(() => clearTodoUndo(), 5000)
	    };
	  }
	  saveTodos(remaining);
	  renderTodoPanel();
	  if (deleted.length > 0) showUndoToast(deleted.length);
	}

function _isWideTodoPanel() {
  return window.innerWidth >= 1200;
}

function _isTodoPanelOpen() {
  if (!DOM.todoPanel) return false;
  return _isWideTodoPanel()
    ? !DOM.todoPanel.classList.contains('collapsed')
    : DOM.todoPanel.classList.contains('open');
}

function setTodoPanelOpen(open, options = {}) {
  if (!DOM.todoPanel) return;
  const shouldOpen = Boolean(open);
  const persist = options.persist !== false;

  const mainEl = document.querySelector('.main');
  if (_isWideTodoPanel()) {
    // Wide layout uses "collapsed" for the slide-out panel.
    DOM.todoPanel.classList.remove('open');
    DOM.todoPanel.classList.toggle('collapsed', !shouldOpen);
    if (mainEl) mainEl.style.marginRight = shouldOpen ? '' : '0';
  } else {
    // Narrow layout uses "open" for the drawer.
    DOM.todoPanel.classList.remove('collapsed');
    DOM.todoPanel.classList.toggle('open', shouldOpen);
    if (mainEl) mainEl.style.marginRight = '';
  }

  if (persist) {
    try {
      localStorage.setItem(TODO_PANEL_OPEN_KEY, shouldOpen ? 'true' : 'false');
    } catch (_error) {
      // Ignore storage failures.
    }
  }
}

function toggleTodoPanel() {
  setTodoPanelOpen(!_isTodoPanelOpen());
}

const TODO_THEMES = ['none', 'commons-theme', 'labour-theme'];
const TODO_THEME_KEY = 'cw-digest-todo-theme';

function cycleTodoTheme() {
  if (!DOM.todoPanel) return;
  let current = 'none';
  for (const t of TODO_THEMES) {
    if (t !== 'none' && DOM.todoPanel.classList.contains(t)) { current = t; break; }
  }
  const idx = TODO_THEMES.indexOf(current);
  const next = TODO_THEMES[(idx + 1) % TODO_THEMES.length];
  TODO_THEMES.forEach(t => { if (t !== 'none') DOM.todoPanel.classList.remove(t); });
  if (next !== 'none') DOM.todoPanel.classList.add(next);
  try { localStorage.setItem(TODO_THEME_KEY, next); } catch (_) {}
}

function _initTodoTheme() {
  if (!DOM.todoPanel) return;
  try {
    const saved = localStorage.getItem(TODO_THEME_KEY);
    // Migrate old key
    if (!saved && localStorage.getItem('cw-digest-commons-theme') === 'true') {
      DOM.todoPanel.classList.add('commons-theme');
      localStorage.setItem(TODO_THEME_KEY, 'commons-theme');
      localStorage.removeItem('cw-digest-commons-theme');
      return;
    }
    if (saved && saved !== 'none') {
      DOM.todoPanel.classList.add(saved);
    }
  } catch (_) {}
}

function bindTodoPanelEvents() {
  if (!DOM.todoPanelInput || !DOM.todoPanelList) return;

  // Add item
  DOM.todoPanelInput.addEventListener('keydown', event => {
    event.stopPropagation();
    if (event.key === 'Enter') {
      const text = DOM.todoPanelInput.value.trim();
      if (!text) return;
      addTodo(text, null);
      DOM.todoPanelInput.value = '';
    }
  });

  // Delegated events on the list
  DOM.todoPanelList.addEventListener('change', event => {
    const row = event.target.closest('.todo-row');
    if (!row) return;
    const id = Number(row.dataset.todoId);

    if (event.target.classList.contains('todo-check')) {
      toggleTodoDone(id);
    }
  });

  DOM.todoPanelList.addEventListener('click', event => {
    // Handle buttons outside .todo-row first
    if (event.target.classList.contains('todo-clear-done')) {
      clearCompletedTodos();
      return;
    }

    const row = event.target.closest('.todo-row');
    if (!row) return;
    const id = Number(row.dataset.todoId);

    if (event.target.classList.contains('todo-notes-toggle')) {
      openTodoNotes(id);
      return;
    }
    if (event.target.classList.contains('todo-priority')) {
      cyclePriority(id);
      return;
    }
    if (event.target.classList.contains('todo-collapse')) {
      toggleTodoCollapsed(id);
      return;
    }
    if (event.target.classList.contains('todo-del')) {
      deleteTodo(id);
      return;
    }
	    if (event.target.classList.contains('todo-add-sub')) {
	      // Prompt for subtask inline
	      const existing = DOM.todoPanelList.querySelector('.todo-sub-input-row');
	      if (existing) existing.remove();
	      const parentLevel = Number(row.dataset.level || '0') || 0;
	      const childLevel = parentLevel + 1;
	      const inputRow = document.createElement('div');
	      inputRow.className = 'todo-row subtask todo-sub-input-row';
	      inputRow.setAttribute('data-level', String(childLevel));
	      inputRow.style.setProperty('--todo-depth', String(childLevel));
	      inputRow.setAttribute('draggable', 'false');
	      inputRow.innerHTML = `<input type="text" class="todo-sub-input" placeholder="Add subtask..." maxlength="200">`;

	      // Insert after parent row and all of its descendants.
	      let insertAfter = row;
	      let next = row.nextElementSibling;
	      while (next && next.classList.contains('todo-row')) {
	        if (next.classList.contains('todo-sub-input-row')) break;
	        const nextLevel = Number(next.dataset.level || '0') || 0;
	        if (nextLevel <= parentLevel) break;
	        insertAfter = next;
	        next = next.nextElementSibling;
	      }
	      insertAfter.after(inputRow);
	      const subInput = inputRow.querySelector('.todo-sub-input');
	      subInput.focus();
	      subInput.addEventListener('keydown', e => {
	        e.stopPropagation();
	        if (e.key === 'Enter') {
	          const text = subInput.value.trim();
	          if (text) addTodo(text, id);
	          inputRow.remove();
	        }
	        if (e.key === 'Escape') { inputRow.remove(); }
	      });
	      subInput.addEventListener('blur', () => {
	        setTimeout(() => inputRow.remove(), 150);
	      });
	      return;
	    }
  });

  // Double-click to edit
  DOM.todoPanelList.addEventListener('dblclick', event => {
    const textEl = event.target.closest('.todo-text');
    if (!textEl) return;
    const row = textEl.closest('.todo-row');
    if (!row) return;
    const id = Number(row.dataset.todoId);
    if (Number.isFinite(id)) startTodoEdit(id);
  });

  // Drag and drop
	  DOM.todoPanelList.addEventListener('dragstart', event => {
	    const row = event.target.closest('.todo-row');
	    if (!row) return;
	    if (row.classList.contains('todo-sub-input-row')) return;
	    const id = Number(row.dataset.todoId);
	    if (!Number.isFinite(id)) return;
	    todoDragId = id;
	    todoDragParentId = row.dataset.parentId || '';
	    row.classList.add('dragging');
	    event.dataTransfer.effectAllowed = 'move';
	    event.dataTransfer.setData('text/plain', String(todoDragId));
	  });

  DOM.todoPanelList.addEventListener('dragover', event => {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
	    DOM.todoPanelList.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
	    const row = event.target.closest('.todo-row');
	    if (row && !row.classList.contains('todo-sub-input-row') && Number(row.dataset.todoId) !== todoDragId) {
	      // Only highlight valid targets (same parent level)
	      const targetParent = row.dataset.parentId || '';
	      if (targetParent === todoDragParentId) {
	        row.classList.add('drag-over');
	      }
	    }
	  });

	  DOM.todoPanelList.addEventListener('dragleave', event => {
	    const row = event.target.closest('.todo-row');
	    if (row) row.classList.remove('drag-over');
	  });

  DOM.todoPanelList.addEventListener('drop', event => {
    event.preventDefault();
    DOM.todoPanelList.querySelectorAll('.drag-over, .dragging').forEach(el => {
      el.classList.remove('drag-over', 'dragging');
    });
	    const row = event.target.closest('.todo-row');
	    if (!row || todoDragId === null) return;
	    if (row.classList.contains('todo-sub-input-row')) return;
	    const targetId = Number(row.dataset.todoId);
	    if (targetId === todoDragId) return;
	    reorderTodo(todoDragId, targetId, 'after');
	    todoDragId = null;
	    todoDragParentId = '';
	  });

  DOM.todoPanelList.addEventListener('dragend', () => {
    DOM.todoPanelList.querySelectorAll('.drag-over, .dragging').forEach(el => {
      el.classList.remove('drag-over', 'dragging');
    });
    todoDragId = null;
    todoDragParentId = '';
  });

  // Collapse button
  if (DOM.todoPanelCollapse) {
    DOM.todoPanelCollapse.addEventListener('click', toggleTodoPanel);
  }

  // Export button
  const exportBtn = document.getElementById('todoExportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', handleExportClick);
  }

  // Theme cycle toggle
  const themeBtn = document.getElementById('todoPanelThemeBtn');
  if (themeBtn) {
    themeBtn.addEventListener('click', cycleTodoTheme);
  }

  // Search / filter toggle
  const searchBtn = document.getElementById('todoSearchBtn');
  if (searchBtn) {
    searchBtn.addEventListener('click', toggleTodoSearch);
  }

  // Toggle tab
  if (DOM.todoToggleTab) {
    DOM.todoToggleTab.addEventListener('click', toggleTodoPanel);
  }
}

function init() {
  // Load persisted QoL state.
  STATE.viewMode = normalizeViewMode(STATE.viewMode);

  const readMapLoaded = loadJson(STORAGE_KEYS.readMap, {});
  STATE.readMap = (readMapLoaded && typeof readMapLoaded === 'object' && !Array.isArray(readMapLoaded)) ? readMapLoaded : {};

  const savedMapLoaded = loadJson(STORAGE_KEYS.savedMap, {});
  STATE.savedMap = (savedMapLoaded && typeof savedMapLoaded === 'object' && !Array.isArray(savedMapLoaded)) ? savedMapLoaded : {};

  const mutedSendersLoaded = loadJson(STORAGE_KEYS.mutedSenders, []);
  STATE.mutedSenders = new Set(Array.isArray(mutedSendersLoaded) ? mutedSendersLoaded : []);

  const mutedSourcesLoaded = loadJson(STORAGE_KEYS.mutedSources, []);
  STATE.mutedSources = new Set(Array.isArray(mutedSourcesLoaded) ? mutedSourcesLoaded : []);

  const lastRefreshRaw = localStorage.getItem(STORAGE_KEYS.lastRefreshAt) || '0';
  STATE.lastRefreshAt = Number(lastRefreshRaw) || 0;

  STATE.sortMode = normalizeSortMode(STATE.sortMode);
  syncWeekCaches();
  renderTabs();
  if (!localStorage.getItem(STORAGE_KEYS.uiDensity)) {
    localStorage.setItem(STORAGE_KEYS.uiDensity, 'reserved');
  }

	  updateSortUi();
	  setViewMode(STATE.viewMode, { persist: false });
	  setSearchVisibility(STATE.searchVisible, { persist: false });
	  applyTheme(STATE.theme);
	  document.body.classList.toggle('pollster-mode', STATE.pollsterMode);
	  renderArchiveOptions();
	  initFaceWidget();
	  bindEvents();
	  updateRefreshMeta();
	  updateSearchToggleMeta();
	  void probeServerHealth();
	  void loadArchiveWeeks();

	  const urlState = readUrlState();
	  // On fresh page load, ignore stale week/day params — always start on current week
	  urlState.week = null;
	  urlState.day = null;
	  applyUrlState(urlState, { autoExpandPanel: true });
	  updateReadingProgress();
	  renderDailyQuote();
	  setInterval(renderDailyQuote, 1800000);
  divisionBellLastHour = new Date().getHours();
  setInterval(checkDivisionBell, 30000);
  resetIdleTimer();
  fetchWeather();
  setInterval(fetchWeather, 1800000);
  renderQuickLinks();
  bindQuickLinkEvents();
  renderTodoPanel();
  bindTodoPanelEvents();
  _initTodoTheme();

  // Order Paper: collapsed by default (persisted if user opens it).
  const todoPanelOpenPref = (localStorage.getItem(TODO_PANEL_OPEN_KEY) || 'false') === 'true';
  setTodoPanelOpen(todoPanelOpenPref, { persist: false });

  // Clear pre-init classes so they don't interfere with later toggles.
  document.documentElement.classList.remove('todo-panel-init-open', 'todo-panel-init-closed');
}

init();
</script>
</body>
</html>
